//Copyright Â© 2011-2018 Capital Intellect Inc. All Rights Reserved 
//Patents Pending 
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(c){var a=0;return function(){return a<c.length?{done:!1,value:c[a++]}:{done:!0}}};$jscomp.arrayIterator=function(c){return{next:$jscomp.arrayIteratorImpl(c)}};$jscomp.makeIterator=function(c){var a="undefined"!=typeof Symbol&&Symbol.iterator&&c[Symbol.iterator];return a?a.call(c):$jscomp.arrayIterator(c)};$jscomp.arrayFromIterator=function(c){for(var a,b=[];!(a=c.next()).done;)b.push(a.value);return b};
$jscomp.arrayFromIterable=function(c){return c instanceof Array?c:$jscomp.arrayFromIterator($jscomp.makeIterator(c))};$jscomp.getGlobal=function(c){return"undefined"!=typeof window&&window===c?c:"undefined"!=typeof global&&null!=global?global:c};$jscomp.global=$jscomp.getGlobal(this);$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,a,b){c!=Array.prototype&&c!=Object.prototype&&(c[a]=b.value)};$jscomp.polyfill=function(c,a,b,e){if(a){b=$jscomp.global;c=c.split(".");for(e=0;e<c.length-1;e++){var g=c[e];g in b||(b[g]={});b=b[g]}c=c[c.length-1];e=b[c];a=a(e);a!=e&&null!=a&&$jscomp.defineProperty(b,c,{configurable:!0,writable:!0,value:a})}};$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(c){function a(){this.batch_=null}function b(a){return a instanceof g?a:new g(function(b,f){b(a)})}if(c&&!$jscomp.FORCE_POLYFILL_PROMISE)return c;a.prototype.asyncExecute=function(a){if(null==this.batch_){this.batch_=[];var b=this;this.asyncExecuteFunction(function(){b.executeBatch_()})}this.batch_.push(a)};var e=$jscomp.global.setTimeout;a.prototype.asyncExecuteFunction=function(a){e(a,0)};a.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var a=
this.batch_;this.batch_=[];for(var b=0;b<a.length;++b){var d=a[b];a[b]=null;try{d()}catch(n){this.asyncThrow_(n)}}}this.batch_=null};a.prototype.asyncThrow_=function(a){this.asyncExecuteFunction(function(){throw a;})};var g=function(a){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var b=this.createResolveAndReject_();try{a(b.resolve,b.reject)}catch(m){b.reject(m)}};g.prototype.createResolveAndReject_=function(){function a(a){return function(f){d||(d=!0,a.call(b,f))}}var b=this,d=!1;
return{resolve:a(this.resolveTo_),reject:a(this.reject_)}};g.prototype.resolveTo_=function(a){if(a===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(a instanceof g)this.settleSameAsPromise_(a);else{a:switch(typeof a){case "object":var b=null!=a;break a;case "function":b=!0;break a;default:b=!1}b?this.resolveToNonPromiseObj_(a):this.fulfill_(a)}};g.prototype.resolveToNonPromiseObj_=function(a){var b=void 0;try{b=a.then}catch(m){this.reject_(m);return}"function"==typeof b?
this.settleSameAsThenable_(b,a):this.fulfill_(a)};g.prototype.reject_=function(a){this.settle_(2,a)};g.prototype.fulfill_=function(a){this.settle_(1,a)};g.prototype.settle_=function(a,b){if(0!=this.state_)throw Error("Cannot settle("+a+", "+b+"): Promise already settled in state"+this.state_);this.state_=a;this.result_=b;this.executeOnSettledCallbacks_()};g.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var a=0;a<this.onSettledCallbacks_.length;++a)d.asyncExecute(this.onSettledCallbacks_[a]);
this.onSettledCallbacks_=null}};var d=new a;g.prototype.settleSameAsPromise_=function(a){var b=this.createResolveAndReject_();a.callWhenSettled_(b.resolve,b.reject)};g.prototype.settleSameAsThenable_=function(a,b){var d=this.createResolveAndReject_();try{a.call(b,d.resolve,d.reject)}catch(n){d.reject(n)}};g.prototype.then=function(a,b){function d(a,b){return"function"==typeof a?function(b){try{f(a(b))}catch(y){e(y)}}:b}var f,e,c=new g(function(a,b){f=a;e=b});this.callWhenSettled_(d(a,f),d(b,e));return c};
g.prototype.catch=function(a){return this.then(void 0,a)};g.prototype.callWhenSettled_=function(a,b){function f(){switch(e.state_){case 1:a(e.result_);break;case 2:b(e.result_);break;default:throw Error("Unexpected state: "+e.state_);}}var e=this;null==this.onSettledCallbacks_?d.asyncExecute(f):this.onSettledCallbacks_.push(f)};g.resolve=b;g.reject=function(a){return new g(function(b,d){d(a)})};g.race=function(a){return new g(function(d,e){for(var f=$jscomp.makeIterator(a),c=f.next();!c.done;c=f.next())b(c.value).callWhenSettled_(d,
e)})};g.all=function(a){var d=$jscomp.makeIterator(a),e=d.next();return e.done?b([]):new g(function(a,f){function c(b){return function(d){g[b]=d;m--;0==m&&a(g)}}var g=[],m=0;do g.push(void 0),m++,b(e.value).callWhenSettled_(c(g.length-1),f),e=d.next();while(!e.done)})};return g},"es6","es3");
$jscomp.checkStringArgs=function(c,a,b){if(null==c)throw new TypeError("The 'this' value for String.prototype."+b+" must not be null or undefined");if(a instanceof RegExp)throw new TypeError("First argument to String.prototype."+b+" must not be a regular expression");return c+""};
$jscomp.polyfill("String.prototype.startsWith",function(c){return c?c:function(a,b){var e=$jscomp.checkStringArgs(this,a,"startsWith");a+="";var c=e.length,d=a.length;b=Math.max(0,Math.min(b|0,e.length));for(var f=0;f<d&&b<c;)if(e[b++]!=a[f++])return!1;return f>=d}},"es6","es3");$jscomp.polyfill("Number.isNaN",function(c){return c?c:function(a){return"number"===typeof a&&isNaN(a)}},"es6","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(c,a){this.$jscomp$symbol$id_=c;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:a})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function c(b){if(this instanceof c)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(b||"")+"_"+a++,b)}var a=0;return c}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var c=$jscomp.global.Symbol.iterator;c||(c=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[c]&&$jscomp.defineProperty(Array.prototype,c,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var c=$jscomp.global.Symbol.asyncIterator;c||(c=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(c){$jscomp.initSymbolIterator();c={next:c};c[$jscomp.global.Symbol.iterator]=function(){return this};return c};
$jscomp.iteratorFromArray=function(c,a){$jscomp.initSymbolIterator();c instanceof String&&(c+="");var b=0,e={next:function(){if(b<c.length){var g=b++;return{value:a(g,c[g]),done:!1}}e.next=function(){return{done:!0,value:void 0}};return e.next()}};e[Symbol.iterator]=function(){return e};return e};$jscomp.polyfill("Array.prototype.keys",function(c){return c?c:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
$jscomp.checkEs6ConformanceViaProxy=function(){try{var c={},a=Object.create(new $jscomp.global.Proxy(c,{get:function(b,e,g){return b==c&&"q"==e&&g==a}}));return!0===a.q}catch(b){return!1}};$jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS=!1;$jscomp.ES6_CONFORMANCE=$jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS&&$jscomp.checkEs6ConformanceViaProxy();$jscomp.owns=function(c,a){return Object.prototype.hasOwnProperty.call(c,a)};
$jscomp.polyfill("WeakMap",function(c){function a(){if(!c||!Object.seal)return!1;try{var a=Object.seal({}),b=Object.seal({}),d=new c([[a,2],[b,3]]);if(2!=d.get(a)||3!=d.get(b))return!1;d.delete(a);d.set(b,4);return!d.has(a)&&4==d.get(b)}catch(v){return!1}}function b(){}function e(a){if(!$jscomp.owns(a,d)){var e=new b;$jscomp.defineProperty(a,d,{value:e})}}function g(a){var d=Object[a];d&&(Object[a]=function(a){if(a instanceof b)return a;e(a);return d(a)})}if($jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS){if(c&&
$jscomp.ES6_CONFORMANCE)return c}else if(a())return c;var d="$jscomp_hidden_"+Math.random();g("freeze");g("preventExtensions");g("seal");var f=0,h=function(a){this.id_=(f+=Math.random()+1).toString();if(a){a=$jscomp.makeIterator(a);for(var b;!(b=a.next()).done;)b=b.value,this.set(b[0],b[1])}};h.prototype.set=function(a,b){e(a);if(!$jscomp.owns(a,d))throw Error("WeakMap key fail: "+a);a[d][this.id_]=b;return this};h.prototype.get=function(a){return $jscomp.owns(a,d)?a[d][this.id_]:void 0};h.prototype.has=
function(a){return $jscomp.owns(a,d)&&$jscomp.owns(a[d],this.id_)};h.prototype.delete=function(a){return $jscomp.owns(a,d)&&$jscomp.owns(a[d],this.id_)?delete a[d][this.id_]:!1};return h},"es6","es3");$jscomp.MapEntry=function(){};
$jscomp.polyfill("Map",function(c){function a(){if($jscomp.ASSUME_NO_NATIVE_MAP||!c||"function"!=typeof c||!c.prototype.entries||"function"!=typeof Object.seal)return!1;try{var a=Object.seal({x:4}),b=new c($jscomp.makeIterator([[a,"s"]]));if("s"!=b.get(a)||1!=b.size||b.get({x:4})||b.set({x:4},"t")!=b||2!=b.size)return!1;var d=b.entries(),e=d.next();if(e.done||e.value[0]!=a||"s"!=e.value[1])return!1;e=d.next();return e.done||4!=e.value[0].x||"t"!=e.value[1]||!d.next().done?!1:!0}catch(t){return!1}}
if($jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS){if(c&&$jscomp.ES6_CONFORMANCE)return c}else if(a())return c;$jscomp.initSymbolIterator();var b=new WeakMap,e=function(a){this.data_={};this.head_=f();this.size=0;if(a){a=$jscomp.makeIterator(a);for(var b;!(b=a.next()).done;)b=b.value,this.set(b[0],b[1])}};e.prototype.set=function(a,b){a=0===a?0:a;var d=g(this,a);d.list||(d.list=this.data_[d.id]=[]);d.entry?d.entry.value=b:(d.entry={next:this.head_,previous:this.head_.previous,head:this.head_,key:a,
value:b},d.list.push(d.entry),this.head_.previous.next=d.entry,this.head_.previous=d.entry,this.size++);return this};e.prototype.delete=function(a){a=g(this,a);return a.entry&&a.list?(a.list.splice(a.index,1),a.list.length||delete this.data_[a.id],a.entry.previous.next=a.entry.next,a.entry.next.previous=a.entry.previous,a.entry.head=null,this.size--,!0):!1};e.prototype.clear=function(){this.data_={};this.head_=this.head_.previous=f();this.size=0};e.prototype.has=function(a){return!!g(this,a).entry};
e.prototype.get=function(a){return(a=g(this,a).entry)&&a.value};e.prototype.entries=function(){return d(this,function(a){return[a.key,a.value]})};e.prototype.keys=function(){return d(this,function(a){return a.key})};e.prototype.values=function(){return d(this,function(a){return a.value})};e.prototype.forEach=function(a,b){for(var d=this.entries(),e;!(e=d.next()).done;)e=e.value,a.call(b,e[1],e[0],this)};e.prototype[Symbol.iterator]=e.prototype.entries;var g=function(a,d){var e=d&&typeof d;"object"==
e||"function"==e?b.has(d)?e=b.get(d):(e=""+ ++h,b.set(d,e)):e="p_"+d;var f=a.data_[e];if(f&&$jscomp.owns(a.data_,e))for(a=0;a<f.length;a++){var c=f[a];if(d!==d&&c.key!==c.key||d===c.key)return{id:e,list:f,index:a,entry:c}}return{id:e,list:f,index:-1,entry:void 0}},d=function(a,b){var d=a.head_;return $jscomp.iteratorPrototype(function(){if(d){for(;d.head!=a.head_;)d=d.previous;for(;d.next!=d.head;)return d=d.next,{done:!1,value:b(d)};d=null}return{done:!0,value:void 0}})},f=function(){var a={};return a.previous=
a.next=a.head=a},h=0;return e},"es6","es3");$jscomp.polyfill("Object.is",function(c){return c?c:function(a,b){return a===b?0!==a||1/a===1/b:a!==a&&b!==b}},"es6","es3");$jscomp.polyfill("Array.prototype.includes",function(c){return c?c:function(a,b){var e=this;e instanceof String&&(e=String(e));var c=e.length;b=b||0;for(0>b&&(b=Math.max(b+c,0));b<c;b++){var d=e[b];if(d===a||Object.is(d,a))return!0}return!1}},"es7","es3");
$jscomp.polyfill("String.prototype.includes",function(c){return c?c:function(a,b){return-1!==$jscomp.checkStringArgs(this,a,"includes").indexOf(a,b||0)}},"es6","es3");
$jscomp.polyfill("Set",function(c){function a(){if($jscomp.ASSUME_NO_NATIVE_SET||!c||"function"!=typeof c||!c.prototype.entries||"function"!=typeof Object.seal)return!1;try{var a=Object.seal({x:4}),b=new c($jscomp.makeIterator([a]));if(!b.has(a)||1!=b.size||b.add(a)!=b||1!=b.size||b.add({x:4})!=b||2!=b.size)return!1;var d=b.entries(),f=d.next();if(f.done||f.value[0]!=a||f.value[1]!=a)return!1;f=d.next();return f.done||f.value[0]==a||4!=f.value[0].x||f.value[1]!=f.value[0]?!1:d.next().done}catch(h){return!1}}
if($jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS){if(c&&$jscomp.ES6_CONFORMANCE)return c}else if(a())return c;$jscomp.initSymbolIterator();var b=function(a){this.map_=new Map;if(a){a=$jscomp.makeIterator(a);for(var b;!(b=a.next()).done;)this.add(b.value)}this.size=this.map_.size};b.prototype.add=function(a){a=0===a?0:a;this.map_.set(a,a);this.size=this.map_.size;return this};b.prototype.delete=function(a){a=this.map_.delete(a);this.size=this.map_.size;return a};b.prototype.clear=function(){this.map_.clear();
this.size=0};b.prototype.has=function(a){return this.map_.has(a)};b.prototype.entries=function(){return this.map_.entries()};b.prototype.values=function(){return this.map_.values()};b.prototype.keys=b.prototype.values;b.prototype[Symbol.iterator]=b.prototype.values;b.prototype.forEach=function(a,b){var d=this;this.map_.forEach(function(e){return a.call(b,e,e,d)})};return b},"es6","es3");
$jscomp.assign="function"==typeof Object.assign?Object.assign:function(c,a){for(var b=1;b<arguments.length;b++){var e=arguments[b];if(e)for(var g in e)$jscomp.owns(e,g)&&(c[g]=e[g])}return c};$jscomp.polyfill("Object.assign",function(c){return c||$jscomp.assign},"es6","es3");$jscomp.polyfill("Array.prototype.entries",function(c){return c?c:function(){return $jscomp.iteratorFromArray(this,function(a,b){return[a,b]})}},"es6","es3");var BfrlTool=BfrlTool||{};
BfrlTool.StorageReader=function(c,a){return new Promise(function(b,e){var g=c+"_"+a;shoptoolbar._Browser!==shoptoolbar.Browsers.Firefox?localStorage[g]?b(BfrlTool.PreferenceList()[a].prefType.get(g)):b(BfrlTool.Prefs[a]):browser.storage.local.get().then(function(d){d&&"undefined"!=typeof d[g]?b(d[g]):d&&"undefined"!=typeof d[a]?b(d[a]):b(null)})})};
BfrlTool.BrowserStorage=function(){var c=function(a){return BfrlTool.StorageReader(BfrlTool.Prefs.UserName,a)},a=function(a,e){BfrlTool.Prefs[a]=e;BfrlTool.PreferenceList()[a].prefType.set(BfrlTool.Prefs.UserName+"_"+a,e);if(shoptoolbar._Browser===shoptoolbar.Browsers.Firefox){var b={};browser.storage.local.set((b[a]=e,b));b={};browser.storage.local.set((b[BfrlTool.Prefs.UserName+"_"+a]=e,b))}};return{get IsClassic(){return c("IsClassic")},set IsClassic(b){a("IsClassic",b)},get UserToken(){return c("UserToken")},
set UserToken(b){a("UserToken",b)},get UserName(){return c("UserName")},set UserName(b){a("UserName",b)},get AutomaticActivation(){return c("AutomaticActivation")},set AutomaticActivation(b){a("AutomaticActivation",b)},get TurnOffNotifications(){return c("TurnOffNotifications")},set TurnOffNotifications(b){a("TurnOffNotifications",b)},get TourShown(){return c("TourShown")},set TourShown(b){a("TourShown",b)},get EasyActivationShown(){return c("EasyActivationShown")},set EasyActivationShown(b){a("EasyActivationShown",
b)},get AllowCashbackInjection(){return c("AllowCashbackInjection")},set AllowCashbackInjection(b){a("AllowCashbackInjection",b)},get AllowSubmissions(){return c("AllowSubmissions")},set AllowSubmissions(b){a("AllowSubmissions",b)},get PrivacyPrompt(){return c("PrivacyPrompt")},set PrivacyPrompt(b){a("PrivacyPrompt",b)},get NoCashBackExtension(){return c("NoCashBackExtension")},set NoCashBackExtension(b){a("NoCashBackExtension",b)},get IsShopper(){return c("IsShopper")},set IsShopper(b){a("IsShopper",
b)},get BonusEligibility(){return c("BonusEligibility")},set BonusEligibility(b){a("BonusEligibility",b)},get InstallDate(){return c("InstallDate")},get NoMoreInvites(){return c("NoMoreInvites")},set NoMoreInvites(b){a("NoMoreInvites",b)},get PreviousInviteDenied(){return c("PreviousInviteDenied")},set PreviousInviteDenied(b){a("PreviousInviteDenied",b)},get InviteToRate(){return c("InviteToRate")},set InviteToRate(b){a("InviteToRate",b)},get SecondDenial(){return c("SecondDenial")},set SecondDenial(b){a("SecondDenial",
b)},get PreviousInviteDenialDate(){return c("PreviousInviteDenialDate")},set PreviousInviteDenialDate(b){a("PreviousInviteDenialDate",b)},get SecondInviteDenialDate(){return c("SecondInviteDenialDate")},set SecondInviteDenialDate(b){a("SecondInviteDenialDate",b)},get WebExtensionsRateUs(){return c("WebExtensionsRateUs")},set WebExtensionsRateUs(b){a("WebExtensionsRateUs",b)},get RateUsFlagCounter(){return c("RateUsFlagCounter")},set RateUsFlagCounter(b){a("RateUsFlagCounter",b)},set InstallDate(b){a("InstallDate",
b)},get ConflictAlert(){return c("ConflictAlert")},set ConflictAlert(b){a("ConflictAlert",b)}}}();
BfrlTool.PrefType={Char:{get:function(c){return localStorage[c]||""},set:function(c,a){localStorage[c]=a}},Bool:{get:function(c){return"true"===localStorage[c]},set:function(c,a){localStorage[c]=!!a}},Array:{get:function(c){return localStorage[c]?JSON.parse(localStorage[c]):[]},set:function(c,a){localStorage[c]=JSON.stringify(a)}},Int:{get:function(c){return parseInt(localStorage[c])||0},set:function(c,a){localStorage[c]=parseInt(a)}}};
BfrlTool.PreferenceList=function(){function c(a,e){var b={enumerable:!0,configurable:!0};b[a]=e;return b}var a=BfrlTool.PrefType;return{_DefineGetter:function(a,e,g){if(Object.defineProperty)return Object.defineProperty(a,e,c("get",g));if(Object.prototype.__defineGetter__)return a.__defineGetter__(e,g);throw Error();},_DefineSetter:function(a,e,g){if(Object.defineProperty)return Object.defineProperty(a,e,c("set",g));if(Object.prototype.__defineSetter__)return a.__defineSetter__(e,g);throw Error();
},ToolbarClicks:{prefName:"ToolbarClicks",prefType:a.Array},InviteToRate:{prefName:"InviteToRate",prefType:a.Bool},PreviousInviteDenied:{prefName:"PreviousInviteDenied",prefType:a.Bool},PreviousInviteDenialDate:{prefName:"PreviousInviteDenialDate",prefType:a.Char},SecondDenial:{prefName:"SecondDenial",prefType:a.Bool},SecondInviteDenialDate:{prefName:"SecondInviteDenialDate",prefType:a.Char},InstallDate:{prefName:"InstallDate",prefType:a.Char},NoMoreInvites:{prefName:"NoMoreInvites",prefType:a.Bool},
RestaurantCount:{prefName:"RestaurantCount",prefType:a.Char},GroceryCount:{prefName:"GroceryCount",prefType:a.Char},WeeklyAdCount:{prefName:"WeeklyAdCount",prefType:a.Char},UserToken:{prefName:"UserToken",prefType:a.Char},Guest:{prefName:"Guest",prefType:a.Bool},WebExtensionsRateUs:{prefName:"WebExtensionsRateUs",prefType:a.Bool},RateUsFlagCounter:{prefName:"RateUsFlagCounter",prefType:a.Int},UserName:{prefName:"UserName",prefType:a.Char},BlackList:{Query:{prefName:"Blacklist.Query",prefType:a.Char},
Canonical:{prefName:"Blacklist.Canonical",prefType:a.Char},Regex:{prefName:"Blacklist.Regex",prefType:a.Char},NetSeer:{prefName:"Blacklist.NetSeer",prefType:a.Char}},FailureMode:{Threshold:{prefName:"FailureMode.Threshold",prefType:a.Char},IntervalMS:{prefName:"FailureMode.IntervalMS",prefType:a.Char},DurationMS:{prefName:"FailureMode.DurationMS",prefType:a.Char},RedirectionCountLimit:{prefName:"FailureMode.RedirectionCountLimit",prefType:a.Char},RedirectionCountTimeout:{prefName:"FailureMode.RedirectionCountTimeoutMS",
prefType:a.Char}},TurnOffNotifications:{prefName:"TurnOffNotifications",prefType:a.Char},TourShown:{prefName:"TourShown",prefType:a.Char},EasyActivationShown:{prefName:"EasyActivationShown",prefType:a.Bool},AutomaticActivation:{prefName:"AutomaticActivation",prefType:a.Bool},AllowCashbackInjection:{prefName:"AllowCashbackInjection",prefType:a.Bool},AllowSubmissions:{prefName:"AllowSubmissions",prefType:a.Bool},PrivacyPrompt:{prefName:"PrivacyPrompt",prefType:a.Bool},NoCashBackExtension:{prefName:"NoCashBackExtension",
prefType:a.Bool},IsShopper:{prefName:"IsShopper",prefType:a.Bool},PopupPaneAnimationHistory:{prefName:"PopupPaneAnimationHistory",prefType:a.Char},ConflictAlert:{prefName:"ConflictAlert",prefType:a.Bool},PrivacyDeclinedDate:{prefName:"PrivacyDeclinedDate",prefType:a.Char},BonusEligibility:{prefName:"BonusEligibility",prefType:a.Int},IsClassic:{prefName:"IsClassic",prefType:a.Bool}}};
BfrlTool.Prefs=function(){var c=BfrlTool.PreferenceList(),a=function(a){var b=[];for(g in a)Object.prototype.hasOwnProperty.call(a,g)&&b.push(g);var g=function(b,d){b.prefName&&b.prefType&&(c._DefineGetter(a,d,function(){return b.prefType.get(b.prefName)}),c._DefineSetter(a,d,function(a){return b.prefType.set(b.prefName,a)}))};for(var d=0;d<b.length;++d)g(a[b[d]],b[d])};a(c);a(c.FailureMode);a(c.BlackList);return c}();
var browserAdapter=browserAdapter||function(){return{_GetRuntimeID:function(){return shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?chrome.runtime.id:browser.runtime.id},_TourExecute:function(c){shoptoolbar._WelcomeScreenId=c.id;browserAdapter._ExecuteScript(c.id,"js/instructionsInject.js",function(a){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);browserAdapter._SendTabMessage(c.id,{instruction:"Get internal"},function(a){a&&"Restaurant"===a.type?(shoptoolbar._Browser===
shoptoolbar.Browsers.Firefox?browser.tabs.setZoom(c.id,1):shoptoolbar._Browser===shoptoolbar.Browsers.Chrome&&chrome.tabs.setZoom(c.id,1,function(){}),shoptoolbar._GetInstallStoreInfo(a.internalName,function(b,g,d){shoptoolbar._TourRetailer.retailerId=g;shoptoolbar._TourRetailer.retailerName=b;shoptoolbar._TourRetailer.imageUrl=d;shoptoolbar._TourRetailer.pageType=a.type;browserAdapter._SendTabMessage(c.id,{instruction:"Step one",retailerName:b})})):a&&"Grocery"===a.type?(shoptoolbar._TourRetailer.retailerName=
a.internalName,shoptoolbar._TourRetailer.pageType=a.type,browserAdapter._SendTabMessage(c.id,{instruction:"Step one",retailerName:a.internalName,pageType:a.type})):a&&"WeeklyAd"===a.type?shoptoolbar._GetInstallStoreInfo(a.internalName,function(b,g,d){shoptoolbar._TourRetailer.retailerId=g;shoptoolbar._TourRetailer.retailerName=b;shoptoolbar._TourRetailer.imageUrl=d;shoptoolbar._TourRetailer.pageType=a.type;browserAdapter._SendTabMessage(c.id,{instruction:"Step one",retailerName:b,pageType:a.type})}):
(shoptoolbar._TourMode=!1,tabDataCollection._Get(c.id)._WelcomePage=!0,browserAdapter._ExecuteScript(c.id,"js/iframeInject.js",function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message)}))})})},_ShowWelcomePage:function(){shoptoolbar.firstOpenTab=!1;shoptoolbar._TourMode=!shoptoolbar._IsButton;BfrlTool.BrowserStorage.TourShown="shown";var c="";c=shoptoolbar._IsButton?"https://"+shoptoolbar.Site+"/addon/installationcomplete/":shoptoolbar._IsBF?"https://"+shoptoolbar.Site+
"/home/":"https://"+shoptoolbar.Site+"/couponviewer/";shoptoolbar._Browser===shoptoolbar.Browsers.Chrome?chrome.tabs.create({url:c}):shoptoolbar._Browser===shoptoolbar.Browsers.Edge?browser.tabs.query({currentWindow:!0},function(a){for(var b=0;b<a.length;b++)if(-1<a[b].url.indexOf("www.befrugal.com/lp/")){browser.tabs.update(a[b].id,{active:!0,url:c});return}browser.tabs.create({url:c})}):browser.tabs.query({currentWindow:!0}).then(function(a){for(var b=0;b<a.length;b++)if(/www.befrugal.com/i.test(a[b].url)||
/www.searchext.com/i.test(a[b].url)){browser.tabs.create({url:c});break}})},_AddMessageListener:function(c){shoptoolbar._Browser===shoptoolbar.Browsers.Chrome?chrome.runtime.onMessage.addListener(c):browser.runtime.onMessage.addListener(c)},_SendTabMessage:function(c,a,b){b||(b=function(a){});shoptoolbar._Browser===shoptoolbar.Browsers.Chrome?chrome.tabs.sendMessage(c,a,function(a){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);b(a)}):shoptoolbar._Browser===shoptoolbar.Browsers.Firefox?
browser.tabs.sendMessage(c,a).then(b):browser.tabs.sendMessage(c,a,b)},_AddTabsOnActivatedListener:function(c){shoptoolbar._Browser===shoptoolbar.Browsers.Chrome?chrome.tabs.onActivated.addListener(c):browser.tabs.onActivated.addListener(c)},_AddTabsOnUpdatedListener:function(c){shoptoolbar._Browser===shoptoolbar.Browsers.Chrome?chrome.tabs.onUpdated.addListener(c):browser.tabs.onUpdated.addListener(c)},_AddTabsOnClosedListener:function(c){shoptoolbar._Browser===shoptoolbar.Browsers.Chrome?chrome.tabs.onRemoved.addListener(c):
browser.tabs.onRemoved.addListener(c)},_AddWindowOnFocusedListener:function(c){shoptoolbar._Browser===shoptoolbar.Browsers.Chrome?chrome.windows.onFocusChanged.addListener(c):browser.windows.onFocusChanged.addListener(c)},_ExecuteScript:function(c,a,b){shoptoolbar._Browser===shoptoolbar.Browsers.Chrome?chrome.tabs.executeScript(c,{file:a},b):shoptoolbar._Browser===shoptoolbar.Browsers.Firefox?browser.tabs.executeScript(c,{file:a}).then(b).catch(function(a){console.debug("error: "+a);return 0}):browser.tabs.executeScript(c,
{file:a},b)},_ExecuteScriptCode:function(c,a,b){shoptoolbar._Browser===shoptoolbar.Browsers.Chrome?chrome.tabs.executeScript(c,{code:a},b):shoptoolbar._Browser===shoptoolbar.Browsers.Firefox?browser.tabs.executeScript(c,{code:a}).then(b).catch(function(a){console.debug("error: "+a);return 0}):browser.tabs.executeScript(c,{code:a},b)},_GetURL:function(c){c||(c="");return shoptoolbar._Browser===shoptoolbar.Browsers.Chrome?chrome.runtime.getURL(c):browser.runtime.getURL(c)},_InsertCSS:function(c,a,b){shoptoolbar._Browser===
shoptoolbar.Browsers.Chrome?chrome.tabs.insertCSS(c,a,b):shoptoolbar._Browser===shoptoolbar.Browsers.Firefox?browser.tabs.insertCSS(c,a).then(b).catch(function(a){console.debug("error: "+a)}):browser.tabs.insertCSS(c,a,b)},_SetIcon:function(c){shoptoolbar._Browser===shoptoolbar.Browsers.Chrome?chrome.browserAction.setIcon({path:c}):(shoptoolbar._Browser!==shoptoolbar.Browsers.Firefox&&-1<c.indexOf("..")&&(c=c.replace("../","")),browser.browserAction.setIcon({path:c}))},_SetBadgeText:function(c){shoptoolbar._Browser===
shoptoolbar.Browsers.Chrome?chrome.browserAction.setBadgeText({text:c}):browser.browserAction.setBadgeText({text:c})},_GetBadgetext:function(c){shoptoolbar._Browser===shoptoolbar.Browsers.Chrome?chrome.browserAction.getBadgeText({},c):browser.browserAction.getBadgeText({}).then(c)},_SetIconBackgroundColorEvent:function(){shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?chrome.browserAction.setBadgeBackgroundColor({color:"#2196f3"}):browser.browserAction.setBadgeBackgroundColor({color:"#2196f3"})},
_SetIconBackgroundColor:function(c){BfrlTool.BrowserStorage.NoCashBackExtension.then(function(a){a=c&&!a?"#12bc00":"#f75c36";shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?chrome.browserAction.setBadgeBackgroundColor({color:a}):browser.browserAction.setBadgeBackgroundColor({color:a})})},_AddInstalledListener:function(c){shoptoolbar._Browser!==shoptoolbar.Browsers.Edge?chrome.runtime.onInstalled.addListener(c):browser.runtime.onInstalled.addListener(c)},_SetUninstallURL:function(){var c="https://www.surveymonkey.com/r/78NXQF9";
shoptoolbar._IsBF||(c="https://www.surveymonkey.com/r/799BBS7");shoptoolbar._Browser!==shoptoolbar.Browsers.Edge?chrome.runtime.setUninstallURL(c):browser.runtime.setUninstallURL(c)},_InitTopSites:function(){if(shoptoolbar._Browser===shoptoolbar.Browsers.Firefox){browser.storage.local.get("TopVisited").then(function(a){if(a.TopVisited)var b=JSON.parse(a.TopVisited);browserAdapter._FillTopSites(function(a,c){b&&0!==b.length?browserAdapter._UpdateTopSites(b,a):browser.storage.local.set({TopVisited:JSON.stringify(a)}).then(function(){},
null)})},function(a){console.log(a)});var c;browser.runtime.onConnect.addListener(function(a){c=a;c.postMessage({greeting:"Connected"});c.onMessage.addListener(function(a){switch(a.greeting){case "newTabLoad":browser.storage.local.get("TopVisited").then(function(a){a.TopVisited&&(a=JSON.parse(a.TopVisited),c.postMessage({topVisited:a}))})}})})}},_FillTopSites:function(c,a){browser.topSites.get().then(function(b){c(b,a)})},_UpdateTopSites:function(c,a){for(var b=0;b<a.length;b++)for(var e=0;e<c.length;e++)c[e].title===
a[b].title&&c[e].url===a[b].url&&(a[b].screenshot=c[e].screenshot);browser.storage.local.set({TopVisited:JSON.stringify(a)}).then(function(){},null)},_UpdateScreenshot:function(c){if(shoptoolbar._Browser===shoptoolbar.Browsers.Firefox){var a=function(a,b){var d=document.createElement("canvas");d.width=a.width;d.height=a.height;var f=d.getContext("2d");f.drawImage(a,0,0);a=f.getImageData(0,0,d.width,d.height).data;d=0;f=null;for(var e=0;e<a.length;e+=4){var c=a.subarray(e,e+4);if(f)for(var g=0;4>g;++g)d+=
Math.abs(c[g]-f[g]);f=c;if(d>b)return!1}return!0},b=function(b,d,e,c){return new RSVP.Promise(function(f){browser.tabs.captureVisibleTab(c,{format:"png"},function(c){var g=function(f,c,h){return new RSVP.Promise(function(k){var p=new Image;p.onload=function(){if(a(p,1E4))k(null);else{var w=document.createElement("canvas"),m=p.width,n=p.height;if(m<f||n<c)k(null);else{var z=n/2.5>c;if(m/2.5>f&&z)g(m/2,n/2,h).then(function(a){g(b,d,a).then(k)});else{z=f/c;z>m/n?n=m/z:m=n*z;m>p.width&&(m=p.width);n>
p.height&&(n=p.height);m>f*e&&(n/=m/(f*e),m=f*e);w.width=f;w.height=c;z=(p.width-m)/2;var r=(p.height-n)/2;w.getContext("2d").drawImage(p,z,r,m,n,0,0,f,c);k(w.toDataURL())}}}};p.src=h})};return g(b,d,c).then(f)})})},e=function(a,d){for(var f=0;f<a.length;++f){var e=browserAdapter._GetDomainFromUrl(a[f].url);d=browserAdapter._GetDomainFromUrl(d);if(e===d&&!a[f].screenshot){b(150,100,999,c.windowId).then(function(b){b&&(a[f].screenshot=b,browser.storage.local.set({TopVisited:JSON.stringify(a)}))});
break}}},g=document.createElement("a");g.href=c.url;var d=g.hostname;browser.storage.local.get("TopVisited").then(function(a){var b=null;a.TopVisited&&(b=JSON.parse(a.TopVisited));b&&(void 0===b.length?browserAdapter._FillTopSites(e,d):e(b,d))})}},_GetDomainFromUrl:function(c){c=-1<c.indexOf("://")?c.split("/")[2]:c.split("/")[0];c=c.split(":")[0];c=c.split("?")[0];c.startsWith("www")&&(c=c.substring(4));return c},UpdateWindow:function(c,a,b){c&&(b||(b=function(a){}),shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?
chrome.windows.update(c,a,b):shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox?browser.windows.update(c,a).then(b):browser.windows.update(c,a,b))},CreateTab:function(c,a,b){var e=!0;b&&(e=!1);c={active:e,url:c};shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?chrome.tabs.create(c,a):shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox?browser.tabs.create(c).then(a):browser.tabs.create(c,a)},UpdateTab:function(c,a,b){a={active:!0,url:a};c||(c=null);b||(b=function(a){});shoptoolbar.GetBrowser()===
shoptoolbar.Browsers.Chrome?chrome.tabs.update(c,a,b):shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox?browser.tabs.update(c,a).then(b):browser.tabs.update(c,a,b)},GetTab:function(c,a){shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?chrome.tabs.get(c,a):shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox?browser.tabs.get(c).then(a):browser.tabs.get(c,a)},ActivateTab:function(c){shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?chrome.tabs.update(c,{active:!0}):browser.tabs.update(c,
{active:!0})},GetActiveTab:function(c,a){var b={active:!0};c?b.currentWindow=!0:b.windowType="normal";shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?chrome.tabs.query(b,function(b){b&&0<b.length?a(b[0]):a(null)}):shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Edge?browser.tabs.query(b,function(b){b&&0<b.length?a(b[0]):a(null)}):browser.tabs.query(b).then(function(b){b&&0<b.length?a(b[0]):a(null)})},GetAllTabs:function(c){shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?chrome.tabs.query({},
function(a){c(a)}):shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox?browser.tabs.query({}).then(function(a){c(a)}):browser.tabs.query({},function(a){c(a)})},CloseTab:function(c,a){a||(a=function(){});shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?chrome.tabs.remove(c,a):shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Edge?browser.tabs.remove(c,a):browser.tabs.remove(c).then(a)},CreateNewWindow:function(c,a){a||(a=function(){});shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?
chrome.windows.create(c,a):shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Edge?browser.windows.create(c,a):browser.windows.create(c).then(a)}}}(),cleanUrler=function(c){if(c&&0<c.length){var a=c.indexOf("#"),b=c.indexOf("?"),e="";if(0<=a){var g=c.substr(0,a);b>a&&(e=c.substr(e));c=g+e}return c.replace(/(^\w+:|^)\/\//,"")}return null},RoundPriceFromString=function(c){var a=parseFloat(c.replace(/[\$]/g,"")),b=parseInt(a.toFixed(0));if(Number.isNaN(a)||Number.isNaN(b)||1>a)return c;a=parseFloat((a-
b).toFixed(2));if(Number.isNaN(a))return c;.5<=a&&b++;return"$"+b.toString()};function longStringCompare(c,a){for(var b=-1,e=0;e<c.length;e++){var g=c[e].URL.split("?")[0];(new RegExp(g,"i")).test(a)&&(-1===b||c[b].URL.split("?")[0].length<g.length)&&(b=e)}return b}
var tabDataCollection=function(){return{_TabData:[],_AddHistoryEntry:function(c,a){tabDataCollection._Get(c).History.push({Url:a,Time:(new Date).getTime(),IsSuppressed:suppressionHistory._IsSuppressed(c,a)})},_Get:function(c){c=parseInt(c);var a=tabDataCollection._TabData.filter(function(a){return a.TabId===c});if(0===a.length)return a={_RedirectCashbackNewTab:!1,TabId:c,History:[],StartupTime:(new Date).getTime(),Active:!0},tabDataCollection._TabData.push(a),a;a[0].Active=!0;return a[0]},_OverwriteStartupDelay:function(c){if(c=
tabDataCollection._Get(c))c.OverwriteStartupDelay=!0},_TabStartupDelaySuppression:function(c){return(c=tabDataCollection._Get(c))&&!c.OverwriteStartupDelay&&c._AutoRedirecting&&(c=c.StartupTime,((new Date).getTime()-c)/1E3<localStorage.StartupAbeyanceSeconds)?!0:!1},_IsWellKnown:function(c){for(var a in tabDataCollection._TabData)if(c===tabDataCollection._TabData[a]._CurrentId&&tabDataCollection._TabData[a].Active)return!0;return!1},_Sweep:function(){var c=function(a){var b=parseInt(localStorage.SuppressLengthMS)||
15E3,c=(new Date).getTime(),g=c-b;b=c-432E5;c=function(a){for(;a&&0!==a.length&&a[0].Time<g;)a.splice(0,1)};for(var d={},f=0;f<tabDataCollection._TabData.length;d={$jscomp$loop$prop$testingTab$41:d.$jscomp$loop$prop$testingTab$41},++f)d.$jscomp$loop$prop$testingTab$41=tabDataCollection._TabData[f],d.$jscomp$loop$prop$testingTab$41?0<a.filter(function(a){return function(b){return b.id===a.$jscomp$loop$prop$testingTab$41.TabId}}(d)).length?(tabDataCollection._TabData[f].Active=!0,c(tabDataCollection._TabData[f].History),
d.$jscomp$loop$prop$testingTab$41._CashbackActivated&&d.$jscomp$loop$prop$testingTab$41._CashbackActivationChangedTime<b&&(tabDataCollection._TabData[f]._CashbackActivated=!1,tabDataCollection._TabData[f]._CashbackActivationChangedTime=(new Date).getTime())):d.$jscomp$loop$prop$testingTab$41.Active?(tabDataCollection._TabData[f].Active=!1,c(tabDataCollection._TabData[f].History),d.$jscomp$loop$prop$testingTab$41._CashbackActivated&&d.$jscomp$loop$prop$testingTab$41._CashbackActivationChangedTime<
b&&(tabDataCollection._TabData[f]._CashbackActivated=!1,tabDataCollection._TabData[f]._CashbackActivationChangedTime=(new Date).getTime())):tabDataCollection._TabData.splice(f,1):tabDataCollection._TabData.splice(f,1)};shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?chrome.tabs.query({},function(a){c(a)}):shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Edge?browser.tabs.query({},function(a){c(a)}):browser.tabs.query({}).then(function(a){c(a)})}}}(),suppressionHistory=function(){return{_SuppressionItems:[],
_TempItems:[],_TabSuppressedRetailers:[],_OurSuppressionItems:[],_AddEntry:function(c,a){var b=parseInt(localStorage.SuppressLengthMS)||15E3,e=(new Date).getTime();for(b=e-b;this._SuppressionItems&&0!==this._SuppressionItems.length&&this._SuppressionItems[0].Time<b;)this._SuppressionItems.splice(0,1);-1!==a.indexOf("googleads")?this._SuppressionItems.push({TabId:c,Time:e,Url:a}):this._TempItems.push({TabId:c,Time:e,Url:a});this._OurSuppressionItems=[]},_SyncSuppression:function(){var c=parseInt(localStorage.SuppressLengthMS)||
15E3;for(c=(new Date).getTime()-c;this._TempItems&&0!==this._TempItems.length&&this._TempItems[0].Time<c;)this._TempItems.splice(0,1);for(;this._TempItems&&0!==this._TempItems.length;)this._SuppressionItems.push(this._TempItems[0]),this._TempItems.splice(0,1)},_AddRetailerSuppressionEntry:function(c,a,b){for(var e=(new Date).getTime(),g=e-108E5,d=Object.keys(this._TabSuppressedRetailers),f=d.length-1;0<=f;--f)this._TabSuppressedRetailers[d[f]].Time<g&&delete this._TabSuppressedRetailers[d[f]];g=c+
","+a;this._TabSuppressedRetailers[g]||(this._TabSuppressedRetailers[g]={Time:e,Url:b,TabId:c,RetailerId:a})},_CleanTab:function(c){for(var a=this._SuppressionItems.length-1;0<=a;--a)this._SuppressionItems[a].TabId===c&&this._SuppressionItems.splice(a,1);a=Object.keys(this._TabSuppressedRetailers);for(var b=a.length-1;0<=b;--b)a[b].split(",")[0].toString()===c.toString()&&delete this._TabSuppressedRetailers[a[b]]},_CleanTabOnClose:function(c){for(var a=Object.keys(this._TabSuppressedRetailers),b=
a.length-1;0<=b;--b)a[b].split(",")[0]===c&&delete this._TabSuppressedRetailers[a[b]]},_isRetailerTabSuppressed:function(c){var a=!1,b=tabDataCollection._Get(c);b._CurrentId&&(c=this._TabSuppressedRetailers[c+","+b._CurrentId])&&(a=c.Url);return a},_IsSuppressed:function(c,a){var b=tabDataCollection._Get(c);if(b._PaidAdHttpRequest&&b._PaidAdHttpRequest.url===a||suppressionHistory._IsSelfSuppression(b,{url:a},b._RedirectReason?b._RedirectReason:null))return!1;if(shoptoolbar._ShouldSuppressLink(a,c))return a;
if(tabDataCollection._TabStartupDelaySuppression(c))return!1;var e=parseInt(localStorage.SuppressLengthMS)||15E3,g=(new Date).getTime();for(e=g-e;this._SuppressionItems&&0!==this._SuppressionItems.length&&this._SuppressionItems[0].Time<e;)this._SuppressionItems.splice(0,1);e=g-108E5;g=Object.keys(this._TabSuppressedRetailers);for(var d=g.length-1;0<=d;--d)this._TabSuppressedRetailers[g[d]].Time<e&&delete this._TabSuppressedRetailers[g[d]];e=null;g=b.History;for(d=0;d<g.length;d++)g[d].Url===a&&(e=
g[d].IsSuppressed?null:g[d].Time);a=!1;for(g=0;g<this._SuppressionItems.length;g++)if(this._SuppressionItems[g].TabId!==c||!e||e>this._SuppressionItems[g].Time)if(!b._CashbackActivationChangedTime||b._CashbackActivationChangedTime<this._SuppressionItems[g].Time)a=this._SuppressionItems[g].Url;a||(a=suppressionHistory._isRetailerTabSuppressed(c));return a},_GetReferer:function(c){var a=null;c.requestHeaders&&(a=$.map(c.requestHeaders,function(a){return"referer"===a.name.toLowerCase()?a:null}));return a=
a&&0!==a.length?a[0].value:null},_UrlParameters:function(c){c=c.substr(1).split("&");if(""===c)return{};for(var a={},b=0;b<c.length;++b){var e=c[b].split("=",2);a[e[0]]=1===e.length?"":decodeURIComponent(e[1].replace(/\+/g," "))}return a},_IsDestinationOurs:function(c){for(var a=parseUriWrapper.parseUri(c),b=0;b<suppressionHistory._OurSuppressionItems.length;b++){if(suppressionHistory._OurSuppressionItems[b]===cleanUrler(c))return!0;var e=parseUriWrapper.parseUri(suppressionHistory._OurSuppressionItems[b]);
if(a.host===e.host&&(0<=a.query.indexOf(e.query)||(new RegExp(decodeURIComponent(e.query),"i")).test(decodeURIComponent(a.query))))return!0}return!1},_IsSelfSuppression:function(c,a,b){b=b&&(b===shoptoolbar._NotifyState._RedirectTopCoupon||b===shoptoolbar._NotifyState._RedirectAnyCoupon||b===shoptoolbar._NotifyState._RedirectCashback||b===shoptoolbar._NotifyState._RedirectCashback2)||c._AutoRedirecting||shoptoolbar._TrackRedirectURL;var e=a&&a.url,g=function(a){a&&0>suppressionHistory._OurSuppressionItems.indexOf(a)&&
(100<suppressionHistory._OurSuppressionItems.length&&suppressionHistory._OurSuppressionItems.shift(),suppressionHistory._OurSuppressionItems.push(a))};if(e)if(/befrugal.com/i.test(parseUriWrapper.CleanUrl(a.url))){var d=(g=/(tlbrflowtype=printable)/i.test(e))||shoptoolbar._isIneligibleLink(e);e=/(r.befrugal.com|befrugal.com.coupons.cashbacksignuppopup.nu.)/i.test(e);c._CurrentRequest={fromBeFrugal:!d,fromRedirector:e&&!d,isCashbackInjection:!1,url:a.url,printable:g}}else c._CurrentRequest&&c._CurrentRequest.fromRedirector||
c._RedirectCashbackNewTab?(g(cleanUrler(a.url)),g(cleanUrler(suppressionHistory._UrlParameters(a.url).url))):c._CurrentRequest||(e=shoptoolbar._isCashbackInjectionClick(a.url)||c._CurrentRequest&&c._CurrentRequest.isCashbackInjection,c._CurrentRequest={fromBeFrugal:!1,fromRedirector:!1,isCashbackInjection:e,url:a.url});c=(c._CurrentRequest?c._CurrentRequest.fromBeFrugal:!1)||c._RedirectCashbackNewTab;return b||c||suppressionHistory._IsDestinationOurs(a.url)},_IsSelfDisabled:function(c){return c&&
0<shoptoolbar._ApplicationSettings.SelfDisabledRegex.length?(new RegExp(shoptoolbar._ApplicationSettings.SelfDisabledRegex,"i")).test(c):!1}}}(),shoptoolbar=function(){var c=[];return{firstOpenTab:!1,_RetailerDownloadsInProgress:[],befrugalInstallTabs:[],Config:{PrivacyPrompt:{Days:1,CounterEnabled:!1},UpdateRequired:!1,UpdateUrl:"",DailyUpdateReminder:!1,IsButtonInstalled:!1,DailyReminderImageMain:"",DailyReminderImageButton:""},_BefrugalEvents:{IsInitialized:!1,IsBonusCashBackActive:!1,Events:[{Name:"BonusCashBackEvent",
Type:1}],GetActive:function(a,b){shoptoolbar._BefrugalEvents.IsBonusCashBackActive=!1;if("number"===typeof a&&"string"===typeof b){var c=shoptoolbar._BefrugalEvents.Events.filter(function(c){return c.Type===a&&c.Name===b})[0];if(c)switch(c.Name){case "BonusCashBackEvent":shoptoolbar._BefrugalEvents.IsBonusCashBackActive=!0}return c}return null}},_Animation:function(){return{_images:[],_isAnimationRunning:!1,_intervalHandle:null,_currentFrame:0,_totalFrames:0,_loopCount:0,_animationSpeed:1E3/60,_animationStride:1,
_Init:function(a,b,c,g){if(!(1>=b)&&(shoptoolbar._Animation._images=[],shoptoolbar._Animation._isAnimationRunning=!1,shoptoolbar._Animation._intervalHandle=null,shoptoolbar._Animation._currentFrame=0,shoptoolbar._Animation._totalFrames=b,shoptoolbar._Animation._loopCount=0,shoptoolbar._Animation._animationSpeed=1E3/b,shoptoolbar._Animation._animationStride=1,c||(c="frame_"),g||(g="_delay-0.03s.png"),a&&""!==a))for(var d,f=0;f<b;f++)d=f.toString(),10>f&&(d="0"+f),shoptoolbar._Browser!==shoptoolbar.Browsers.Chrome?
shoptoolbar._Animation._images.push(browser.runtime.getURL(a+"/"+(c+d+g))):shoptoolbar._Animation._images.push(chrome.runtime.getURL(a+"/"+(c+d+g)))},_PlayAnimation:function(a){if(1>=shoptoolbar._Animation._totalFrames)browserAdapter._SetIcon(shoptoolbar.ActiveIcon);else{if(!a||0>=a)a=-1;shoptoolbar._Animation._loopCount=a;shoptoolbar._Animation._isAnimationRunning||(shoptoolbar._Animation._isAnimationRunning=!0);shoptoolbar._Animation._intervalHandle&&(clearInterval(shoptoolbar._Animation._intervalHandle),
shoptoolbar._Animation._currentFrame=0);shoptoolbar._Animation._intervalHandle=setInterval(function(){0===shoptoolbar._Animation._currentFrame&&0<=shoptoolbar._Animation._loopCount&&(0<shoptoolbar._Animation._loopCount?--shoptoolbar._Animation._loopCount:shoptoolbar._Animation._StopAnimation());browserAdapter._SetIcon(shoptoolbar._Animation._images[shoptoolbar._Animation._currentFrame]);var a=shoptoolbar._Animation._currentFrame+shoptoolbar._Animation._animationStride;shoptoolbar._Animation._currentFrame=
a%shoptoolbar._Animation._totalFrames;a>=shoptoolbar._Animation._totalFrames&&shoptoolbar._Animation._currentFrame<shoptoolbar._Animation._animationStride&&(shoptoolbar._Animation._currentFrame=0)},shoptoolbar._Animation._animationSpeed)}},_StopAnimation:function(){shoptoolbar._Animation._isAnimationRunning&&(shoptoolbar._Animation._isAnimationRunning=!1);shoptoolbar._Animation._intervalHandle&&clearInterval(shoptoolbar._Animation._intervalHandle);shoptoolbar._Animation._currentFrame=0;setTimeout(function(){browserAdapter._SetIcon(shoptoolbar.ActiveIcon)},
1)}}}(),_NotifyState:{_ActivateNoAccount:-5,_FinishRegister:-4,_LoginToClaimCashback:-3,_AskJoinTopCoupon:-2,_AskJoinCashback:-1,_AskClick:0,_RedirectCashback:1,_RedirectTopCoupon:2,_RedirectAnyCoupon:3,_RedirectCashback2:4},Browsers:{Chrome:0,Firefox:1,Edge:2},Site:"www.befrugal.com",APISite:"https://tbwsjs.befrugal.com",PartialSite:"https://partialjs.befrugal.com",HotelSite:"befrugalhotels.com",RateUsSite:"www.befrugal.com",_IsBF:!0,_Browser:0,_StoreSource:0,Stores:{Chrome:0,Firefox:1,Microsoft:2},
_TourMode:!1,_DISABLE_AUTO_APPLY_COUPONS:!1,_TourRetailer:{retailerId:0,retailerName:"",imageUrl:"",step:0,pageType:""},_TourPort:null,_QuitTourCount:0,ActiveIcon:"../icon16.png",InactiveIcon:"../icon16_inactive.png",_WelcomeScreenId:0,_TrackRedirectURL:null,_SendNotifyDigest:!1,_SendNotifyInstall:!1,_RecentRedirections:{},_PreloadOrphans:[],_NotificationHistory:[],_RecentPops:[],_IsButton:!0,_IsButtonClassic:!1,_RefLinks:{OldUserToken:"",ReferralToken:"",Copy:"",Twitter:"",Facebook:"",BonusAmount:"",
SignupBonus:""},_RefTab:{windowId:0,tabId:0},_ChromeStoreTab:{windowId:0,tabId:0},_CashBackInjectionSelectors:null,AutoRedirectSettings:null,NewTabSettings:{UseNewTabCashback:!0,CashbackPostionDefault:!0},Favorites:{},WeeklyAds:null,PopularRestaurants:null,FeaturedRetailers:null,UseBeforeRequest:!1,AllowDisablingNotifications:!1,CheckmarkCharacter:"\u2713",_NotificationsBlacklist:["account","support"],CashbackTerms:new Map,disablePageDataPoint:null,_IsOnNotifyBlacklist:function(a){return 0<shoptoolbar._NotificationsBlacklist.filter(function(b){return 0<=
a.indexOf(b)}).length},_IncrementRecentRedirection:function(a){var b=BfrlTool.Prefs.FailureMode,c=b.RedirectionCountTimeout;b=b.RedirectionCountLimit;var g=(new Date).getTime();c=g-c;var d=shoptoolbar._RecentRedirections[a]||[];for(shoptoolbar._RecentRedirections[a]=d;0!==d.length&&d[0]<c;)d.shift();return d.push(g)<=b},_FailureModeRedirectData:{},_RequestIdHeader:[],_GroceryData:null,_GroceryDataRefreshTime:null,_CVOnlineCouponData:null,_CVOnlineCouponDataRefreshTime:null,CLog:function(){console.log(arguments)},
GetToolbarVersion:function(){return shoptoolbar._ToolbarVersion},GetBrowser:function(){return shoptoolbar._Browser},GetIsBF:function(){return shoptoolbar._IsBF},GetIsButton:function(){return shoptoolbar._IsButton||!BfrlTool.Prefs.IsClassic},GetIsTourMode:function(a){shoptoolbar._TourMode?browserAdapter.GetActiveTab(!0,function(b){b&&b.id?a(b.id===shoptoolbar._WelcomeScreenId):a(!1)}):a(!1)},_GetAccount:function(){return new Promise(function(a,b){b=shoptoolbar.Format("https://{1}/toolbar/toolbarWS/ws.asmx/GetAccount?utmSource=&toolbarversion={0}",
shoptoolbar._ToolbarVersion,shoptoolbar.Site);shoptoolbar.LoadURI(b,function(b){BfrlTool.BrowserStorage.UserToken=function(a){a=b.evaluate(a,b.documentElement,function(){return"http://tempuri.org/"},XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return null===a?null:a.textContent}("/x:string");a()})})},GetReferralLinks:function(a){BfrlTool.BrowserStorage.UserToken.then(function(b){if(BfrlTool.Prefs.RAFToken&&shoptoolbar._RefLinks.ReferralToken&&shoptoolbar._RefLinks.ReferralToken===BfrlTool.Prefs.RAFToken&&
b===shoptoolbar._RefLinks.OldUserToken)a(shoptoolbar._RefLinks);else{var c=!shoptoolbar._IsBF,g=shoptoolbar._IsButton;shoptoolbar.FetchJson(shoptoolbar.APISite+"/wssimple.asmx/GetReferralLinks",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:shoptoolbar.Format("&UserToken={0}&referralToken={1}&addonType={2}&toolbarversion={3}",b,BfrlTool.Prefs.RAFToken,c&&g?"CouponViewerButton":c?"CouponViewerToolbar":g?"BeFrugalButton":"BeFrugalToolbar",shoptoolbar.GetToolbarVersion())}).then(function(d){d&&
(d={OldUserToken:b,ReferralToken:d.Token,Copy:d.CopyLink,Twitter:d.TwitterLink,Facebook:d.FacebookLink,BonusAmount:d.RAFBonusMessage,SignupBonus:d.SignupBonusMessage},BfrlTool.Prefs.RAFToken=d.ReferralToken,shoptoolbar._RefLinks=d,a(d))})}})},GetReferralBonus:function(a){shoptoolbar._LoadURI_JSON_GET(shoptoolbar.APISite+"/wssimplenonshopper.asmx/GetReferralLinks",function(b){b&&"null"!==b&&0<b.length&&(b=JSON.parse(b),shoptoolbar._RefLinks.BonusAmount=b.RAFBonusMessage,shoptoolbar._RefLinks.SignupBonus=
b.SignupBonusMessage,a())})},ShowNotification:function(a,b,c,g,d,f){shoptoolbar._ShowNotification(a,b,c,g,d,f)},GetIsRetailer:function(a){shoptoolbar.GetCurrentABrowser(function(b){b&&b._CurrentId&&"-1"!==b._CurrentId?shoptoolbar._ReadOrGetRetailerInfo(b._CurrentId,b,function(c){null!=c?a(!0,b._CurrentId,b._CashbackActivated,c):a(!1)}):a(!1)})},GetIsInRestaurantDigest:function(a){return BfrlTool._RetailerList._ContainsRestaurant(parseInt(a))},GetCurrentABrowser:function(a){browserAdapter.GetActiveTab(!0,
function(b){b&&b.id?a(tabDataCollection._Get(b.id)):a(null)})},GetExtensionRuntimeID:function(){return shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?chrome.runtime.id:browser.runtime.id},FetchJson:function(a,b){return fetch(a,b).then(function(a){return a.ok?a.json():null})},_TabRefresh:function(a,b,c,g){var d=tabDataCollection._Get(a),f=c.url,e=b.sourceEvent&&"TabsOnUpdated"===b.sourceEvent;if(b.status){shoptoolbar._TourMode&&"complete"===b.status&&shoptoolbar._CheckWelcomePage(f)&&(shoptoolbar._WelcomeScreenId===
c.id||0===shoptoolbar._WelcomeScreenId)&&browserAdapter._TourExecute(c);var m=suppressionHistory._IsSelfDisabled(f);if(m&&d._CurrentId)shoptoolbar._NavigatedOffRetailer(a,d),shoptoolbar._SetBadge(!1);else if(!m)if((m=suppressionHistory._IsSuppressed(a,f))&&(d._AutoRedirecting||shoptoolbar._TrackRedirectURL)?(m=!1,suppressionHistory._CleanTab(a)):m&&d._CurrentId&&suppressionHistory._AddRetailerSuppressionEntry(a,d._CurrentId,f),g=0<shoptoolbar._PreloadOrphans.length&&g,m&&g)shoptoolbar._SetBadge(!1,
function(){delete d._RedirectReason;shoptoolbar._ClearCashbackActivation(d,"_TabRefresh")});else{if(g){var n=shoptoolbar._GetMultipleDomains(parseUriWrapper.CleanUrl(f));try{var r=(new URL(f)).hostname;n.push(r);r.includes("www")&&n.push(r.split(".").filter(function(a){return!a.includes("www")}).join("."))}catch(w){}var v=function(e){if(e&&0<e.length){var g=BfrlTool._RetailerList._GetRetailer(e[0]);if(g){if(Array.isArray(g)){var h=longStringCompare(g,f);if(-1===h){v(e.slice(1));return}g=g[h]}e=shoptoolbar._PreloadOrphans.filter(function(a){return a._CurrentId===
g.RetailerID});0<e.length?(e=e[0],d._CashbackActivated=!0,d._CashbackActivationChangedTime=(new Date).getTime(),d._CurrentRequest&&(d._CurrentRequest._Autoredirected=!0),d._Intended=e._Intended,d._CurrentId=e._CurrentId,d._RetailerInfo=e._RetailerInfo,e._PaidAdHttpRequest&&e._PaidAdHttpRequest.suppressed?(b.sourceEvent="OrphanedPaidAdd",d._PaidAdHttpRequest=e._PaidAdHttpRequest,shoptoolbar._TabRefresh(a,b,c,!1)):(shoptoolbar._TrackRedirectURL=e._TrackRedirectURL,chrome.tabs.update(a,{url:e._Url},
function(){shoptoolbar._PreloadOrphans=shoptoolbar._PreloadOrphans.filter(function(a){return a._CurrentId!==g.RetailerID})}))):(b.sourceEvent="Orphaned",shoptoolbar._TabRefresh(a,b,c,!1))}else v(e.slice(1))}};v(n)}else{if(d._RedirectCashbackNewTab){"complete"===b.status&&shoptoolbar.NewTabSettings.UseNewTabCashback?browserAdapter.GetActiveTab(!0,function(a){null!=a&&c.id!==a.id?browserAdapter.CloseTab(c.id):(delete d._RedirectCashbackNewTab,b.sourceEvent="RedirectCashbackTabActivated",shoptoolbar._TabRefresh(c.id,
b,c,!1))}):"complete"!==b.status||shoptoolbar.NewTabSettings.UseNewTabCashback||browserAdapter.CloseTab(c.id);return}if(d._AutoRedirecting&&d._CurrentId&&"loading"===b.status){d._AutoRedirecting=!1;!shoptoolbar._IsButton||shoptoolbar._IsOnNotifyBlacklist(f)||shoptoolbar._IsRetailerOnHideNotificationsList(d._CurrentId)?shoptoolbar._IsOnNotifyBlacklist(f)||shoptoolbar._IsRetailerOnHideNotificationsList(d._CurrentId)||(!BfrlTool.Prefs.Guest&&d._CashbackActivated?d._RetailerInfo.CashbackRate&&shoptoolbar._ShowToastMessage(c.id,
d._CurrentId,d._CurrentRequest,d._RetailerInfo.CashbackRate,"animations/checkmark/checkmark.html","js/cashbackToastInject.js",null):(d._CurrentRequest&&(d._CurrentRequest._AutoRedirectShowNotification=!0),shoptoolbar._ShowNotification(c.id,d._CurrentId,shoptoolbar._NotifyState._RedirectCashback))):d._CashbackActivated?d._RetailerInfo.CashbackRate&&shoptoolbar._ShowToastMessage(c.id,d._CurrentId,d._CurrentRequest,d._RetailerInfo.CashbackRate,"animations/checkmark/checkmark.html","js/cashbackToastInject.js",
null):shoptoolbar._IsOnNotifyBlacklist(f)||shoptoolbar._IsRetailerOnHideNotificationsList(d._CurrentId)||shoptoolbar._ShowNotification(c.id,d._CurrentId,shoptoolbar._NotifyState._RedirectCashback);shoptoolbar._SetBadge(!1,function(){delete d._RedirectReason});return}if(null==shoptoolbar._TrackRedirectURL&&"loading"===b.status){var t=shoptoolbar._GetMultipleDomains(parseUriWrapper.CleanUrl(f));try{var u=(new URL(f)).hostname;t.push(u);u.includes("www")&&t.push(u.split(".").filter(function(a){return!a.includes("www")}).join("."))}catch(w){}if(d._RedirectTopCouponId){d._RedirectReason=
shoptoolbar._NotifyState._RedirectTopCoupon;if(d._CurrentId)shoptoolbar._ShowNotification(a,d._CurrentId,d._RedirectReason),delete d._RedirectTopCouponId;else{var x=function(b){if(b&&0<b.length){var c=BfrlTool._RetailerList._GetRetailer(b[0]);if(c){if(Array.isArray(c)){var e=longStringCompare(c,f);if(-1===e){x(b.slice(1));return}c=c[e]}d._CurrentId=c.RetailerID;d._RetailerInfo=c.RetailerInfo;shoptoolbar._ShowNotification(a,d._CurrentId,d._RedirectReason);delete d._RedirectTopCouponId}else x(b.slice(1))}};
x(t)}shoptoolbar._SetBadge(!1,function(){delete d._RedirectReason});return}var y=function(e,g){shoptoolbar._ReadOrGetRetailerInfo(e.RetailerID,d,function(h){var p,k=shoptoolbar._GetRetailerRedirectURL(e.RetailerID);if(g){if(p=shoptoolbar._MatchUrlToStoreRegex(k))p=tabDataCollection._IsWellKnown(p[1]),d._Redirect=k,(k=suppressionHistory._IsSuppressed(a,f))&&suppressionHistory._AddRetailerSuppressionEntry(a,d._CurrentId,f),d._CurrentId&&k&&(d._AutoRedirecting||shoptoolbar._TrackRedirectURL)&&(k=!1),
!k&&!d._CashbackActivated&&0<=suppressionHistory._OurSuppressionItems.indexOf(cleanUrler(f))&&(d._CashbackActivated=!0,d._CashbackActivationChangedTime=(new Date).getTime(),suppressionHistory._CleanTab(c.id)),p||k?!p||k||d._CashbackActivated||(shoptoolbar._IsButton||shoptoolbar._Animation._PlayAnimation(3),d._CashbackActivated||shoptoolbar.SuppressNotificationForRetailer(d)||(d._RedirectReason=shoptoolbar._NotifyState._AskClick)):d._AutoRedirecting&&d._CurrentId&&"loading"===b.status?(d._AutoRedirecting=
!1,d._CashbackActivated=!0,d._CashbackActivationChangedTime=(new Date).getTime(),shoptoolbar._IsButton&&d._CashbackActivated&&d._RetailerInfo.CashbackRate?shoptoolbar._IsOnNotifyBlacklist(f)||shoptoolbar._IsRetailerOnHideNotificationsList(d._CurrentId)||shoptoolbar._ShowToastMessage(c.id,d._CurrentId,d._CurrentRequest,d._RetailerInfo.CashbackRate+" Activated","animations/checkmark/checkmark.html","js/cashbackToastInject.js",null):shoptoolbar._IsOnNotifyBlacklist(f)||shoptoolbar._IsRetailerOnHideNotificationsList(d._CurrentId)||
(d._CurrentRequest&&(d._CurrentRequest._AutoRedirectShowNotification=!0),shoptoolbar._ShowNotification(c.id,d._CurrentId,shoptoolbar._NotifyState._RedirectCashback))):h.CashbackRate&&!shoptoolbar._IsButton&&"Standard"!==e.Rule&&(d._ShowCoupons=!1,shoptoolbar._IsOnNotifyBlacklist(f)||shoptoolbar._IsRetailerOnHideNotificationsList(d._CurrentId)||(d._RedirectReason=d._CashbackActivated?shoptoolbar._NotifyState._RedirectCashback:shoptoolbar._NotifyState._AskClick,b.focused||shoptoolbar._ShowNotification(a,
d._CurrentId,d._RedirectReason))),shoptoolbar._SetBadge(!1,function(){delete d._RedirectReason})}else p=tabDataCollection._IsWellKnown(e.RetailerID),d._Redirect=k,shoptoolbar._ClearCashbackActivation(d,"_TabRefresh"),p||shoptoolbar._LogNotifyBar(e.reason,e.RetailerID,[])})},k=function(b,f,e){if(b&&0!==b.length)if(f){var g=BfrlTool._RetailerList._GetRetailer(b[0]);if(g){if(Array.isArray(g)){if(d._CashbackActivated){var h=g.filter(function(a){return a.RetailerID.toString()===d._CurrentId.toString()});
if(0<h.length){y(h[0],f);return}}h=longStringCompare(g,e);if(-1===h){k(b.slice(1),f,e);return}y(g[h],f)}else y(g,f);d._CashbackActivated&&shoptoolbar._IncrementRecentRedirection(d._CurrentId)&&(!d._RedirectReason||d._RedirectReason&&d._RedirectReason!==shoptoolbar._NotifyState._RedirectTopCoupon)&&(b="&deeplink="+encodeURIComponent(c.url),shoptoolbar._RedirectIFrame(d._Redirect+b,c.id));d._PreviousId=d._CurrentId||d._PreviousId}else k(b.slice(1),f,e)}else shoptoolbar._NavigatedOffRetailer(a,d),shoptoolbar._SetBadge(!1,
function(){delete d._RedirectReason});else f?k(t,!1,e):(delete d._Redirect,delete d._RedirectReason,shoptoolbar._NavigatedOffRetailer(a,d),shoptoolbar._SetBadge(!1))};k(t,!0,f)}else if(shoptoolbar._TrackRedirectURL&&"loading"===b.status){r=parseUriWrapper.CleanUrl(shoptoolbar._TrackRedirectURL);u=shoptoolbar._GetMultipleDomains(parseUriWrapper.CleanUrl(f));try{n=(new URL(f)).hostname,u.push(n),n.includes("www")&&u.push(n.split(".").filter(function(a){return!a.includes("www")}).join("."))}catch(w){}for(n=
0;n<u.length;n++)u[n]===r&&chrome.tabs.update(c.id,{url:shoptoolbar._TrackRedirectURL},function(a){d._AutoRedirecting=!0;shoptoolbar._TrackRedirectURL=null;suppressionHistory._CleanTab(a.id)})}}if("complete"===b.status){d._AutoRedirecting&&(d._AutoRedirecting=!1,d._CashbackActivated=!0,d._CashbackActivationChangedTime=(new Date).getTime(),d._CurrentRequest?d._CurrentRequest._AutoRedirectShowNotification=!0:d._CurrentRequest={_AutoRedirectShowNotification:!0},shoptoolbar._IsOnNotifyBlacklist(f)||shoptoolbar._IsRetailerOnHideNotificationsList(d._CurrentId)||
(d._CashbackActivated&&d._RetailerInfo.CashbackRate?shoptoolbar._ShowToastMessage(c.id,d._CurrentId,d._CurrentRequest,d._RetailerInfo.CashbackRate+" Activated","animations/checkmark/checkmark.html","js/cashbackToastInject.js",null):(d._CurrentRequest&&(d._CurrentRequest._AutoRedirectShowNotification=!0),shoptoolbar._ShowNotification(c.id,d._CurrentId,shoptoolbar._NotifyState._RedirectCashback))));var p=/bing.com\/search/i.test(c.url);BfrlTool.BrowserStorage.AllowCashbackInjection.then(function(b){b&&
p&&browserAdapter._SendTabMessage(a,{action:"cashbackInjection_start",targetScript:"cashbackInjection.js"})});shoptoolbar._SetBadge(!e,function(){if(!d._CurrentRequest||!d._CurrentRequest.fromRedirector||d._CurrentRequest.fromRedirector&&(d._RetailerInfo&&d._RetailerInfo.Loaded||d._CashbackActivationChangedTime&&d._CashbackActivationChangedTime>d._CashbackActivationChangedTime+3E4))delete d._CurrentRequest,shoptoolbar._RetailerDownloadsInProgress=[]})}}}},RecordNotificationActivation:function(a,b){var c=
a._CurrentId;0<shoptoolbar._NotificationHistory.filter(function(a){return a.retailer===c}).length||shoptoolbar._NotificationHistory.push({retailer:c,requestStatus:a.requestStatus})},SuppressNotificationForRetailer:function(a){var b=a._CurrentId;return!b||!a||a._RetailerInfo&&a._RetailerInfo.SuppressNotification?!0:0<shoptoolbar._NotificationHistory.filter(function(a){return a.retailer===b}).length&&a.requestStatus&&"loading"===a.requestStatus},UTQueryString:"",get _ToolbarVersion(){return(shoptoolbar.GetBrowser()===
shoptoolbar.Browsers.Edge?"Edge":shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox?"Firefox":shoptoolbar._EdgiumCheck())+"-"+(shoptoolbar.GetIsButton()?"BTN-":shoptoolbar.GetIsBF()?"BFGL-":"CNVW-")+chrome.runtime.getManifest().version},_EdgiumCheck:function(){return shoptoolbar._IsEdgium()?shoptoolbar._StoreSource===shoptoolbar.Stores.Chrome?"ECedgium":shoptoolbar._StoreSource===shoptoolbar.Stores.Microsoft?"EMedgium":"Edgium":"Chrome"},_IsEdgium:function(){return"undefined"!==typeof window&&
"undefined"!==typeof window.navigator&&"undefined"!==typeof window.navigator.userAgent&&window&&window.Navigator&&window.navigator.userAgent&&/edg/i.test(window.navigator.userAgent)},_LoggedIn:!1,_TopBarLengthInterval:parseInt(localStorage.TopBarLengthMS)||6E4,_SerializeUsageMetrics:function(){var a=[],b=JSON.parse(localStorage.usagemetrics||"{}"),c=b.redirecterrorcount,g=b.redirecterrorid;delete b.redirecterrorcount;delete b.redirecterrorid;for(var d in b)b.hasOwnProperty(d)&&a.push(d+"."+b[d]);
return{metrics:a.join(),redirecterrorcount:c,redirecterrorid:g}},_SetUsageMetrics:function(a,b){var c=JSON.parse(localStorage.usagemetrics||"{}");c[a]=b;localStorage.usagemetrics=JSON.stringify(c)},IncrementUsageMetrics:function(a){var b=JSON.parse(localStorage.usagemetrics||"{}");a in b||(b[a]=0);++b[a];localStorage.usagemetrics=JSON.stringify(b)},GetSearchAutoComplete:function(a,b){BfrlTool.BrowserStorage.IsShopper.then(function(c){c=shoptoolbar.Format("https://{0}/SearchOffers/search.asmx/GetCompletionListMultiJSON?contextKey={1}&count={2}&isShopper={3}&prefixText={4}",
shoptoolbar.Site,shoptoolbar._IsButton?"button-js":"toolbar-js",10,c,encodeURIComponent(a));var e=new XMLHttpRequest;e.open("GET",c);e.onload=function(a){e.responseText&&0<e.responseText.length?(a=JSON.parse(e.responseText),b(a)):b(null)};try{e.overrideMimeType("application/json")}catch(d){}try{e.send(null)}catch(d){}})},_GetRetailerCouponURL:function(a,b,c){BfrlTool.BrowserStorage.UserToken.then(function(e){b?c(shoptoolbar.Format("https://{0}/restaurants/"+a+"?bfsrc=2&bfuser={1}&toolbarversion={2}",
shoptoolbar.Site,e,shoptoolbar._ToolbarVersion)):c(shoptoolbar.Format("https://{0}/store/"+a+"/?bfsrc=2&bfuser={1}&toolbarversion={2}",shoptoolbar.Site,e,shoptoolbar._ToolbarVersion))})},GetSearchRetailerRedirectURL:function(a,b,c){BfrlTool._RetailerList._ContainsRetailer(parseInt(a))||BfrlTool._RetailerList._ContainsRestaurant(parseInt(a))?c(shoptoolbar._GetRetailerRedirectURL(a),!0):shoptoolbar._GetRetailerCouponURL(b,!1,function(a){c(a,!1)})},GetRetailerRedirectURL:function(a){return shoptoolbar._GetRetailerRedirectURL(a)},
_GetRetailerRedirectURL:function(a,b,c){b=b?"1":c?"2":"3";c=localStorage.RedirectFormat?localStorage.RedirectFormat:"https://r.befrugal.com/";return BfrlTool.Prefs.PrivacyPrompt||shoptoolbar._GetNoCashBackExtension()?c+"?rtr="+a+"&nocook=true":c+"?rtr="+a+"&bf_src="+b+shoptoolbar.UTQueryString+"&tlb="+a},_GetNoCashBackExtension:function(a){if(a)BfrlTool.BrowserStorage.NoCashBackExtension.then(function(b){b&&(BfrlTool.Prefs.NoCashBackExtension=!0);a(!!b)});else return BfrlTool.Prefs.NoCashBackExtension},
GetRetailerInfo:function(a,b,c){var e=tabDataCollection._TabData.filter(function(b){return b._RetailerInfo&&b._RetailerInfo.RetailerID.toString()===a.toString()});0<e.length?c(e[0]._RetailerInfo):b?shoptoolbar._GetRetailerInfo(a,function(a){a&&a.RetailerInfo?c(a.RetailerInfo):c(null)}):shoptoolbar._ReadOrGetRetailerInfo(a,null,function(a){a?c(a):c(null)})},_RetailerInfoScan:function(a,b){a||b(null);var c=tabDataCollection._TabData.filter(function(b){return b._CurrentId&&b._CurrentId.toString()===
a.toString()&&b._Offers&&b._CouponBlob&&b._RetailerInfo&&b._RetailerInfo.RetailerID.toString()===a.toString()});if(0<c.length)b(c[0]);else return null},_ReadOrGetRetailerInfo:function(a,b,c){if(a)if(b&&b._RetailerInfo&&b._Offers&&b._RetailerInfo.RetailerID.toString()===a.toString())c(b._RetailerInfo);else{var e=function(b){0<shoptoolbar._RetailerDownloadsInProgress.length?shoptoolbar._RetailerDownloadsInProgress.push(c):(shoptoolbar._RetailerDownloadsInProgress.push(c),shoptoolbar._GetRetailerInfo(a,
function(d){var c=/true/i;if(d){var f=function(a,b){for(var d in a)if(0<=d.indexOf(b))return a[d];return null}(d.CouponBlob.CodeBoxLogic,"Retailer");b._UseIframe=f&&f["@UseIframe"]?c.test(d.CouponBlob.CodeBoxLogic["@UseIframe"]):!1;b._RetailerInfo=d.RetailerInfo||{};b._RetailerInfo.SuppressNotification=d.SuppressNotification;b._TopCoupon=d.TopCoupon;b._CouponBlob=d.CouponBlob;b._RetailerInfo.RecentCartPop=d.RecentCartPop;b._Offers=d.Offers;shoptoolbar.firstOpenTab=!1;0===tabDataCollection._TabData.filter(function(b){return b._LastActivatedRetailer&&
b._LastActivatedRetailer.toString()===a.toString()||b._CurrentId&&b._CurrentId.toString()===a.toString()&&b._CashbackActivated}).length?shoptoolbar._ClearCashbackActivation(b,"_ReadOrGetRetailerInfo"):b._CashbackActivated=!0;b._CurrentId=parseInt(a);for(c=0;c<shoptoolbar._RetailerDownloadsInProgress.length;c++)shoptoolbar._RetailerDownloadsInProgress[c](d.RetailerInfo);shoptoolbar._RetailerDownloadsInProgress=[]}}))},d=function(b,d){b._CurrentId=parseInt(a);b._UseIframe=d._UseIframe;b._RetailerInfo=
d._RetailerInfo;b._TopCoupon=d._TopCoupon;b._CouponBlob=d._CouponBlob;b._Offers=d._Offers;d._CashbackActivated&&(b._CashbackActivated=d._CashbackActivated,b._CashbackActivationChangedTime=d._CashbackActivationChangedTime);return b._RetailerInfo};if(b){var f=tabDataCollection._TabData.filter(function(b){return b._Offers&&b._RetailerInfo&&b._RetailerInfo.RetailerID.toString()===a.toString()});0<f.length?c(d(b,f[0])):e(b)}else browserAdapter.GetActiveTab(!0,function(f){f&&f.id&&((b=tabDataCollection._Get(f.id))&&
b._RetailerInfo&&b._Offers&&b._RetailerInfo.RetailerID.toString()===a.toString()?c(b._RetailerInfo):b?(f=tabDataCollection._TabData.filter(function(b){return b._Offers&&b._RetailerInfo&&b._RetailerInfo.RetailerID.toString()===a.toString()}),0<f.length?c(d(b,f[0])):e(b)):shoptoolbar._GetRetailerInfo(a,function(a){a&&a.RetailerInfo&&c(a.RetailerInfo)}))})}},_GetRetailerInfo:function(a,b){BfrlTool.BrowserStorage.IsShopper.then(function(c){var e=shoptoolbar.APISite+"/wssimplenonshopper.asmx/GetRetailerInfo";
c=shoptoolbar.Format("?retailerid={0}&isShopper={1}",a,c);shoptoolbar._LoadURI_JSON_GET(e+c,function(a){a&&"null"!==a&&0<a.length?b(JSON.parse(a)):b(null)})})},GetRetailerInfoSearch:function(a,b){BfrlTool.BrowserStorage.IsShopper.then(function(a){var c=shoptoolbar.APISite+"/wssimplenonshopper.asmx/GetRetailerInfoByInternalName";a=shoptoolbar.Format("?retailerid={0}&isShopper={1}",retailerid,a);shoptoolbar._LoadURI_JSON_GET(c,a,function(a){a&&0<a.length?b(JSON.parse(a)):b(null)})})},_GetCashBackInjectionSelectors:function(a){shoptoolbar._CashBackInjectionSelectors?
a(shoptoolbar._CashBackInjectionSelectors):shoptoolbar._LoadURI_JSON_GET(shoptoolbar.APISite+"/wssimplenonshopper.asmx/GetCashBackInjectionSelectors",function(b){shoptoolbar._CashBackInjectionSelectors=JSON.parse(b);a(shoptoolbar._CashBackInjectionSelectors)})},_ReadOrGetWeeklyAds:function(a){shoptoolbar.WeeklyAds?a(shoptoolbar.WeeklyAds):shoptoolbar._LoadURI_JSON_GET(shoptoolbar.APISite+"/wssimplenonshopper.asmx/GetWeeklyAds",function(b){b&&0<b.length?(shoptoolbar.WeeklyAds=JSON.parse(b),a(shoptoolbar.WeeklyAds)):
a(null)})},_ReadOrGetFeaturedRetailers:function(a){shoptoolbar.FeaturedRetailers?a(shoptoolbar.FeaturedRetailers):BfrlTool.BrowserStorage.IsShopper.then(function(b){var c=shoptoolbar.APISite+"/wssimplenonshopper.asmx/GetFeaturedRetailers";b=shoptoolbar.Format("?isShopper={0}",b);shoptoolbar._LoadURI_JSON_GET(c+b,function(b){b&&0<b.length?(shoptoolbar.FeaturedRetailers=JSON.parse(b),a(shoptoolbar.FeaturedRetailers)):a(null)})})},_ReadOrGetPopularRestaurants:function(a){shoptoolbar.PopularRestaurants?
a(shoptoolbar.PopularRestaurants):shoptoolbar._LoadURI_JSON_GET(shoptoolbar.APISite+"/wssimplenonshopper.asmx/GetRestaurantTopInfo",function(b){b&&0<b.length?(shoptoolbar.PopularRestaurants=JSON.parse(b),a(shoptoolbar.PopularRestaurants)):a(null)})},_GetRestaurantBonusEligibility:function(a){BfrlTool.BrowserStorage.PrivacyPrompt.then(function(b){b&&0<parseInt(shoptoolbar._TourRetailer.retailerId)?a({Eligible:!0,RetailerID:parseInt(shoptoolbar._TourRetailer.retailerId)}):BfrlTool.BrowserStorage.UserToken.then(function(b){b=
shoptoolbar.Format("UserToken={0}&toolbarversion={1}",b,shoptoolbar._ToolbarVersion);shoptoolbar._LoadURI_JSON_POST("https://tbwsjs.befrugal.com/wssimple.asmx/GetRestaurantBonusEligibility",b,function(b){b&&0<b.length?a(JSON.parse(b)):a(null)})})})},_ResetUsageMetrics:function(){localStorage.usagemetrics="{}"},_GetMultipleDomains:function(a){if(a.match("c.www.endless.com"))return[];var b=a.match("secure-([^.]*).gap.com");b&&(a=b[1]+".gap.com");a=a.split(".");b=[];for(var c=2<=a.length&&"gap"===a[a.length-
2],g=0;5>g&&!(1>=a.length);++g){var d=a.join(".");0===g&&(a=a.slice(-6));a.shift();b.push(d)}return c?b.slice(0,2):b},_StringToMiniHash:function(a){return{arr:a.toLowerCase().split("\n"),check:function(a){return-1!==this.arr.indexOf(a.toLowerCase())}}},_LoadBlackLists:function(){shoptoolbar.queryBlacklist=shoptoolbar._StringToMiniHash(BfrlTool.Prefs.BlackList.Query);shoptoolbar.canonicalBlacklist=shoptoolbar._StringToMiniHash(BfrlTool.Prefs.BlackList.Canonical);shoptoolbar.regexBlacklist=shoptoolbar._StringToMiniHash(BfrlTool.Prefs.BlackList.Regex)},
_MD5Hash:function(a){for(var b=0;b<a.length;++b){var c=MD5(a[b]);if(this.canonicalBlacklist&&this.canonicalBlacklist.check(c))return!0}return!1},_GenerationInProgress:0,_GenerationInProgressReset:0,_RegenDB:function(){shoptoolbar._GenerationInProgress++;clearTimeout(shoptoolbar._GenerationInProgressReset);shoptoolbar._GenerationInProgressReset=setTimeout(function(){shoptoolbar._GenerationInProgress=0},3E5);if(!(1<shoptoolbar._GenerationInProgress)){var a=function(){var a=1<shoptoolbar._GenerationInProgress;
shoptoolbar._GenerationInProgress=0;a&&shoptoolbar._RegenDB()};shoptoolbar._GetRetailerDigestPartial(function(b){shoptoolbar._ReadRetailerDigestPartial(b,a)})}},_GetRetailerDigestPartial:function(a){var b=function(b){localStorage.DigestVersion=shoptoolbar._ToolbarVersion;BfrlTool.BrowserStorage.PrivacyPrompt.then(function(c){var d=shoptoolbar.PartialSite+"/wssimple.asmx/RetailerDigestPartial",f="";c?f="usertoken=&toolbarversion=":(f=shoptoolbar.Format("usertoken={0}&toolbarversion={1}",b,shoptoolbar._ToolbarVersion),
c=shoptoolbar._SerializeUsageMetrics(),shoptoolbar._ResetUsageMetrics(),f=f+"&toolbarmetrics="+c.metrics,c.redirecterrorcount&&(f=f+"&rerrors="+c.redirecterrorcount),c.redirecterrorid&&(f=f+"&lastid="+c.redirecterrorid));shoptoolbar._LoadURI_JSON_POST(d,f,function(b){a(b)})})};BfrlTool.BrowserStorage.PrivacyPrompt.then(function(a){a||BfrlTool.Prefs.PrivacyPrompt?b(""):BfrlTool.BrowserStorage.UserToken.then(function(a){a&&0<a.length?b(a):b("")})})},GetGroceryInfo:function(a){shoptoolbar._GroceryData&&
shoptoolbar._GroceryDataRefreshTime&&shoptoolbar._GroceryDataRefreshTime>Date.now()?a(shoptoolbar._GroceryData):(shoptoolbar._LoadURI_JSON_GET(shoptoolbar.APISite+"/wssimplenonshopper.asmx/GetGroceryCoupons",function(b){b&&"null"!==b&&0<b.length?(shoptoolbar._GroceryData=JSON.parse(b),a(shoptoolbar._GroceryData)):a(null)}),shoptoolbar._GroceryDataRefreshTime=Date.now()+864E5)},GetCVOnlineCoupons:function(a){shoptoolbar._CVOnlineCouponData&&shoptoolbar._CVOnlineCouponDataRefreshTime&&shoptoolbar._CVOnlineCouponDataRefreshTime>
Date.now()?a(shoptoolbar._CVOnlineCouponData):(shoptoolbar._LoadURI_JSON_GET(shoptoolbar.APISite+"/wssimplenonshopper.asmx/GetOnlineCouponsHomePageOffers",function(b){b&&"null"!==b&&0<b.length?(shoptoolbar._CVOnlineCouponData=JSON.parse(b),a(shoptoolbar._CVOnlineCouponData)):a(null)}),shoptoolbar._CVOnlineCouponDataRefreshTime=Date.now()+864E5)},_Canonicalize:function(a){var b=function(a){var b=a;for(a=unescape(a);b!==a;)b=a,a=unescape(b);return a};a=a.replace(/[\r\n\t]/gi,"");a=a.replace(/#.*/gi,
"");var c=parseUriWrapper.parseUri(a),g=b(c.host),d=b(c.path).replace(/\/+/g,"/");b=b(c.query);var f=parseUriWrapper.normalizeIPv4(g);g=f?f:g.replace(/(^\.*)|(\.*$)/g,"").replace(/\.+/g,".").toLowerCase();f=c.port;(c=c.protocol)||(c="http");if("80"===f&&"http"===c||"443"===f&&"https"===c)f="";f&&(f=":"+f);-1!==a.indexOf("?")&&(b="?"+b);a=d.split("/");for(d=0;d<a.length;++d)if("."===a[d]||".."===a[d]&&0===d)a.splice(d,1),d--;for(d=0;d<a.length;++d)".."===a[d]&&(0===d?(a.splice(d,1),d--):(a.splice(d-
1,2),d-=2));(d=a.join("/"))&&"/"===d[0]||(d="/"+d);return(c+"://"+g+f+d+b).replace(/(\s*$)|(^\s*)/g,"").replace(/./g,function(a){return 32>=a.charCodeAt(0)||127<=a.charCodeAt(0)||"#"===a||"%"===a?"%"+"0123456789ABCDEF".charAt(a.charCodeAt(0)>>4&15)+"0123456789ABCDEF".charAt(a.charCodeAt(0)&15):a})},_IsPaidAdword:function(a){return(new RegExp(shoptoolbar._ApplicationSettings.PaidAdRegex,"i")).test(parseUriWrapper.CleanUrl(a))},_isCashbackInjectionClick:function(a){return-1<a.indexOf("afsrc=1&bfsrc=7")},
_isIneligibleLink:function(a){return-1<a.indexOf("eligible=false")},_ShouldSuppressLink:function(a,b){var c=[],g=this._Canonicalize(a),d="",f=g.indexOf("?");-1!==f&&(d=g.slice(f+1));if(shoptoolbar._isIneligibleLink(d))return!0;g=parseUriWrapper.parseUri(a);if(!g||!g.host)return!1;f=g.host.split(".");for(var h=0;5>h&&!(1>=f.length);++h){var m=f.join(".");0===h&&(f=f.slice(-6));f.shift();for(var n=g.path.split("/"),r=0;6>r;++r){var v=n.join("/");if(0===r)""!==g.query&&c.push(m+v+"?"+g.query);else if(1===
r&&(n=n.slice(0,5)),n.pop(),c.push(m+v+(2<=r?"/":"")),"/"===v||""===v)break}}if(this._MD5Hash(c))return!0;if(/be.?frugal|afsrc=1&bfact=true/i.test(d)||shoptoolbar._isCashbackInjectionClick(d))return!1;if(d&&""!==d&&shoptoolbar.queryBlacklist)for(c=0;c<shoptoolbar.queryBlacklist.arr.length;++c)if(g="[\\?&]"+shoptoolbar.queryBlacklist.arr[c].replace(/[\[]/,"\\[").replace(/[\]]/,"\\]")+"=([^&#]*)",null!==(new RegExp(g,"i")).exec("?"+d))return tabDataCollection._Get(b),tabDataCollection._OverwriteStartupDelay(b),
!0;if(shoptoolbar.regexBlacklist&&shoptoolbar.regexBlacklist.arr)for(b=0;b<shoptoolbar.regexBlacklist.arr.length;++b)if((new RegExp(shoptoolbar.regexBlacklist.arr[b],"i")).exec(a))return!0;return!1},_LoadFile:function(a){var b=new XMLHttpRequest;b.open("GET",a,!1);b.send(null);return b.responseText},_LoadFilePromise:function(a){0>a.indexOf("https")&&(a=a.replace("http","https"));return new Promise(function(b,c){var e=new XMLHttpRequest;e.addEventListener("load",function(a){b(e.responseText)});e.addEventListener("error",
function(a){DEBUG&&console.error("(shoptoolbar.js) XMLHttp Error: "+e.statusText);c("(shoptoolbar.js) XMLHttp Error: ",e.statusText)});e.addEventListener("readystatechange",function(a){e.statusText&&0<e.statusText.length&&-1===e.statusText.indexOf("OK")&&DEBUG&&console.error("(shoptoolbar.js) XMLHttp ready state change Error: "+e.statusText)});e.open("GET",a);e.send()})},_LoadImageFile:function(a,b){return new RSVP.Promise(function(b){var c=new Image;c.onload=function(){var a=document.createElement("canvas");
a.width=c.width;a.height=c.height;a.getContext("2d").drawImage(c,0,0);b(a.toDataURL())};c.src=a})},Format:function(a){var b=Array.prototype.slice.call(arguments,1);return a.replace(/{(\d+)}/g,function(a,c){return"undefined"!==typeof b[c]?b[c]:""})},_ShowNotification:function(a,b,c,g,d,f){shoptoolbar._GetNoCashBackExtension(function(e){var h=tabDataCollection._Get(a);if(!(h._Justredirected&&h._Justredirected.tlbrid||h._AutoRedirecting||!b||"2105"===b.toString()||h._CurrentRequest&&h._CurrentRequest._Autoredirected&&
!h._CurrentRequest._AutoRedirectShowNotification||!shoptoolbar._IsButton&&shoptoolbar.Config.IsButtonInstalled||h._RetailerInfo&&h._RetailerInfo.SuppressNotification)){var n=AutoApplyApp&&AutoApplyApp._AutoApplyCheckoutPage,r=shoptoolbar.SuppressNotificationForRetailer(h);if(!r||h._RedirectTopCouponId||!h._RetailerInfo||"0"===h._RetailerInfo.CouponCount.toString()||f||!(!n||n&&h._CashbackActivated))if(!e||h._TopCoupon)h._CurrentRequest&&(h._CurrentRequest.fromRedirector||h._CurrentRequest.isCashbackInjection)||
h._CashbackActivated&&(shoptoolbar._IsButton||r)||BfrlTool.BrowserStorage.EasyActivationShown.then(function(f){(shoptoolbar._IsButton&&!f||!h._RetailerInfo||!h._RetailerInfo.RecentCartPop||shoptoolbar.Config.UpdateRequired||h._CurrentRequest&&h._CurrentRequest._Autoredirected||(n||c&&c===shoptoolbar._NotifyState._LoginToClaimCashback)&&(!h._RetailerInfo.RecentCartPop||AutoApplyApp._AutoApplyCheckoutPage&&h._RetailerInfo.AutoApplyCartPop))&&!shoptoolbar._IsRetailerOnHideNotificationsList(b)&&(c===
shoptoolbar._NotifyState._RedirectCashback&&(c=shoptoolbar._NotifyState._RedirectCashback2),d||(d=function(){}),c||(c=shoptoolbar._NotifyState._AskClick),shoptoolbar._ReadOrGetRetailerInfo(b,h,function(h){if(h){var m=function(a){return new Promise(function(b){var c="notifybar/images/"+a.substring(11,a.length-1);shoptoolbar._LoadImageFile(c).then(function(c){b([a,c])})})},n=function(a,b,c){b=a.indexOf(b)+b.length;return a.substring(b,a.indexOf(c,b))};if(!h.IsRestaurant){var r=tabDataCollection._Get(a);
r._RedirectReason=c;r._LastNotifyState=c;shoptoolbar._LoadFilePromise("notifybar/notifybar.html").then(function(d){var p=n(d,"\x3c!--CSS START--\x3e","\x3c!--CSS END--\x3e"),k=n(d,"\x3c!--NOTIFY BAR START--\x3e","\x3c!--NOTIFY BAR END--\x3e");d=p.match(/url\(images\/[^)]*\)/gi);var A=[];if(d&&d.length)for(var q=0;q<d.length;++q)A.push(m(d[q]));Promise.all(A).then(function(d){for(var m=0;m<d.length;++m){var w="";if(shoptoolbar._Browser!==shoptoolbar.Browsers.Firefox)p=p.replace(d[m][0],"url("+d[m][1]+
")");else{w=browser.runtime.getURL("notifybar");var A=d[m][0];w=w+"/"+A.substr(A.indexOf("(")+1,A.indexOf(")")-(A.indexOf("(")+1));p=p.replace(d[m][0],"url("+w+")")}}if(h.RetailerName){var n=[],q=[],z="bf_src=2"+shoptoolbar.UTQueryString,v=r._TopCoupon;if(shoptoolbar._IsButton){var t="<div></div>";k=k.replace(/{CASHBACK}/gi,h.CashbackRate);k=k.replace(/{BANNERSRC}/gi,chrome.runtime.getURL("notifybar/images/banner.png"));switch(c){case shoptoolbar._NotifyState._AskClick:case shoptoolbar._NotifyState._RedirectCashback:q.push("notification-right-container-notActivated");
break;case shoptoolbar._NotifyState._RedirectCashback2:case shoptoolbar._NotifyState._RedirectTopCoupon:case shoptoolbar._NotifyState._RedirectAnyCoupon:if(!h.CashbackRate)return;q.push("notification-right-container-activated")}}else{t="<iframe></iframe>";d=h.CashbackRate;!d||e?n.push("text-savings2"):k=k.replace(/{AVGSAVINGS}/gi,d);var u=h.CouponCount.toString();k=k.replace(/{RETAILERLOGO}/gi,h.ImgUrl);k=k.replace(/{RETAILERNAME}/gi,h.RetailerName);k=k.replace(/{COUPONSANDORDEALS}/gi,"1"===u?"coupon or deal":
"coupons and deals");k=k.replace(/{CPNCNT}/gi,u);c===shoptoolbar._NotifyState._RedirectAnyCoupon?(d=unescape((g.tlbon||"").replace(/\+/g," ")),68<d.length&&(d=d.substring(0,65)+"..."),k=k.replace(/{COUPONTITLE}/gi,d),k=k.replace(/{CODE}/gi,unescape((g.tlboc||"").replace(/\+/g," ")))):c===shoptoolbar._NotifyState._RedirectTopCoupon&&(d=v.Description,68<d.length&&(d=d.substring(0,65)+"..."),k=k.replace(/{COUPONTITLE}/gi,d),k=k.replace(/{CODE}/gi,v.Code));k=k.replace(/{CASHBACK}/gi,h.CashbackRate);"1"===
u&&n.push("all-offers");"1"===u&&n.push("all-offers");if(c===shoptoolbar._NotifyState._LoginToClaimCashback)q=["left-cashback2","btn-click-for-make","cpn-makeaccount","txtaccount","aMakeAccount"];else if(c===shoptoolbar._NotifyState._FinishRegister)q=["left-cashback2","text-terms","btn-click-for-make","cpn-makeaccount","agotomyaccount"];else if(c===shoptoolbar._NotifyState._ActivateNoAccount)q=["left-cashback2","text-logintoclaim"];else if("0"!==u)switch(1>=c&&-3<c&&(v.Description&&1!==c?(BfrlTool.Prefs.Guest?
q=0!==c&&-1!==c?["text-logintoclaim","text-savings2","click-top-btn"]:-1===c?["text-logintoclaim","click-top-btn"]:e?["click-top-btn","text-savings2"]:["click-cb-btn2","click-top-btn","text-savings2"]:(q=["text-savings2","click-top-btn"],0!==c||e||q.push("click-cb-btn2")),h.CashbackRate&&0!==c?q.push("left-cashback2"):q.push("left-coupons")):q=["left-cashback1","text-cashback","right-cashback","icon-moneybag","click-cb-btn"]),c){case shoptoolbar._NotifyState._AskClick:case shoptoolbar._NotifyState._RedirectCashback:q.push("btn-click-for");
break;case shoptoolbar._NotifyState._RedirectCashback2:if(!h.CashbackRate)return;q.push("left-cashback2");BfrlTool.Prefs.Guest?q.push("text-logintoclaim"):q.push("text-terms");break;case shoptoolbar._NotifyState._RedirectTopCoupon:case shoptoolbar._NotifyState._RedirectAnyCoupon:if(c===shoptoolbar._NotifyState._RedirectTopCoupon)var y=v.Code;c===shoptoolbar._NotifyState._RedirectAnyCoupon&&(y=g.tlboc);q.push("btn-click-for-active");q.push("text-savings2");q.push("left-coupons");q.push("all-offers");
y?q.push("use-code"):q.push("cpn-activated")}else switch(c){case shoptoolbar._NotifyState._AskClick:case shoptoolbar._NotifyState._RedirectCashback:q.push("btn-click-for");q.push("left-cashback1");q.push("click-cb-btn2");q.push("click-cb-btn");break;case shoptoolbar._NotifyState._RedirectCashback2:if(!h.CashbackRate)return;q.push("left-cashback2");BfrlTool.Prefs.Guest?q.push("text-logintoclaim"):q.push("text-terms");break;case shoptoolbar._NotifyState._RedirectTopCoupon:case shoptoolbar._NotifyState._RedirectAnyCoupon:if(c===
shoptoolbar._NotifyState._RedirectTopCoupon)var x=v.Code;c===shoptoolbar._NotifyState._RedirectAnyCoupon&&(x=g.tlboc);q.push("btn-click-for-active");q.push("text-savings2");q.push("left-coupons");q.push("all-offers");x?q.push("use-code"):q.push("cpn-activated")}}shoptoolbar._GetRetailerCouponURL(h.InternalName,h.IsRestaurant,function(d){if(!f||r._TourRetailerId&&r._TourRetailerId===parseInt(b))r._TourRetailerId=parseInt(b),q.push("notification-first-easy"),BfrlTool.BrowserStorage.EasyActivationShown=
!0;q.push("merchant-logo");var e=ButtonApp._GetButtonStorage(b),g="var n = (typeof $ !== 'undefined') ? $('"+t+"') : 'undefined'; if (typeof n === 'undefined' || typeof n.notifybar === 'undefined') undefined; else n.notifybar({"+shoptoolbar.Format("'eulaurl' : 'https://{0}/termsandconditions/?{1}',",shoptoolbar.Site,z)+shoptoolbar.Format("'couponurl' : '{0}',",d)+shoptoolbar.Format("'couponredirect' : '{0}{1}&{2}',",localStorage.couponredirect,v&&v.ID?v:-1,z)+shoptoolbar.Format("'canregister' : {0},",
BfrlTool.Prefs.Guest)+shoptoolbar.Format("'redirecttype' : {0},",c)+shoptoolbar.Format("'disableable' : {0},",shoptoolbar.AllowDisablingNotifications)+"'bannerSrc': '"+chrome.runtime.getURL("notifybar/images/banner.png")+"','cashbackRate': '"+h.CashbackRate+"','cashbackActivated': '"+r._CashbackActivated+"','cashbackActivatedTimeoutOut': '3000','cssUrl': '"+chrome.runtime.getURL("/fonts/Roboto.css")+"','isEdge': "+(shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Edge?"true":"false")+","+(e&&e.dialog?
"'dialogPosition': '"+JSON.stringify(e.dialog.position)+"',":"")+("'visibles': "+JSON.stringify(q))+","+("'skipdisplay': "+JSON.stringify(n))+","+(c?"":"'closenote':true,")+"'height': 55, 'retailerid':'"+b+"','notifybar':'"+escape(p+k)+"','nocoupons': '"+("0"===u?"true":"false")+"'});";browserAdapter._ExecuteScript(a,"js/jquery.min.js",function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);browserAdapter._ExecuteScript(a,"js/notifybar.js",function(){chrome.runtime.lastError&&
console.debug(chrome.runtime.lastError.message);browserAdapter._ExecuteScriptCode(a,g,function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);shoptoolbar._PostShowNotifications(a)})})})})}}).catch(function(a){console.error(a)})})}}else d()}))})}})},_PostShowNotifications:function(a){var b=tabDataCollection._Get(a);if(shoptoolbar._IsButton){if(b=ButtonApp._GetButtonStorage(b._CurrentId))b.dialog.show=!0}else{if(b.forceHideNotify)chrome.tabs.get(a,function(a){chrome.runtime.lastError||
browserAdapter._ExecuteScriptCode(a.id,"if (typeof $ !== 'undefined'){ if ($('#BFRLsliderIframe') && $('#BFRLsliderIframe').length > 0) $('#BFRLsliderIframe').notifybar('hideTimeout'); }",function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message)})}),delete b.forceHideNotify;else{var c=6E4;switch(b._LastNotifyState){case shoptoolbar._NotifyState._LoginToClaimCashback:c=-1}0<=c?(b.dropdownTimeout&&clearTimeout(b.dropdownTimeout),b._LastNotifyState!==shoptoolbar._NotifyState._AskJoinCashback&&
b._LastNotifyState!==shoptoolbar._NotifyState._AskJoinTopCoupon&&(b.dropdownTimeout=setTimeout(function(){chrome.tabs.get(a,function(b){var c=tabDataCollection._Get(a);chrome.runtime.lastError||(c._IgnorePreviousSetTimeouts||browserAdapter._ExecuteScriptCode(b.id,"if (typeof $ !== 'undefined'){ if ($('#BFRLsliderIframe') && $('#BFRLsliderIframe').length > 0) $('#BFRLsliderIframe').notifybar('hideTimeout'); }",function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message)}),delete c._IgnorePreviousSetTimeouts)})},
c))):b.dropdownTimeout&&clearTimeout(b.dropdownTimeout);0>c&&(b._IgnorePreviousSetTimeouts=!0)}delete b._LastNotifyState}},_IncrementFailureMode:function(){var a=BfrlTool.Prefs.FailureMode;shoptoolbar._FailureCount=shoptoolbar._FailureCount||0;++shoptoolbar._FailureCount;shoptoolbar._FailureModeReset||(shoptoolbar._FailureModeReset=setTimeout(function(){delete shoptoolbar._FailureModeReset;shoptoolbar._FailureCount=0},a.IntervalMS));shoptoolbar._FailureCount>=a.Threshold&&!shoptoolbar._FailureMode&&
(shoptoolbar._FailureMode=setTimeout(function(){delete shoptoolbar._FailureMode;shoptoolbar._FailureCount=0},a.DurationMS))},_GetNodeSnapShotFactory:function(a){return function(b){return a.evaluate(b,a.documentElement,function(){return"http://tempuri.org/"},XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null)}},GetNodeFactory:function(a){return function(b){b=a.evaluate(b,a.documentElement,function(){return"http://tempuri.org/"},XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return null===b?null:
b}},GetNodeTextContentFactory:function(a){return function(b){b=shoptoolbar.GetNodeFactory(a)(b);return null===b?null:b.textContent}},_ReadRetailerDigestPartial:function(a,b){var c=JSON.parse(a);BfrlTool.BrowserStorage.PrivacyPrompt.then(function(a){var d=c.DigestOffset,f=c.DigestURL;a?(BfrlTool.BrowserStorage.IsShopper=!1,shoptoolbar._LoadURI_JSON_GET(f,function(a){localStorage.bf_downloadedDigest=a;localStorage.bf_downloadedDigestOffset=d;shoptoolbar._ReadRetailerDigestStatic(JSON.parse(a),d,b)})):
BfrlTool.StorageReader(c.UserName,"UserName").then(function(a){BfrlTool.BrowserStorage.UserName=c.UserName;BfrlTool.BrowserStorage.UserToken=c.UserToken;BfrlTool.BrowserStorage.IsShopper=!c.IsNonShopper;localStorage.SearchMarkup="$a";BfrlTool.Prefs.Guest=BfrlTool.Prefs.UserName&&"null"!==BfrlTool.Prefs.UserName?-1!==BfrlTool.Prefs.UserName.toLowerCase().indexOf("invalid",BfrlTool.Prefs.UserName.length-7):!0;shoptoolbar._LoadURI_JSON_GET(f,function(a){localStorage.bf_downloadedDigest=a;localStorage.bf_downloadedDigestOffset=
d;shoptoolbar._ReadRetailerDigestStatic(JSON.parse(a),d,b)});c.UserName!==a?shoptoolbar._SetDefaultPreferences(!1):BfrlTool.BrowserStorage.TurnOffNotifications.then(function(a){BfrlTool.Prefs.TurnOffNotifications=a});shoptoolbar._GetFavorites()})})},_ReadRetailerDigestStatic:function(a,b,c){var e=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);return b.join("\n")};localStorage.dbDate=a.Now.substr(0,11)+b;localStorage.GroceryUrl=a.GroceryUrl;localStorage.couponredirect=a.CouponRedirectFormat;
localStorage.RedirectRegex=a.RedirectFormat;localStorage.RedirectFormat=a.RedirectFormat.split("?")[0].replace("\\","").replace("\\","").replace("\\","");localStorage.LogoFormat=a.LogoFormat;localStorage.SuppressLengthMS=a.SuppressLengthMS;localStorage.TopBarLengthMS=a.TopBarLengthMS;localStorage.WhiteListRegex=a.WhiteListRegex;localStorage.StartupAbeyanceSeconds=a.StartupAbeyanceSeconds||30;BfrlTool.Prefs.GroceryCount=a.GroceryCount;BfrlTool.Prefs.RestaurantCount=a.RestaurantCount;BfrlTool.Prefs.WeeklyAdCount=
a.WeeklyAdCount;BfrlTool.Prefs.BlackList.Query=e(a.QueryBlackList);BfrlTool.Prefs.BlackList.Canonical=e(a.CanonicalBlackList);BfrlTool.Prefs.BlackList.Regex=e(a.RegexBlackList);a.SearchInjectionBlacklist&&BfrlTool._RetailerList._MapSearchInjectionBlackList(a.SearchInjectionBlacklist);BfrlTool._RetailerList._MapRetailerList(a.Retailers);BfrlTool._RetailerList._MapRestaurantList(a.Restaurants);shoptoolbar._RefreshData();c()},_MatchUrlToStoreRegex:function(a){return a.match(localStorage.RedirectRegex)||
a.match(localStorage.RedirectRegex.replace("http","https"))||a.match(/https?:\/\/r\.befrugal\.com\/\?rtr=(\d+)/)||a.match(/https?:\/\/www\.befrugal\.com\/coupons\/cashbacksignuppopup\/nu\/\?rtr=(\d+)/)},_MatchUrlToCouponRegex:function(a){return a.match(localStorage.couponredirect.replace("?","\\?")+"([^&]*)")},_MatchUrlToWeeklyAdRegex:function(a){return a.match(localStorage.couponredirect.replace("?","\\?").replace("c=","wky=")+"([^&]*)")},_IsDatabaseOK:function(){if(shoptoolbar._ToolbarVersion&&
localStorage.DigestVersion!==shoptoolbar._ToolbarVersion||!localStorage.bf_downloadedDigest||!localStorage.bf_downloadedDigestOffset)return!1;var a=window.localStorage.getItem("dbDate");if(null===a)return!1;var b=new Date;b.setTime(Date.parse(a)+864E5);return b>new Date},LoadURI:function(a,b){var c=new XMLHttpRequest;c.open("GET",a);c.onload=function(a){return b(c.responseXML)};try{c.overrideMimeType("application/xml")}catch(g){}try{c.send(null)}catch(g){}},_LoadURI_JSON_POST:function(a,b,c){var e=
new XMLHttpRequest;e.open("POST",a,!0);e.setRequestHeader("Content-Type","application/x-www-form-urlencoded");e.onload=function(a){200===e.status?c(e.responseText):shoptoolbar._RetailerDownloadsInProgress=[]};e.onerror=function(a){shoptoolbar._RetailerDownloadsInProgress=[]};try{e.overrideMimeType("application/json")}catch(d){}try{e.send(b)}catch(d){shoptoolbar._RetailerDownloadsInProgress=[]}},_LoadURI_JSON_GET:function(a,b){var c=function(a){var c=new XMLHttpRequest;c.open("GET",a);c.onload=function(a){return b(c.responseText)};
try{c.overrideMimeType("application/json")}catch(f){}try{c.send()}catch(f){}};a.startsWith(shoptoolbar.APISite)?BfrlTool.BrowserStorage.PrivacyPrompt.then(function(b){b?c(a):(b=0<=a.indexOf("?")?"&toolbarversion":"?toolbarversion",c(a+b+shoptoolbar._ToolbarVersion))}):c(a)},_OnStateChange:function(a,b,c,g,d){a||(a=-1);tabDataCollection._AddHistoryEntry(a,b);var f=tabDataCollection._Get(a),e=shoptoolbar._MatchUrlToStoreRegex(b),m=shoptoolbar._MatchUrlToCouponRegex(b);shoptoolbar._isIneligibleLink(b)||
(e?(f._RedirectReason=shoptoolbar._NotifyState._RedirectCashback,f._Justredirected=parseInt(e[1]),f._ShowCoupons=!0):m&&((e=parseUriWrapper.parseUri(b))&&e.queryKey&&e.queryKey.tlbon&&e.queryKey.tlbrid?(f._RedirectReason=shoptoolbar._NotifyState._RedirectAnyCoupon,f._Justredirected=e.queryKey):(f._RedirectReason=shoptoolbar._NotifyState._RedirectTopCoupon,f._Justredirected=parseInt(m[1]))));m=c&&(shoptoolbar._IsPaidAdword(b)||g&&shoptoolbar._IsPaidAdword(g));e=f._PaidAdHttpRequest&&!f._PaidAdHttpRequest.Completed;
var n=shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Edge&&e;e=c&&e&&f._PaidAdHttpRequest.id===c||n;if(m||e)f._PaidAdHttpRequest={id:c,url:b,retailerId:e?f._PaidAdHttpRequest.retailerId:-1,suppressed:e?f._PaidAdHttpRequest.suppressed:!1,Completed:!1};!f._Justredirected&&g&&!d&&shoptoolbar._ShouldSuppressLink(g,a)&&(m||e?f._PaidAdHttpRequest.suppressed=!0:f._CashbackActivated||suppressionHistory._IsDestinationOurs(g)||(suppressionHistory._AddEntry(a,g),f._AttachParamNextNav=!1,AutoApplyApp._ResetState(!0)));
f._Justredirected||d||!shoptoolbar._ShouldSuppressLink(b,a)||(m||e?f._PaidAdHttpRequest.suppressed=!0:suppressionHistory._IsDestinationOurs(b)||(suppressionHistory._AddEntry(a,b),f._AttachParamNextNav=!1,AutoApplyApp._ResetState(!0)));suppressionHistory._SyncSuppression()},_RedirectIFrame:function(a,b,c){c||(c=!1);var e=tabDataCollection._Get(b);e._AttachParamNextNav=!0;shoptoolbar._ReadOrGetRetailerInfo(e._CurrentId,e,function(d){if(d.CashbackRate){e._AutoRedirecting||(e._GaveClick=e._CurrentId);
if(e._UseIframe)console.warn("Using the iframe is no longer available, please use new tab or new window");else{var f=function(){var d="undefined"!==typeof window&&"undefined"!==typeof window.navigator&&"undefined"!==typeof window.navigator.userAgent;newTab=c||d&&window&&window.Navigator&&window.navigator.userAgent&&/mac|osx|os x/i.test(window.navigator.userAgent);if(shoptoolbar.NewTabSettings.UseNewTabCashback||newTab)browserAdapter.CreateTab(a,function(a){a&&a.id&&(tabDataCollection._Get(a.id)._RedirectCashbackNewTab=
!0,shoptoolbar.newCashbackTab(a.id))},!0);else{var f={url:a};shoptoolbar.NewTabSettings.CashbackPostionDefault||(f.top=20456,f.left=20456,f.width=1,f.height=1);browserAdapter.GetTab(b,function(a){browserAdapter.CreateNewWindow(f,function(b){if(b&&b.tabs){b=b.tabs[0].id;var c=tabDataCollection._Get(b);c._RedirectCashbackNewTab=!0;c._CurrentId=e._CurrentId;shoptoolbar.newCashbackTab(b);browserAdapter.UpdateWindow(a.windowId,{focused:!0})}})})}};try{browserAdapter.GetActiveTab(!0,function(b){b&&b.url&&
b.id?shoptoolbar._ShouldSuppressLink(b.url,b.id)&&!suppressionHistory._IsDestinationOurs(b.url)?browserAdapter.UpdateTab(b.id,a):f():f()})}catch(h){f()}}shoptoolbar._IncrementRecentRedirection(e._CurrentId);suppressionHistory._CleanTab(b)}})},_NavigatedOffRetailer:function(a,b){b._CurrentRequest&&b._CurrentRequest.fromRedirector||(!b._RedirectCashbackNewTab&&0<=AutoApplyApp._activeTabs.indexOf(a)&&AutoApplyApp._ResetState(!0),b._CashbackActivated&&(b._LastActivatedRetailer=b._CurrentId),delete b._CurrentId,
delete b._RetailerInfo,shoptoolbar._ClearCashbackActivation(b,"_NavigatedOffRetailer"))},_ClearCashbackActivation:function(a,b){delete a._CashbackActivated;delete a._AttachParamNextNav;delete a._CashbackActivationChangedTime;"_NavigatedOffRetailer"!==b&&delete a._LastActivatedRetailer},_CheckOurDomain:function(a){return-1<a.indexOf("befrugal.com")||-1<a.indexOf("couponviewer.com")||-1<a.indexOf("extension://")&&(/befrugal/gi.test(a)||/befrugal/gi.test(browserAdapter._GetRuntimeID()))?!0:!1},_CheckWelcomePage:function(a){return-1<
a.indexOf("befrugal.com/home")||-1<a.indexOf("befrugal.com/couponviewer")||-1<a.indexOf("befrugal.com/addon/installationcomplete")&&!shoptoolbar._IsButton?-1<a.indexOf("?tbins=1")?!1:!0:!1},SetBadgeIcon:function(){browserAdapter.GetActiveTab(!0,function(a){var b=!1,c=tabDataCollection._Get(a.id),g=suppressionHistory._IsSuppressed(a.id,a.url);g&&(c._AutoRedirecting||shoptoolbar._TrackRedirectURL)&&(g=!1);if(!g&&c._CurrentId&&c._RetailerInfo&&"0"!==c._RetailerInfo.CouponCount.toString())b=!0;else{if(c._CurrentId&&
!g){shoptoolbar._ReadOrGetRetailerInfo(c._CurrentId,c,function(a){b=a?!0:!1;browserAdapter._SetIcon(b?shoptoolbar.ActiveIcon:shoptoolbar.InactiveIcon)});return}if(c._CurrentId){shoptoolbar._ReadOrGetRetailerInfo(c._CurrentId,c,function(c){b=c&&(""!==c.CashbackRate||shoptoolbar._CheckOurDomain(a.url))?!0:!1;browserAdapter._SetIcon(b?shoptoolbar.ActiveIcon:shoptoolbar.InactiveIcon)});return}b=shoptoolbar._TourMode||c._WelcomePage?!0:shoptoolbar._CheckOurDomain(a.url)?!0:!1}browserAdapter._SetIcon(b?
shoptoolbar.ActiveIcon:shoptoolbar.InactiveIcon)})},_GetCouponCount:function(a){if(!a||!a._CouponBlob||!a._CouponBlob.Coupons)return 0;for(var b=0,c=[],g=0;g<a._CouponBlob.Coupons.length;g++)-1===c.indexOf(a._CouponBlob.Coupons[g].Code)&&(c.push(a._CouponBlob.Coupons[g].Code),b++);return b+(a._CouponBlob.AdditionalCodes?a._CouponBlob.AdditionalCodes.length:0)},_SetBadge:function(a,b){chrome.tabs.query({active:!0,currentWindow:!0},function(c){if(c&&0!==c.length){var e=c[0],d=e.id,f=tabDataCollection._Get(d),
h=!1,m="";if(!(f._CurrentRequest&&f._CurrentRequest.fromRedirector&&!f._RetailerInfo||f._SkipBadge)){c=0<tabDataCollection._TabData.filter(function(a){return f&&f._CurrentId&&a._CurrentId&&a._CurrentId.toString()===f._CurrentId.toString()&&!!a._CashbackActivated}).length;var n=suppressionHistory._IsSuppressed(d,e.url);if(n&&(f._AutoRedirecting||shoptoolbar._TrackRedirectURL))n=!1;else if(n){shoptoolbar._ClearCashbackActivation(f,"_SetBadge");for(var r=tabDataCollection._TabData.filter(function(a){return f&&
f._CurrentId&&a._CurrentId&&a._CurrentId.toString()===f._CurrentId.toString()}),v=0;v<r.length;v++)shoptoolbar._ClearCashbackActivation(r[v],"_SetBadge")}else f._CashbackActivated&&f._CurrentId&&(suppressionHistory._CleanTab(d),f._WasActivated=f._CurrentId.toString());!f._AutoApplyActivity||!f._AutoApplyActivity.retailerId||f._RetailerInfo&&f._AutoApplyActivity.retailerId==f._RetailerInfo.retalierId||delete f._AutoApplyActivity;var t=function(a){f._AttachParamNextNav||f._CurrentRequest&&f._CurrentRequest._Focused||
(a||n?(ButtonApp.HideDialog(e),ButtonApp.HideButton(e)):ButtonApp.InitButton(e,f))},u=function(){AutoApplyApp._StartApplication(d,e.url,n,function(a){t(a)})};if(!n&&f._CurrentId&&f._RetailerInfo&&"0"!==f._RetailerInfo.CouponCount.toString()&&shoptoolbar._GetNoCashBackExtension())m=f._RetailerInfo.CouponCount.toString(),h=!0,a?u():t(!1);else if(!n&&f._CurrentId&&f._RetailerInfo&&"0"!==f._RetailerInfo.CouponCount.toString()){c=shoptoolbar._GetCouponCount(f);if(0!=c)m=c.toString();else if(f._RetailerInfo.CashbackRate&&
0<f._RetailerInfo.CashbackRate.length){c=f._RetailerInfo.CashbackRate.split(" ");var x;for(r=0;r<c.length-1;r++)c[r].includes("%")?x=r:c[r].includes("$")&&(x=r);m="undefined"==x?f._Offers.length.toString():c[x]}else m=f._Offers.length.toString();h=!0;a?u():t(!1)}else{if(f._CurrentId&&!n){shoptoolbar._ReadOrGetRetailerInfo(f._CurrentId,f,function(c){h=!0;var d=f._RetailerInfo.CouponCount.toString(),e=!1;if(c.CashbackRate&&0<c.CashbackRate.length){e=f._CashbackActivated;c=f._RetailerInfo.CashbackRate.split(" ");
for(var g,A=0;A<c.length-1;A++)c[A].includes("%")&&(g=A);m="undefinded"==g?"0"!==d?d:f._CashbackActivated?shoptoolbar.CheckmarkCharacter:m:c[g]}browserAdapter._SetIconBackgroundColor(e);browserAdapter._SetIcon(shoptoolbar.ActiveIcon);browserAdapter._SetBadgeText(m);a?u():t(!1);b&&b()});return}if(f._CurrentId){c&&AutoApplyApp._SendSuppressionMessage(f,d);shoptoolbar._ReadOrGetRetailerInfo(f._CurrentId,f,function(c){h=""!==c.CashbackRate||shoptoolbar._CheckOurDomain(e.url)?!0:!1;shoptoolbar.Config.UpdateRequired&&
(m="1");browserAdapter._SetIcon(h?shoptoolbar.ActiveIcon:shoptoolbar.InactiveIcon);browserAdapter._SetBadgeText(m);a?u():t(!1);b&&b()});return}shoptoolbar._TourMode||f._WelcomePage?(h=!0,delete f._WelcomePage):h=shoptoolbar._CheckOurDomain(e.url)?!0:!1}0===m.length&&shoptoolbar.Config.UpdateRequired&&!/chrome\.google\.com\/webstore\//i.test(e.url)&&(m="1",h=!0);browserAdapter._SetIcon(h?shoptoolbar.ActiveIcon:shoptoolbar.InactiveIcon);h||n||!shoptoolbar._BefrugalEvents.IsBonusCashBackActive?(browserAdapter._SetBadgeText(m),
x=!1,f._RetailerInfo&&f._RetailerInfo.CashbackRate&&0<f._RetailerInfo.CashbackRate.length&&(x=f._CashbackActivated),browserAdapter._SetIconBackgroundColor(x)):(browserAdapter._SetBadgeText("$$"),browserAdapter._SetIconBackgroundColorEvent());b&&b()}}})},_RefreshData:function(){BfrlTool.BrowserStorage.UserToken.then(function(a){a&&(shoptoolbar.UTQueryString="&bfuser="+a+"&toolbarversion="+shoptoolbar._ToolbarVersion);shoptoolbar._TopBarLengthInterval=parseInt(localStorage.TopBarLengthMS)||shoptoolbar._TopBarLengthInterval;
shoptoolbar._LoadBlackLists();shoptoolbar._GetApplicationSettings()})},_RefreshDigest:function(){shoptoolbar._ReadRetailerDigestStatic(JSON.parse(localStorage.bf_downloadedDigest),localStorage.bf_downloadedDigestOffset,function(){})},_PostSoapURI:function(a,b,c,g){var d=new XMLHttpRequest;d.open("POST",a);d.onload=function(a){return b(d.responseXML)};try{d.overrideMimeType("application/xml"),d.setRequestHeader("Content-Type","application/soap+xml; charset=utf-8")}catch(f){}try{d.send('<?xml version="1.0" encoding="utf-8"?><soap12:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap12="http://www.w3.org/2003/05/soap-envelope"><soap12:Body><'+
c+' xmlns="http://tempuri.org/">'+g+"</"+c+"></soap12:Body></soap12:Envelope>")}catch(f){}},_GetAccountFromEmail:function(a,b){a=shoptoolbar.Format("https://{0}/toolbar/toolbarWS/ws.asmx/GetAccountFromEmail?utmSource=&toolbarversion={1}&emailaddress={2}",shoptoolbar.Site,shoptoolbar._ToolbarVersion,encodeURIComponent(a));shoptoolbar.LoadURI(a,function(a){var c=function(b){b=a.evaluate(b,a.documentElement,function(){return"http://tempuri.org/"},XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;
return null===b?null:b.textContent}("/x:string");c&&(BfrlTool.BrowserStorage.UserToken=c,BfrlTool.Prefs.Guest=!1,shoptoolbar._RegenDB());b(!!c)})},_LogNotifyBar:function(a,b,c){if("true"===localStorage.YellowBarAnalytics&&!shoptoolbar._IsButton){var e="";c&&0<c.length&&(e=$.map(c,function(a){return a?"<string>"+a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</string>":null}).join("\n"));BfrlTool.BrowserStorage.UserToken.then(function(c){c=shoptoolbar.Format("<usertoken>{0}</usertoken><toolbarversion>{1}</toolbarversion><reason>{2}</reason><retailerid>{3}</retailerid><urls>{4}</urls>",
c,shoptoolbar._ToolbarVersion,a,b,e);shoptoolbar._PostSoapURI("https://"+shoptoolbar.Site+"/toolbar/toolbarws/ws.asmx",function(){},"NotifyActivity",c)})}},_IsRedirectionUrl:function(a){return(a=parseUriWrapper.parseUri(a))&&a.host&&("r.befrugal.com"===a.host.toLowerCase()||"r2.befrugal.com"===a.host.toLowerCase())},GetInfoFromMerchantDigest:function(a,b){shoptoolbar.LoadURI("https://www.befrugal.com/searchoffers/export/export.asmx/GetCampaignMerchants",function(c){c=c.getElementsByTagName("Export_Campaign_Merchants");
for(var e=0,d="",f="",h=0;h<c.length;h++){var m=c[h].getElementsByTagName("internalName")[0].textContent;if(a===m){e=c[h].getElementsByTagName("retailerId")[0].textContent;d=c[h].getElementsByTagName("name")[0].textContent;f=c[h].getElementsByTagName("imageUrl")[0].textContent;break}}b(d,e,f)})},_GetInstallStoreInfo:function(a,b){""===a&&(a="mcdonalds");shoptoolbar.GetInfoFromMerchantDigest(a,b)},_NotifyInstall:function(){BfrlTool.BrowserStorage.UserToken.then(function(a){var b=new XMLHttpRequest;
b.open("GET","https://"+shoptoolbar.Site+"/toolbar/toolbarWS/ws.asmx/Notify?usertoken="+a+"&toolbarversion="+shoptoolbar._ToolbarVersion+"&reason=Install");b.overrideMimeType("text/plain");try{b.send(null)}catch(e){}shoptoolbar._SendNotifyDigest=!1;shoptoolbar._SendNotifyInstall=!1})},_CheckRequestedPayment:function(a){BfrlTool.BrowserStorage.UserToken.then(function(b){b=shoptoolbar.Format("https://{2}/toolbar/toolbarWS/ws.asmx/HasRecentPayment?usertoken={0}&toolbarversion={1}",b,shoptoolbar._ToolbarVersion,
shoptoolbar.Site);shoptoolbar.LoadURI(b,function(b){"true"===shoptoolbar.GetNodeTextContentFactory(b)("/x:BeFrugalWSResult/x:Success")?a(!0):a(!1)})})},_ShowToastMessage:function(a,b,c,g,d,f,h){!g||0>=g.length||"2105"===b.toString()||(b=tabDataCollection._Get(a),shoptoolbar.SuppressNotificationForRetailer(b)||(shoptoolbar.RecordNotificationActivation(b,c),shoptoolbar._GetNoCashBackExtension(function(b){if(!b){h||(h=function(){});var c=function(a,b,c){b=a.indexOf(b)+b.length;return a.substring(b,a.indexOf(c,
b))},e=function(a){shoptoolbar._LoadFilePromise(d).then(function(b){var d=c(b,"\x3c!--CSS START--\x3e","\x3c!--CSS END--\x3e"),e=c(b,"\x3c!--TOAST START--\x3e","\x3c!--TOAST END--\x3e");browserAdapter._ExecuteScript(a,"js/newToast.js",function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);var b="let notifyCss = document.createElement('link');notifyCss.setAttribute('rel', 'stylesheet');"+("notifyCss.setAttribute('href', '"+chrome.runtime.getURL("/fonts/Roboto.css")+"');")+
"notifyCss.setAttribute('type', 'text/css');var head = document.querySelector('head');head.insertBefore(notifyCss, head.firstChild);var d = document.getElementById('toast_div'); ";b+="d.setAttribute('xcb', '"+g+"'); ";b+="d.setAttribute('xlogo', '"+chrome.runtime.getURL("toast_icon.png")+"'); ";b+="d.innerHTML = `"+DOMPurify.sanitize(d+e.replace(/\s+/gi," "),{FORCE_BODY:!0})+"`;";browserAdapter._ExecuteScriptCode(a,b,function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);
f&&""!==f&&browserAdapter._ExecuteScript(a,f,function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);h()})})})})};setTimeout(function(){a?e(a):chrome.tabs.query({active:!0,currentWindow:!0},function(a){e(a[0].id)})},500)}})))},_IsRetailerOnHideNotificationsList:function(a){if(!a)return!1;var b=BfrlTool.Prefs.TurnOffNotifications;if(b&&0<b.length){b=JSON.parse(b);for(var c in b)if(c.toString()===a.toString())return!0}return!1},_IgnoreLookupDomain:function(a){return-1<a.indexOf("emjcd.com")||
-1<a.indexOf("dotomi.com")||-1<a.indexOf("befrugal.com")?!0:!1},_WakeUpCouponBadge:function(a){if(a&&a._RetailerInfo){browserAdapter._SetIcon(shoptoolbar.ActiveIcon);if(0<parseInt(a._RetailerInfo.CouponCount)){var b=0,c=[];if(a._CouponBlob.Coupons){for(var g=0;g<a._CouponBlob.Coupons.length;g++)-1===c.indexOf(a._CouponBlob.Coupons[g].Code)&&(c.push(a._CouponBlob.Coupons[g].Code),b++);c=a._CouponBlob.AdditionalCodes?a._CouponBlob.AdditionalCodes.length:0;g=b+c}if(0!=g)text=g.toString();else if(a._RetailerInfo.CashbackRate){b=
a._RetailerInfo.CashbackRate.split(" ");var d;for(c=0;c<b.length-1;c++)b[c].includes("%")&&(d=c);text=b[d]}browserAdapter._SetBadgeText(text)}else browserAdapter._SetBadgeText(shoptoolbar.CheckmarkCharacter);a._RetailerInfo.CashbackRate&&browserAdapter._SetIconBackgroundColor(!0)}else shoptoolbar._SetBadge(!1)},FetchBanners:function(a){BfrlTool.BrowserStorage.UserToken.then(function(b){var c=shoptoolbar.Format("https://{0}/wssimple.asmx/GetCarouselBanners",shoptoolbar.Site.replace("www","tbwsjs"));
shoptoolbar.FetchJson(c,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:shoptoolbar.Format("UserToken={0}&toolbarversion={1}",b,shoptoolbar.GetToolbarVersion())}).then(function(b){Array.isArray(b)&&0<b.length&&a(b)})})},_CheckBefrugalEvents:function(){shoptoolbar._BefrugalEvents.IsInitialized||shoptoolbar.FetchBanners(function(a){for(var b=0;b<a.length;b++){var c=a[b];shoptoolbar._BefrugalEvents.GetActive(c.Type,c.TypeName)}shoptoolbar._BefrugalEvents.IsInitialized=
!0})},_SetupApplicationSettings:!1,_DefaultPreferences:{TurnOffNotifications:"",AutomaticActivation:!0,get AllowCashbackInjection(){return!1},AllowSubmissions:!0,get ConflictAlert(){return shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome},AppDisabledByUs:[]},_ApplicationSettings:{CashbackLostSetting:{EnabledForAll:!1,EnabledForRequireClick:!1},SelfDisabledRegex:"",PaidAdRegex:"(googleadservices.com|google.com|yahoo.com|bing.com|ask.com|aol.com)"},_SetDefaultPreferences:function(a){a?(BfrlTool.BrowserStorage.TurnOffNotifications=
BfrlTool.Prefs.TurnOffNotifications,BfrlTool.BrowserStorage.AutomaticActivation=BfrlTool.Prefs.AutomaticActivation,BfrlTool.BrowserStorage.AllowCashbackInjection=BfrlTool.Prefs.AllowCashbackInjection,BfrlTool.BrowserStorage.AllowSubmissions=BfrlTool.Prefs.AllowSubmissions,BfrlTool.BrowserStorage.InstallDate=BfrlTool.Prefs.InstallDate,BfrlTool.BrowserStorage.ConflictAlert=BfrlTool.Prefs.ConflictAlert,BfrlTool.BrowserStorage.AppDisabledByUs=BfrlTool.Prefs.AppDisabledByUs,shoptoolbar._GetRestaurantBonusEligibility(function(a){BfrlTool.BrowserStorage.BonusEligibility=
a&&a.Eligible?a.RetailerID:0})):(BfrlTool.BrowserStorage.TurnOffNotifications=shoptoolbar._DefaultPreferences.TurnOffNotifications,BfrlTool.BrowserStorage.AutomaticActivation=shoptoolbar._DefaultPreferences.AutomaticActivation,BfrlTool.BrowserStorage.AllowCashbackInjection=shoptoolbar._DefaultPreferences.AllowCashbackInjection,BfrlTool.BrowserStorage.AllowSubmissions=shoptoolbar._DefaultPreferences.AllowSubmissions,BfrlTool.BrowserStorage.InstallDate=(new Date).toUTCString(),BfrlTool.BrowserStorage.ConflictAlert=
shoptoolbar._DefaultPreferences.ConflictAlert,BfrlTool.BrowserStorage.AppDisabledByUs=shoptoolbar._DefaultPreferences.AppDisabledByUs,shoptoolbar._GetRestaurantBonusEligibility(function(a){a&&a.Eligible&&(BfrlTool.BrowserStorage.BonusEligibility=a.RetailerID)}))},_GetBackupRedirectionRulesForTempRetailer:function(a){shoptoolbar._LoadURI_JSON_GET(shoptoolbar.APISite+"/wssimplenonshopper.asmx/GetApplicationSettings",function(b){if(b&&0<b.length&&(b=JSON.parse(b))&&b.BackupRedirectionRules){b=b.BackupRedirectionRules.filter(function(b){return b.RetailerID===
a});for(var c=0;c<b.length;++c){var g=b[c];(BfrlTool._RetailerList._ContainsRetailer(g.RetailerID)||BfrlTool._RetailerList._ContainsRestaurant(g.RetailerID))&&BfrlTool._RetailerList._AddRetailer(g.Domain,g,g.RetailerID)}}})},_GetApplicationSettings:function(a){shoptoolbar._SetupApplicationSettings&&!a||BfrlTool.BrowserStorage.UserToken.then(function(b){BfrlTool.BrowserStorage.InstallDate.then(function(c){c&&0!==c.length||(c=(new Date).toUTCString(),BfrlTool.BrowserStorage.InstallDate=c);BfrlTool.BrowserStorage.PrivacyPrompt.then(function(e){var d=
shoptoolbar.APISite+"/wssimple.asmx/GetApplicationSettings",f=function(a){return!e||shoptoolbar._GetNoCashBackExtension()&&shoptoolbar.GetBrowser()!==shoptoolbar.Browsers.Firefox?a:""},g=!e||shoptoolbar._GetNoCashBackExtension()&&shoptoolbar.GetBrowser()!==shoptoolbar.Browsers.Firefox?shoptoolbar.Format("&installDate={0}",c):"";f=shoptoolbar.Format("UserToken={0}&toolbarversion={1}{2}",f(b),f(shoptoolbar._ToolbarVersion),g);shoptoolbar.FetchJson(d,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},
body:f}).then(function(b){if(b&&(shoptoolbar._SetupApplicationSettings=!0,"undefined"!==typeof b.NeedsUpdate&&(shoptoolbar.Config.UpdateRequired=b.NeedsUpdate),"undefined"!==typeof b.UpdateUrl&&(shoptoolbar.Config.UpdateUrl=b.UpdateUrl),"undefined"!==typeof b.DailyUpdateReminder&&(shoptoolbar.Config.DailyUpdateReminder=b.DailyUpdateReminder),"undefined"!==typeof b.DailyUpdateMainImageStr&&(shoptoolbar.Config.DailyReminderImageMain=b.DailyUpdateMainImageStr),"undefined"!==typeof b.DailyUpdateButtonImageStr&&
(shoptoolbar.Config.DailyReminderImageButton=b.DailyUpdateButtonImageStr),shoptoolbar.Config.UpdateRequired&&(browserAdapter._SetBadgeText("1"),browserAdapter._SetIcon(shoptoolbar.ActiveIcon),browserAdapter._SetIconBackgroundColor(!1)),"undefined"!==typeof b.IsButtonInstalled&&(shoptoolbar.Config.IsButtonInstalled=b.IsButtonInstalled),!a)){b.UseBeforeRequest&&(shoptoolbar.UseBeforeRequest=b.UseBeforeRequest&&!shoptoolbar._IsButton);b.AllowDisablingNotifications&&(shoptoolbar.AllowDisablingNotifications=
b.AllowDisablingNotifications);if(b.BackupRedirectionRules)for(var c=0;c<b.BackupRedirectionRules.length;++c){var d=b.BackupRedirectionRules[c];(BfrlTool._RetailerList._ContainsRetailer(d.RetailerID)||BfrlTool._RetailerList._ContainsRestaurant(d.RetailerID))&&BfrlTool._RetailerList._AddRetailer(d.Domain,d,d.RetailerID)}b.AutoRedirectionSettings&&(shoptoolbar.AutoRedirectSettings=b.AutoRedirectionSettings,b.AutoRedirectionSettings.ResetUserSetting&&b.AutoRedirectionSettings.Enabled?localStorage.lastRedirectionReset&&
localStorage.lastRedirectionReset===shoptoolbar._ToolbarVersion||(localStorage.lastRedirectionReset=shoptoolbar._ToolbarVersion,BfrlTool.BrowserStorage.AutomaticActivation=!0):!b.AutoRedirectionSettings.ResetUserSetting||b.AutoRedirectionSettings.Enabled||localStorage.lastRedirectionReset&&localStorage.lastRedirectionReset===shoptoolbar._ToolbarVersion||(localStorage.lastRedirectionReset=shoptoolbar._ToolbarVersion,shoptoolbar.AutoRedirectSettings.Enabled=!0,shoptoolbar.AutoRedirectSettings.HideToolbarSetting=
!1,shoptoolbar.AutoRedirectSettings.ForceOn=!1,BfrlTool.BrowserStorage.AutomaticActivation=!1));b.UseNewTabCashback||"undefined"===typeof b.UseNewTabCashback||(shoptoolbar.NewTabSettings.UseNewTabCashback=!1);b.CashbackPostionDefault||"undefined"===typeof b.CashbackPostionDefault||(shoptoolbar.NewTabSettings.CashbackPostionDefault=!1);"undefined"!==typeof b.CashbackLostDialog&&b.CashbackLostDialog&&(shoptoolbar._ApplicationSettings.CashbackLostSetting=b.CashbackLostDialog);"undefined"!==typeof b.SelfDisabledRegex&&
b.SelfDisabledRegex&&(shoptoolbar._ApplicationSettings.SelfDisabledRegex=b.SelfDisabledRegex);"undefined"!==typeof b.PaidAdSettingsRegex&&b.PaidAdSettingsRegex&&(shoptoolbar._ApplicationSettings.PaidAdRegex=b.PaidAdSettingsRegex);"undefined"!==typeof b.PrivacyDialog&&b.PrivacyDialog&&(shoptoolbar.Config.PrivacyPrompt.CounterEnabled=!b.PrivacyDialog.HardGate,shoptoolbar.Config.PrivacyPrompt.Days=b.PrivacyDialog.SoftGateDayCount);"undefined"!==typeof b.PaidAdSettingsRegex&&b.PaidAdSettingsRegex&&(shoptoolbar._ApplicationSettings.PaidAdRegex=
b.PaidAdSettingsRegex)}})})})})},_GetFavorites:function(){BfrlTool.BrowserStorage.UserToken.then(function(a){var b=shoptoolbar.Format("https://{0}/wssimple.asmx/GetFavoriteRetailers",shoptoolbar.Site.replace("www","tbwsjs"));shoptoolbar.FetchJson(b,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:shoptoolbar.Format("UserToken={0}&toolbarversion={1}",a,shoptoolbar.GetToolbarVersion())}).then(function(a){a&&(shoptoolbar.Favorites.Favorites=a.Favorites,shoptoolbar.Favorites.RecommendedFavorites=
a.RecommendedFavorites)})})},getIsCashbackNewTab:function(a){return 0<=c.indexOf(a)},newCashbackTab:function(a){c.push(a)},endOfCashbackTab:function(a){a=c.indexOf(a);-1!=a&&c.shift(a,1)},requiresUpdateReminder:function(a){BfrlTool.BrowserStorage.UserToken.then(function(b){shoptoolbar.FetchJson(shoptoolbar.APISite+"/wssimple.asmx/GetRecentActivity",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:shoptoolbar.Format("UserToken={0}&toolbarversion={1}",b,shoptoolbar.GetToolbarVersion())}).then(function(b){(new Promise(function(a){if(b&&
0<b.length){for(var c=[],f=0;f<b.length;f++)c.push({amount:b[f].Amount,retailerName:b[f].Description,preposition:b[f].Preposition});a(c)}else a(!1)})).then(function(b){a(b)})})})},_Init:function(){BfrlTool.BrowserStorage.IsClassic.then(function(a){shoptoolbar._IsButton?shoptoolbar._IsButton=!a:BfrlTool.BrowserStorage.IsClassic=!0;shoptoolbar._Browser===shoptoolbar.Browsers.Chrome?shoptoolbar._Animation._Init("animations/badgeIcons",39):shoptoolbar._Animation._Init("animations/badgeIcons",1);shoptoolbar._IsButton&&
(shoptoolbar.ActiveIcon="../icon48.png",shoptoolbar.InactiveIcon="../grey_icon48.png");shoptoolbar._IsButton&&BfrlTool.BrowserStorage.TourShown.then(function(a){"initial"===a&&(a=function(){var a=/^https?:\/\/www.befrugal.com/i;browserAdapter.GetAllTabs(function(b){var c=b.filter(function(b){return a.test(b.url)});2>b.length&&(!c||0===c.length)&&(shoptoolbar._WelcomeScreenId=0,browserAdapter._ShowWelcomePage())})},shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox?browser.runtime.onStartup.addListener(a):
a())});shoptoolbar._CheckBefrugalEvents();browserAdapter._SetBadgeText("");browserAdapter._SetIcon(shoptoolbar.InactiveIcon);browserAdapter._SetUninstallURL();browserAdapter._AddTabsOnActivatedListener(function(a){3===shoptoolbar._TourRetailer.step&&(shoptoolbar._TourMode=!1,shoptoolbar._WelcomeScreenId&&(browserAdapter._SendTabMessage(shoptoolbar._WelcomeScreenId,{instruction:"CloseTour"}),shoptoolbar._TourRetailer.step=0));0!==shoptoolbar._RefTab.tabId&&a.tabId!==shoptoolbar._RefTab.tabId&&browserAdapter.ActivateTab(shoptoolbar._RefTab.tabId);
0!==shoptoolbar._ChromeStoreTab.tabId&&a.tabId!==shoptoolbar._ChromeStoreTab.tabId&&browserAdapter.ActivateTab(shoptoolbar._ChromeStoreTab.tabId);var b=tabDataCollection._Get(a.tabId);delete b._SkipBadge;b&&b._CurrentId&&b._CashbackActivated?shoptoolbar._SetBadge(!0):shoptoolbar._TourMode||a.tabId===shoptoolbar._WelcomeScreenId||browserAdapter.GetActiveTab(!0,function(a){a&&a.id&&shoptoolbar._TabRefresh(a.id,{status:a.status||"loading",sourceEvent:"TabsOnActivated"},a,!0)})});shoptoolbar._IsDatabaseOK()?
(shoptoolbar._RefreshDigest(),shoptoolbar._GetFavorites()):shoptoolbar._RegenDB();setInterval(tabDataCollection._Sweep,localStorage.SuppressLengthMS);setInterval(function(){shoptoolbar._IsDatabaseOK()||shoptoolbar._RegenDB();null==localStorage.getItem("downloadTime")&&localStorage.setItem("downloadTime",Date.now());var a=localStorage.getItem("downloadTime"),b=localStorage.getItem("appliedTrafficConversion");a=(Date.now()-a)/864E5;3<a&&8>a&&"true"!=b&&(localStorage.setItem("appliedTrafficConversion",
"true"),browserAdapter.CreateTab("https://www.befrugal.com/toolbar/dropdownmenu/"+(shoptoolbar._IsButton?"installedButton.aspx":"installed.aspx"),function(a){a&&a.id&&(tabDataCollection._Get(a.id)._RedirectCashbackNewTab=!0,shoptoolbar.newCashbackTab(a.id))},!0))},6E5);var b=function(a){BfrlTool.Prefs.Guest&&"befrugal.com"===parseUriWrapper.CleanUrl(a)&&BfrlTool.BrowserStorage.PrivacyPrompt.then(function(a){a||BfrlTool.BrowserStorage.UserToken.then(function(a){shoptoolbar.FetchJson(shoptoolbar.Format("https://{0}/wssimple.asmx/GetAccountInfo",
shoptoolbar.Site.replace("www","tbwsjs")),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:shoptoolbar.Format("UserToken={0}&toolbarversion={1}",a,shoptoolbar.GetToolbarVersion())}).then(function(a){a&&a.UserToken&&BfrlTool.StorageReader(a.UserName,"UserName").then(function(b){BfrlTool.BrowserStorage.UserName=a.UserName;BfrlTool.BrowserStorage.UserToken=a.UserToken;BfrlTool.BrowserStorage.IsShopper=!a.IsNonShopper;BfrlTool.Prefs.Guest=BfrlTool.Prefs.UserName&&"null"!==
BfrlTool.Prefs.UserName?-1!==BfrlTool.Prefs.UserName.toLowerCase().indexOf("invalid",BfrlTool.Prefs.UserName.length-7):!0;a.UserName!==b&&shoptoolbar._SetDefaultPreferences(!0)})})})})};setInterval(function(){for(var a=(new Date).getTime()-6E5;0<shoptoolbar._RequestIdHeader.length&&shoptoolbar._RequestIdHeader[0][1]>a;)shoptoolbar._RequestIdHeader.shift()},6E5);BfrlTool.BrowserStorage.TurnOffNotifications.then(function(a){BfrlTool.Prefs.TurnOffNotifications=a});BfrlTool.BrowserStorage.NoMoreInvites.then(function(a){BfrlTool.BrowserStorage.InviteToRate.then(function(b){a||
b||shoptoolbar._CheckRequestedPayment(function(a){a&&(BfrlTool.BrowserStorage.InviteToRate=!0)})})});chrome.webRequest.onSendHeaders.addListener(function(a){-1!==a.tabId&&shoptoolbar._RequestIdHeader.push([a.requestId,(new Date).getTime(),a.tabId])},{urls:["*://*/*"]},["requestHeaders"]);chrome.webRequest.onBeforeRedirect.addListener(function(a){shoptoolbar._IsRedirectionUrl(a.url)&&(shoptoolbar._FailureModeRedirectData[a.requestId]=shoptoolbar._FailureModeRedirectData[a.requestId]||a.url);setTimeout(function(){delete shoptoolbar._FailureModeRedirectData[a.requestId]},
6E5)},{urls:["*://*/*"]});var c=function(a,b){var c=tabDataCollection._Get(b.tabId),d=c._Intended;if(a=shoptoolbar._MatchUrlToStoreRegex(a))shoptoolbar.IncrementUsageMetrics("redirecterrorcount"),shoptoolbar._IncrementFailureMode(),shoptoolbar._SetUsageMetrics("redirecterrorid",a[1]),d&&(delete c._Intended,delete c._Justredirected,chrome.tabs.update(b.tabId,{url:d},function(){}))};chrome.webRequest.onErrorOccurred.addListener(function(a){if(-1===a.tabId)for(var b=shoptoolbar._RequestIdHeader.slice(),
d=0;d<b.length;++d)if(a.requestId===b[d][0]){a.tabId=b[d][2];break}b=tabDataCollection._Get(a.tabId);delete b._Justredirected;delete b._RedirectReason;(d=a.error&&a.error.toLowerCase())&&-1!==d.indexOf("time")&&-1!==d.indexOf("out")?c(a.url,a):delete b._Intended},{urls:["*://r.befrugal.com/*"]});chrome.webRequest.onCompleted.addListener(function(a){if(a&&a.statusCode&&(400<=a.statusCode||204===a.statusCode)){var b=shoptoolbar._FailureModeRedirectData[a.requestId];!b&&shoptoolbar._IsRedirectionUrl(a.url)&&
(b=a.url);b&&c(b,a)}},{urls:["*://*/*"]});var g=function(a){if(!shoptoolbar.queryBlacklist)return null;a.url!==shoptoolbar._RefLinks.Twitter&&a.url!==shoptoolbar._RefLinks.Facebook||browserAdapter.GetTab(a.tabId,function(b){shoptoolbar._RefTab.windowId=b.windowId;shoptoolbar._RefTab.tabId=a.tabId});var b=tabDataCollection._Get(a.tabId);if(!("main_frame"!==a.type||a.method&&/post/i.test(a.method))){if(shoptoolbar._TrackRedirectURL||b._AutoRedirecting||b._RedirectCashbackNewTab)return;delete b._SkipBadge;
AutoApplyApp._CurrentCouponState!==AutoApplyApp._CouponState.PageLoad||shoptoolbar.Config.UpdateRequired||(browserAdapter._SetIcon(shoptoolbar.InactiveIcon),browserAdapter._SetBadgeText(""));var c=null;a.requestHeaders&&(c=$.map(a.requestHeaders,function(a){return"referer"===a.name.toLowerCase()?a:null}));c=c&&0!==c.length?c[0].value:null;if(suppressionHistory._IsSelfDisabled(a.url))return;var d=suppressionHistory._IsSelfSuppression(b,a);shoptoolbar._OnStateChange(a.tabId,a.url,a.requestId||null,
c,d);if(suppressionHistory._IsSuppressed(a.tabId,a.url))return;var e=a.url,g=shoptoolbar._GetMultipleDomains(parseUriWrapper.CleanUrl(e));try{var v=(new URL(e)).hostname;g.push(v);v.includes("www")&&g.push(v.split(".").filter(function(a){return!a.includes("www")}).join("."))}catch(p){}var t=!1,u=c=!1;b._CurrentRequest&&b._CurrentRequest.fromRedirector&&(t=shoptoolbar._MatchUrlToStoreRegex(e),c=shoptoolbar._MatchUrlToCouponRegex(e),u=shoptoolbar._MatchUrlToWeeklyAdRegex(e));if(t){shoptoolbar._ReadOrGetRetailerInfo(parseInt(t[1]),
b,function(c){c.BackupDigestRule&&((!BfrlTool.Prefs.PrivacyPrompt||0<=e.indexOf("&nocook=true"))&&b._CurrentRequest&&(b._CurrentRequest._Autoredirected=!0),b._CashbackActivated=!0,b._GaveClick=b._CurrentId,b._CashbackActivationChangedTime=(new Date).getTime(),c.BackupDigestRule.RetailerID=t[1],c.BackupDigestRule.tabID=a.tabId,BfrlTool._RetailerList._ContainsRetailer(parseInt(t[1]))||BfrlTool._RetailerList._ContainsRestaurant(parseInt(t[1]))||(BfrlTool._RetailerList._AddRetailer(c.BackupDigestRule.Domain,
c.BackupDigestRule,c.RetailerID),shoptoolbar._GetBackupRedirectionRulesForTempRetailer(c.RetailerID)))});return}if(c){var x=function(){var a=parseUriWrapper.parseUri(e);if(a&&a.queryKey&&a.queryKey.tlbon&&a.queryKey.tlbrid)return parseInt(a.queryKey.tlbrid);delete b._Justredirected;return null}();if(x){shoptoolbar._ReadOrGetRetailerInfo(x,b,function(c){c.BackupDigestRule&&(!BfrlTool.Prefs.PrivacyPrompt&&b._CurrentRequest&&(b._CurrentRequest._Autoredirected=!0),b._CashbackActivated=!0,b._GaveClick=
b._CurrentId,b._CashbackActivationChangedTime=(new Date).getTime(),c.BackupDigestRule.RetailerID=x,c.BackupDigestRule.tabID=a.tabId,BfrlTool._RetailerList._ContainsRetailer(x)||BfrlTool._RetailerList._ContainsRestaurant(x)||(BfrlTool._RetailerList._AddRetailer(c.BackupDigestRule.Domain,c.BackupDigestRule,c.RetailerID),shoptoolbar._GetBackupRedirectionRulesForTempRetailer(c.RetailerID)))});return}}else{if(u){shoptoolbar._ReadOrGetRetailerInfo(parseInt(u[1]),b,function(c){c.BackupDigestRule&&(!BfrlTool.Prefs.PrivacyPrompt&&
b._CurrentRequest&&(b._CurrentRequest._Autoredirected=!0),b._CashbackActivated=!0,b._GaveClick=b._CurrentId,b._CashbackActivationChangedTime=(new Date).getTime(),c.BackupDigestRule.RetailerID=u[1],c.BackupDigestRule.tabID=a.tabId,BfrlTool._RetailerList._ContainsRetailer(parseInt(u[1]))||BfrlTool._RetailerList._ContainsRestaurant(parseInt(u[1]))||(BfrlTool._RetailerList._AddRetailer(c.BackupDigestRule.Domain,c.BackupDigestRule,c.RetailerID),shoptoolbar._GetBackupRedirectionRulesForTempRetailer(c.RetailerID)))});
return}delete b._Justredirected}var y=function(c,d){d=(d=AutoApplyApp._activeDuplicateTabs.has(b.TabId))||!!AutoApplyApp.getPrimaryTabIdFromDuplicate(b.TabId);if(b._AttachParamNextNav&&!a.url.includes("afsrc")&&!d&&b._CurrentId&&c&&c.RetailerID.toString()===b._CurrentId.toString())d="",a.url.includes("#")?(d=a.url.split("#"),d=d[0].includes("?")?d[0]+"&afsrc=1&bfact=true#"+d[1]:d[0]+"?afsrc=1&bfact=true#"+d[1]):d=a.url.includes("?")?a.url+"&afsrc=1&bfact=true":a.url+"?afsrc=1&bfact=true",b._AttachParamNextNav=
!1,chrome.tabs.update(null,{url:d});else{tabDataCollection._IsWellKnown(c.RetailerID);var f=shoptoolbar._GetRetailerRedirectURL(c.RetailerID,!0,!1);shoptoolbar._MatchUrlToStoreRegex(f)&&(b._RetailerInfo&&(b._RetailerInfo.Loaded=!0),BfrlTool.BrowserStorage.AutomaticActivation.then(function(d){var g=!0;shoptoolbar._IsButton&&(g=shoptoolbar.AutoRedirectSettings&&shoptoolbar.AutoRedirectSettings.ForceOn?!0:d);shoptoolbar._ReadOrGetRetailerInfo(c.RetailerID,b,function(d){b._RetailerInfo._Rule=c.Rule;if(b._CurrentRequest&&
b._CurrentRequest.fromRedirector)BfrlTool.Prefs.PrivacyPrompt||(b._AutoRedirecting=!0,b._CurrentRequest&&(b._CurrentRequest._Autoredirected=!0)),b._CashbackActivated=!0,b._GaveClick=b._CurrentId,b._CashbackActivationChangedTime=(new Date).getTime();else if(shoptoolbar._isCashbackInjectionClick(a.url)||b._CurrentRequest&&b._CurrentRequest.isCashbackInjection)BfrlTool.Prefs.PrivacyPrompt||(b._AutoRedirecting=!0),b._CashbackActivated=!0,b._GaveClick=b._CurrentId,b._CashbackActivationChangedTime=(new Date).getTime(),
b._CurrentRequest&&!b._CurrentRequest._Autoredirected?(BfrlTool.Prefs.PrivacyPrompt||(b._CurrentRequest._Autoredirected=!0),shoptoolbar._RedirectIFrame(f,a.tabId,!0)):b._CurrentRequest||shoptoolbar._RedirectIFrame(f,a.tabId,!0);else if(!(b._CashbackActivated||b._CurrentRequest&&b._CurrentRequest.printable||shoptoolbar.AutoRedirectSettings&&!shoptoolbar.AutoRedirectSettings.Enabled)){if(shoptoolbar._IsButton)for(var k=Object.keys(suppressionHistory._TabSuppressedRetailers),p=k.length-1;0<=p;--p)if(suppressionHistory._TabSuppressedRetailers[k[p]].RetailerId.toString()===
c.RetailerID.toString())return;var h=!1;b._PaidAdHttpRequest&&(-1===b._PaidAdHttpRequest.retailerId&&(b._PaidAdHttpRequest.retailerId=c.RetailerID),(h=b._PaidAdHttpRequest.retailerId===c.RetailerID)||delete b._PaidAdHttpRequest);!shoptoolbar.GetIsButton()&&shoptoolbar.Config.IsButtonInstalled||"Standard"!==c.Rule||d.IsRestaurant||!d.CashbackRate||shoptoolbar._FailureMode||b._Justredirected||shoptoolbar._TrackRedirectURL||!g||BfrlTool.BrowserStorage.PrivacyPrompt.then(function(d){d?(d=BfrlTool.Prefs.PrivacyDeclinedDate,
shoptoolbar.Config.PrivacyPrompt.CounterEnabled&&d&&0<d.length&&1>(Date.now()-d)/(864E5*shoptoolbar.Config.PrivacyPrompt.Days)&&shoptoolbar._RedirectIFrame(f,a.tabId)):chrome.tabs.query({},function(d){if(0===d.filter(function(b){return b.id===a.tabId}).length)/\.(gif|jpg|jpeg|tiff|png)$/i.test(e)||(d=h?b._PaidAdHttpRequest:null,d={_Url:f,_TrackRedirectURL:e,_Intended:b._Intended,_CurrentId:c.RetailerID,_RetailerInfo:b._RetailerInfo,_OrphanedDate:(new Date).getTime(),_PaidAdHttpRequest:d},shoptoolbar._PreloadOrphans.push(d));
else if(shoptoolbar._PreloadOrphans=shoptoolbar._PreloadOrphans.filter(function(a){return a._CurrentId!==c.RetailerID}),shoptoolbar._PreloadOrphans=shoptoolbar._PreloadOrphans.filter(function(a){return a._OrphanedDate<(new Date).getTime()+1500}),!h){b._AutoRedirecting=!0;b._CashbackActivated=!0;b._CashbackActivationChangedTime=(new Date).getTime();d=tabDataCollection._TabData.filter(function(a){return a._CurrentId&&a._CurrentId.toString()===c.RetailerID.toString()});for(var g=0;g<d.length;g++)d[g]._CashbackActivated=
!0,d[g]._CashbackActivationChangedTime=(new Date).getTime();b._CurrentRequest&&(b._CurrentRequest._Autoredirected=!0);shoptoolbar._RedirectIFrame(f,a.tabId)}})})}})}))}},k=function(c,d,f){if(c&&0!==c.length)if(d)if(shoptoolbar._IgnoreLookupDomain(c[0]))k(c.slice(1),d,f);else{var e=BfrlTool._RetailerList._GetRetailer(c[0]);if(e)if(Array.isArray(e)){if(b._CashbackActivated){var p=e.filter(function(a){return a.RetailerID.toString()===b._CurrentId.toString()});if(0<p.length){y(p[0],d);return}}p=longStringCompare(e,
f);-1===p?k(c.slice(1),d,f):y(e[p],d)}else y(e,d);else k(c.slice(1),d,f)}else shoptoolbar._NavigatedOffRetailer(a.tabId,b);else d?k(g,!1,f):(delete b._Redirect,delete b._RedirectReason,shoptoolbar._NavigatedOffRetailer(a.tabId,b),shoptoolbar._SetBadge(!1))};k(g,!0,e)}return null};chrome.webRequest.onBeforeRequest.addListener(function(a){g(a)},{urls:["*://*/*"]},["blocking"]);browserAdapter._AddWindowOnFocusedListener(function(a){0!==shoptoolbar._RefTab.windowId&&a!==shoptoolbar._RefTab.windowId?browserAdapter.UpdateWindow(shoptoolbar._RefTab.windowId,
{focused:!0}):0!==shoptoolbar._ChromeStoreTab.windowId&&a!==shoptoolbar._ChromeStoreTab.windowId?browserAdapter.UpdateWindow(shoptoolbar._ChromeStoreTab.windowId,{focused:!0}):browserAdapter.GetActiveTab(!0,function(a){if(a&&a.id&&a.id!=shoptoolbar._WelcomeScreenId&&!shoptoolbar._TourMode){var b=tabDataCollection._Get(a.id);delete b._SkipBadge;b._CurrentRequest&&(b._CurrentRequest._Focused=!0);shoptoolbar._TabRefresh(a.id,{status:"loading",sourceEvent:"WindowOnFocused",focused:!0},a,!0)}})});browserAdapter._AddTabsOnUpdatedListener(function(a,
c,e){if(c.status&&("loading"===c.status||"complete"===c.status)){var d=tabDataCollection._Get(a);d._PaidAdHttpRequest&&(d._PaidAdHttpRequest.Completed=!0);c.sourceEvent="TabsOnUpdated";d.requestStatus=c.status;shoptoolbar._TabRefresh(a,c,e,!0);"complete"===c.status&&(b(e.url),!/chrome:\/\//i.test(e.url)&&shoptoolbar.Config.DailyUpdateReminder&&(a=function(){shoptoolbar.requiresUpdateReminder(function(a){localStorage.lastUpdateReminderDay=(new Date).getDate().toString();localStorage.lastUpdateReminderHour=
(new Date).getHours().toString();browserAdapter._SendTabMessage(e.id,{action:"updateReminder",targetScript:"autoApplyContent.js",url:shoptoolbar.Config.UpdateUrl,styleCss:chrome.runtime.getURL("/fonts/Roboto.css"),mainImage:shoptoolbar.Config.DailyReminderImageMain,buttonImage:shoptoolbar.Config.DailyReminderImageButton,secureUser:a})})},localStorage.lastUpdateReminderDay&&localStorage.lastUpdateReminderDay==(new Date).getDate().toString()?localStorage.lastUpdateReminderHour&&parseInt(localStorage.lastUpdateReminderHour)+
8<=(new Date).getHours()&&a():a()))}});chrome.windows.onRemoved.addListener(function(a){shoptoolbar.NewTabSettings.UseNewTabCashback||browserAdapter.GetAllTabs(function(a){for(var b=[],c=0;c<a.length;c++){var d=tabDataCollection._Get(a[c].id),f=!!AutoApplyApp.getPrimaryTabIdFromDuplicate(a[c].id);if(!(d&&d._RedirectCashbackNewTab||f))return;b.push({windowId:a[c].windowId,tabId:a[c].id})}for(a={$jscomp$loop$prop$h$43:0};a.$jscomp$loop$prop$h$43<b.length;a={$jscomp$loop$prop$h$43:a.$jscomp$loop$prop$h$43},
a.$jscomp$loop$prop$h$43++)browserAdapter.UpdateWindow(b[a.$jscomp$loop$prop$h$43].windowId,{state:"normal",width:1E3,height:600,focused:!1,top:0,left:0},function(a){return function(c){browserAdapter.CloseTab(b[a.$jscomp$loop$prop$h$43].tabId)}}(a))})});browserAdapter._AddTabsOnClosedListener(function(a,b){var c;(c=AutoApplyApp.getPrimaryTabIdFromDuplicate(a))&&AutoApplyApp.prematureDuplicateClosing(c);if(a===shoptoolbar._RefTab.tabId&&0!==shoptoolbar._RefTab.tabId)shoptoolbar._RefTab.tabId=0,shoptoolbar._RefTab.windowId=
0;else if(a===shoptoolbar._WelcomeScreenId)shoptoolbar._TourMode=!1,shoptoolbar._TourRetailer.step=0;else if(a===shoptoolbar._ChromeStoreTab.tabId&&0!==shoptoolbar._ChromeStoreTab.tabId)shoptoolbar._ChromeStoreTab.tabId=0,shoptoolbar._ChromeStoreTab.windowId=0;else{shoptoolbar._IsButton&&0<=shoptoolbar.befrugalInstallTabs.indexOf(a)&&BfrlTool.BrowserStorage.TourShown.then(function(a){"initial"===a&&(shoptoolbar._WelcomeScreenId=0,browserAdapter._ShowWelcomePage())});0<=AutoApplyApp._activeTabs.indexOf(a)&&
(AutoApplyApp._ResetState(!0),AutoApplyApp._activeTabs.splice(AutoApplyApp._activeTabs.indexOf(a),1));var d=AutoApplyApp._activeDuplicateTabs.get(a);d&&AutoApplyApp._activeDuplicateTabs.delete(a)&&browserAdapter.GetAllTabs(function(a){a&&1===a.length?browserAdapter.UpdateWindow(a[0].windowId,{state:"normal",width:1E3,height:600,focused:!1,top:0,left:0},function(a){browserAdapter.CloseTab(d)}):browserAdapter.CloseTab(d)});c=suppressionHistory._isRetailerTabSuppressed(a);var f=tabDataCollection._Get(a);
suppressionHistory._CleanTabOnClose(a);if(!(f._RedirectCashbackNewTab||f._IsAutoApplyingBackgroundTab||c)&&f._CashbackActivated){var e=BfrlTool.BrowserStorage;e.NoMoreInvites.then(function(a){e.PreviousInviteDenied.then(function(c){e.PreviousInviteDenialDate.then(function(d){e.SecondDenial.then(function(g){e.SecondInviteDenialDate.then(function(h){e.InviteToRate.then(function(e){if(!a&&c&&f._RetailerInfo){var k=Date.now();(!g&&1<=(k-d)/864E5||g&&1<=(k-h)/6048E5)&&!b.isWindowClosing&&e&&(shoptoolbar._Browser===
shoptoolbar.Browsers.Chrome||shoptoolbar._Browser===shoptoolbar.Browsers.Firefox&&shoptoolbar._IsButton)&&(g?BfrlTool.BrowserStorage.NoMoreInvites=!0:(BfrlTool.BrowserStorage.SecondDenial=!0,BfrlTool.BrowserStorage.SecondInviteDenialDate=Date.now()),chrome.tabs.create({url:"https://"+shoptoolbar.RateUsSite},function(a){chrome.tabs.get(a.id,function(b){!chrome.runtime.lastError&&b&&BfrlTool.BrowserStorage.UserToken.then(function(b){browserAdapter._ExecuteScriptCode(a.id,"var toolbarVersion = "+JSON.stringify(shoptoolbar._ToolbarVersion)+
"; var userToken = "+JSON.stringify(b),function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);browserAdapter._ExecuteScript(a.id,"js/generateRatePopup.js",function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message)})})})})}))}else!a&&!c&&f._RetailerInfo&&!b.isWindowClosing&&e&&(shoptoolbar._Browser===shoptoolbar.Browsers.Chrome||shoptoolbar._Browser===shoptoolbar.Browsers.Firefox&&shoptoolbar._IsButton)&&(BfrlTool.BrowserStorage.PreviousInviteDenied=
!0,BfrlTool.BrowserStorage.PreviousInviteDenialDate=Date.now(),chrome.tabs.create({url:"https://"+shoptoolbar.RateUsSite},function(a){chrome.tabs.get(a.id,function(b){!chrome.runtime.lastError&&b&&BfrlTool.BrowserStorage.UserToken.then(function(b){browserAdapter._ExecuteScriptCode(a.id,"var toolbarVersion = "+JSON.stringify(shoptoolbar._ToolbarVersion)+"; var userToken = "+JSON.stringify(b),function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);browserAdapter._ExecuteScript(a.id,
"js/generateRatePopup.js",function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message)})})})})}))})})})})})});shoptoolbar.endOfCashbackTab(a)}}});shoptoolbar.GetBrowser()!==shoptoolbar.Browsers.Edge&&chrome.runtime.onUpdateAvailable.addListener(function(a){chrome.runtime.reload()})})}}}();window.addEventListener("load",function(){shoptoolbar._Init()},!1);
chrome.windows.onCreated.addListener(function(c){chrome.windows.getAll(function(a){for(var b=!1,e=0;e<a.length;e++)a[e].id!==c.id&&(b=!0);b||chrome.runtime.reload()})});
browserAdapter._AddMessageListener(function(c,a,b){var e=function(a){b(a);return!0},g=ButtonApp._ButtonMessages(c,a,b);if(g&&g.handledMessage)return g.usedResponse;g=SettingsApp.SettingsMessage(c,a);if(null!=g)return e(g);if((g=AutoApplyApp._AutoApplyMessage(c,a,b))&&g.handledMessage||(g=ShowCouponsApp._ShowCouponsMessage(c,a,b))&&g.handledMessage||(g=DisableSystem._DisableExtensionsMessage(c,a,b))&&g.handledMessage)return g.usedResponse;if(c.request){shoptoolbar.GetIsTourMode(function(a){if(a||"TourFinished"===
c.request)a={instruction:c.request},"ClickedRestaurants"===c.request&&(a.NoCashBack=shoptoolbar._GetNoCashBackExtension()),browserAdapter._SendTabMessage(shoptoolbar._WelcomeScreenId,a)});if("PopupOpened"===c.request&&shoptoolbar._TourMode)return shoptoolbar._WelcomeScreenId&&browserAdapter._SendTabMessage(shoptoolbar._WelcomeScreenId,{instruction:"HideOverlay"}),null===shoptoolbar._TourPort&&chrome.runtime.onConnect.addListener(function(a){var b=null!==shoptoolbar._TourPort;shoptoolbar._TourPort=
a;b||a.onDisconnect.addListener(function(){shoptoolbar._TourPort=null;shoptoolbar._WelcomeScreenId&&browserAdapter._SendTabMessage(shoptoolbar._WelcomeScreenId,{instruction:"CloseTour"});shoptoolbar._TourMode&&(shoptoolbar._QuitTourCount+=1,2<shoptoolbar._QuitTourCount||3===shoptoolbar._TourRetailer.step?(shoptoolbar._TourMode=!1,shoptoolbar._WelcomeScreenId&&(browserAdapter._SendTabMessage(shoptoolbar._WelcomeScreenId,{instruction:"CloseTour"}),shoptoolbar._TourRetailer.step=0)):shoptoolbar._WelcomeScreenId&&
(browserAdapter._SendTabMessage(shoptoolbar._WelcomeScreenId,{instruction:"Step one",retailerName:shoptoolbar._TourRetailer.retailerName,pageType:shoptoolbar._TourRetailer.pageType}),shoptoolbar._TourRetailer.step=1))})}),e({retailerId:shoptoolbar._TourRetailer.retailerId,imageUrl:shoptoolbar._TourRetailer.imageUrl});if("PopupOpened"===c.request)return shoptoolbar._WelcomeScreenId&&browserAdapter._SendTabMessage(shoptoolbar._WelcomeScreenId,{instruction:"HideOverlay"}),browserAdapter.GetActiveTab(!0,
function(a){if(null!==a){var b=tabDataCollection._Get(a.id),c=suppressionHistory._IsSuppressed(a.id,a.url);!shoptoolbar._IsButton&&c&&shoptoolbar._ReadOrGetRetailerInfo(b._CurrentId,b,function(c){null!=c&&(suppressionHistory._CleanTab(a.id),b._SkipBadge=!0,browserAdapter._SetBadgeText(c.CouponCount.toString()),browserAdapter._SetIconBackgroundColor(!1),shoptoolbar.RecordNotificationActivation(b,b._CurrentRequest))});return e({tabId:a.id,tabUrl:a.url,isSuppressed:c})}return e(null)}),!0;"BefrugalEvent"===
c.request?shoptoolbar._BefrugalEvents.GetActive(c.typeEnum,c.typeName):"PopupClickedDuringInstall"===c.request&&browserAdapter.GetAllTabs(function(a){var b=/(chrome.google.com\/webstore.*aioiakpkggkgmcncklmjcoojdoadleol)/i,c=a.filter(function(a){return b.test(a.url)});0<c.length?(chrome.windows.update(c[0].windowId,{focused:!0}),shoptoolbar._ChromeStoreTab.windowId=c[0].windowId,shoptoolbar._ChromeStoreTab.tabId=c[0].id):(c=a.filter(function(a){return/befrugal.com\/lp\//i.test(a.url)}),0<c.length?
browserAdapter._ExecuteScriptCode(c[0].id,"var evtFocus = document.createEvent('Event');evtFocus.initEvent('DownloadEvent', true, false);document.dispatchEvent(evtFocus);",function(a){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message)}):(shoptoolbar._ChromeStoreTab.windowId=0,shoptoolbar._ChromeStoreTab.tabId=0,shoptoolbar.firstOpenTab=!1))});return!1}if(c.startsWith&&c.startsWith("setPref"))return a=c.split(","),"NoMoreInvites"===a[1]?"true"===a[2]&&(BfrlTool.BrowserStorage.NoMoreInvites=
!0):"Clicks"===a[1]&&(BfrlTool.Prefs.ToolbarClicks=[],BfrlTool.BrowserStorage.InviteToRate=!1),!1;if(c.action){g=function(a,d,g){var f=suppressionHistory._IsSuppressed(d.id,d.url);switch(g.action){case "pageload":return BfrlTool.BrowserStorage.UserToken.then(function(a){var b="https://"+shoptoolbar.Site+"/toolbar/download/uninstall/?toolbar=chrome";a=shoptoolbar.Format("https://{2}/toolbar/toolbarws/ws.asmx/IsFirstChromeUninstall?usertoken={0}&toolbarversion={1}",a,shoptoolbar._ToolbarVersion,shoptoolbar.Site);
e({globalsuppress:f,uninstallpage:b,firstuninstallurl:a})}),!0;case "visibility":browserAdapter._UpdateScreenshot(d);break;case "closeSlider":shoptoolbar._LogNotifyBar(g.reason,g.retailerid,[]);if(shoptoolbar._IsButton){var h=ButtonApp._GetButtonStorage(a._CurrentId),m=g.reason&&"activatedCashback"===g.reason;h&&(h.dialog.show=m,AutoApplyApp._AutoApplyCheckoutPage&&(h.dialog.neverShow=!0))}break;case "askNotify":case "askRegister":shoptoolbar.Config.UpdateRequired?browserAdapter._SendTabMessage(d.id,
{action:"requiresUpdate",targetScript:"autoApplyContent.js",url:shoptoolbar.Config.UpdateUrl,styleCss:chrome.runtime.getURL("/fonts/Roboto.css")}):shoptoolbar._ShowNotification(d.id,g.retailerid,g.notifytype);break;case "tellRegister":shoptoolbar._GetAccountFromEmail(g.email,function(a){a&&shoptoolbar._ShowNotification(d.id,g.retailerid,g.notifytype)});break;case "changeText":g.value&&(a.CouponText=g.value);break;case "goToAccount":chrome.tabs.create({url:"https://"+shoptoolbar.Site+"/account/?"+
("bf_src=3"+shoptoolbar.UTQueryString)});break;case "goToTerms":chrome.tabs.create({url:"https://"+shoptoolbar.Site+"/termsandconditions/?"+("bf_src=3"+shoptoolbar.UTQueryString)});break;case "NeverShowAgain":var t=shoptoolbar.Format("https://{0}/wssimple.asmx/UpsertDisabledNotifications",shoptoolbar.Site.replace("www","tbwsjs"));a._RetailerInfo&&a._RetailerInfo.RetailerID.toString()===g.retailerid.toString()&&(BfrlTool.BrowserStorage.UserToken.then(function(b){shoptoolbar.FetchJson(t,{method:"POST",
headers:{"Content-Type":"application/x-www-form-urlencoded"},body:shoptoolbar.Format("retailerId={0}&UserToken={1}&toolbarversion={2}&internalName={3}",a._RetailerInfo.RetailerID,b,shoptoolbar.GetToolbarVersion(),a._RetailerInfo.InternalName)})}),BfrlTool.BrowserStorage.TurnOffNotifications.then(function(b){b=b&&0<b.length?JSON.parse(b):{};if(!b[a._RetailerInfo.RetailerID]){var c={retailerName:a._RetailerInfo.RetailerName,internalName:a._RetailerInfo.InternalName,retailerLogo:a._RetailerInfo.ImgUrl};
b[a._RetailerInfo.RetailerID]=c;BfrlTool.BrowserStorage.TurnOffNotifications=JSON.stringify(b);c.retailerId=a._RetailerInfo.RetailerID;var d=shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?chrome:browser,e=d.runtime.getURL("settings/searchSites.html"),f=d.runtime.getURL("settingsPage.html"),g=function(a){var b;for(b in a){var c=a[b];if(c.url==f)return["toolbar",c.id];if(c.url==e)return["button",c.id]}return null},k=null;browserAdapter.GetAllTabs(function(a){if(k=g(a))"button"==k[0]?d.tabs.reload(k[1]):
(browserAdapter._SendTabMessage(k[1],{action:"updateTSL",targetScript:"settingsPage.js",data:c},function(){chrome.runtime.lastError&&console.log(chrome.runtime.lastError)}),browserAdapter._SendTabMessage(k[1],{action:"updateNotifyListHTML",targetScript:"searchSites.js",data:c},function(){chrome.runtime.lastError&&console.log(chrome.runtime.lastError)}))})}}));break;case "reactivateloaded":delete a._WasActivated;break;case "activateCashback":if(shoptoolbar.Config.UpdateRequired)browserAdapter._SendTabMessage(d.id,
{action:"requiresUpdate",targetScript:"autoApplyContent.js",url:shoptoolbar.Config.UpdateUrl,styleCss:chrome.runtime.getURL("/fonts/Roboto.css")});else{h=shoptoolbar._GetRetailerRedirectURL(g.retailerid?g.retailerid:a._CurrentId,!1,!0);shoptoolbar._RedirectIFrame(h,d.id);a._RedirectTopCouponId=-1;shoptoolbar._IsButton&&!g.showCashbackMessage?(ButtonApp.HideButton(d),shoptoolbar.RecordNotificationActivation(a,a._CurrentRequest)):g.showCashbackMessage?a._RetailerInfo&&a._RetailerInfo.CashbackRate&&
shoptoolbar._ShowToastMessage(d.id,g.retailerid,a._CurrentRequest,a._RetailerInfo.CashbackRate,"animations/checkmark/checkmark.html","js/cashbackToastInject.js",null):shoptoolbar._ShowNotification(d.id,g.retailerid,shoptoolbar._NotifyState._RedirectCashback);delete a._RedirectTopCouponId;a._CashbackActivated=!0;a._CashbackActivationChangedTime=(new Date).getTime();shoptoolbar._WakeUpCouponBadge(a);h=tabDataCollection._TabData.filter(function(a){return a._CurrentId&&a._CurrentId.toString()===g.retailerid.toString()});
for(m=0;m<h.length;m++)h[m]._CashbackActivated=!0,h[m]._CashbackActivationChangedTime=(new Date).getTime();suppressionHistory._CleanTab(d.id)}break;case "activateTopCoupon":shoptoolbar.Config.UpdateRequired?browserAdapter._SendTabMessage(d.id,{action:"requiresUpdate",targetScript:"autoApplyContent.js",url:shoptoolbar.Config.UpdateUrl,styleCss:chrome.runtime.getURL("/fonts/Roboto.css")}):shoptoolbar._ReadOrGetRetailerInfo(a._CurrentId,a,function(b){b=shoptoolbar._GetRetailerRedirectURL(a._CurrentId);
a._RedirectTopCouponId=a._TopCoupon.ID;a._CashbackActivated=!0;a._CashbackActivationChangedTime=(new Date).getTime();shoptoolbar._RedirectIFrame(b,d.id);shoptoolbar._ShowNotification(d.id,a._CurrentId,shoptoolbar._NotifyState._RedirectTopCoupon);browserAdapter._SetIconBackgroundColor(a._CashbackActivated);delete a._RedirectTopCouponId;shoptoolbar._IsButton&&(ButtonApp.HideButton(d),ButtonApp.HideDialog(d))});break;case "openURL":chrome.tabs.update(d.id,{url:g.url});break;case "newTabLoad":browser.storage.local.get("TopVisited").then(function(a){a.TopVisited&&
(a=JSON.parse(a.TopVisited),portFromCS.postMessage({topVisited:a}))});break;case "openNewTab":shoptoolbar.Config.UpdateRequired?browserAdapter._SendTabMessage(d.id,{action:"requiresUpdate",targetScript:"autoApplyContent.js",url:shoptoolbar.Config.UpdateUrl,styleCss:chrome.runtime.getURL("/fonts/Roboto.css")}):chrome.tabs.create({url:g.url});break;case "cashbackInject_isAllowed":BfrlTool.BrowserStorage.AllowCashbackInjection.then(function(a){b(a)});break;case "cashbackInject_checkIfRetailer":var u=
function(a,b,c){if(!Array.isArray(a)||Array.isArray(a)&&0===a.length)return b?u(a,!1,c):null;if(b){if(shoptoolbar._IgnoreLookupDomain(a[0]))return u(a.slice(1),b,c);var d=BfrlTool._RetailerList._GetRetailer(a[0]);if(d){if(Array.isArray(d)){var e=longStringCompare(d,c);return-1===e?u(a.slice(1),b,c):shoptoolbar._IsRetailerOnHideNotificationsList(d[e].RetailerID.toString())?null:d[e]}return shoptoolbar._IsRetailerOnHideNotificationsList(d.RetailerID.toString())?null:d}return u(a.slice(1),b,c)}return null};
h=c.urls;var x="";for(m=0;m<h.length;m++){var y=shoptoolbar._GetMultipleDomains(parseUriWrapper.CleanUrl(h[m]));try{var k=(new URL(h[m])).hostname;y.push(k);k.includes("www")&&y.push(k.split(".").filter(function(a){return!a.includes("www")}).join("."))}catch(p){}(y=u(y,!0,h[m]))&&(x+=y.RetailerID.toString());m<h.length-1&&(x+=",")}BfrlTool.BrowserStorage.IsShopper.then(function(a){var c=shoptoolbar.APISite+"/wssimplenonshopper.asmx/GetBatchedRetailerInfo";a=shoptoolbar.Format("?retailerids={0}&isShopper={1}",
x,a);shoptoolbar._LoadURI_JSON_GET(c+a,function(a){b(JSON.parse(a))})});break;case "cashbackInject_GetSelectors":return shoptoolbar._GetCashBackInjectionSelectors(function(a){b(a)}),!0;case "buttonInitReady":shoptoolbar._TabRefresh(d.id,{status:"loading",sourceEvent:"buttonInitReady"},d,!0)}return!1};if(a.tab){var d=tabDataCollection._Get(a.tab.id);g(d,a.tab,c)}return!0}return!1});
function IsBeFrugalButtonOrClassic(c){if(shoptoolbar._IsButton){var a=/^(https?:\/\/www.befrugal.com)/i,b=/^(https?:\/\/www.couponviewer.com)/i;browserAdapter.GetAllTabs(function(e){if(0<e.filter(function(a){return b.test(a.url)}).length)c(!0);else{var g=e.filter(function(b){return a.test(b.url)});0<g.length?browserAdapter._ExecuteScriptCode(g[0].id,'(!localStorage["ButtonLpDownloadFlow"] || localStorage["ButtonLpDownloadFlow"] === "false")',function(a){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);
a&&0<a.filter(function(a){return!0===a}).length?shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox?browserAdapter._ExecuteScriptCode(g[0].id,"let thismatch = document.cookie.match(new RegExp('(^| )' + \"ToolbarPage.WelcomePageStyle\" + '=([^;]+)')); if (thismatch) thismatch[2]; else false",function(a){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);a&&0<a.filter(function(a){return 0<a.length}).length&&(a=JSON.parse(a.filter(function(a){return 0<a.length})[0]))&&a.Name&&
0<a.Name.length&&shoptoolbar._GetInstallStoreInfo(a.Name,function(a,b,c){shoptoolbar._TourRetailer.retailerId=b;shoptoolbar._TourRetailer.retailerName=a;shoptoolbar._TourRetailer.imageUrl=c;BfrlTool.BrowserStorage.BonusEligibility=parseInt(b)});c(!0)}):c(!0):c(!1)}):c(!1)}})}else c(!0)}
browserAdapter._AddInstalledListener(function(c){"install"===c.reason?(shoptoolbar.GetBrowser()!==shoptoolbar.Browsers.Chrome||shoptoolbar.GetIsButton()||shoptoolbar.GetIsBF()?shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox?BfrlTool.BrowserStorage.PrivacyPrompt=!0:shoptoolbar._GetAccount().then(function(){shoptoolbar._NotifyInstall()}):(BfrlTool.BrowserStorage.NoCashBackExtension=!0,BfrlTool.BrowserStorage.PrivacyPrompt=!0,shoptoolbar._GetAccount().then(function(){shoptoolbar._NotifyInstall()})),
IsBeFrugalButtonOrClassic(function(a){a&&(BfrlTool.BrowserStorage.IsClassic=!0,shoptoolbar._IsButton=!1);shoptoolbar.firstOpenTab=!shoptoolbar._IsButton;var b=/^((https?:\/\/www.befrugal.com)|(https?:\/\/www.couponviewer.com))/i,c=new RegExp("(chrome.google.com/webstore.*/(logldmlncddmdfcjaaljjjkajcnacigc || kcdcneeneoifbeenbbnjodcflhdbaggp ||"+browserAdapter._GetRuntimeID()+"))","i");(new Promise(function(a,c){shoptoolbar._IsButton?shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?browserAdapter.GetAllTabs(function(c){c=
c.filter(function(a){return b.test(a.url)&&/lp\/addon\//i.test(a.url)});for(var d=0;d<c.length;d++)shoptoolbar.befrugalInstallTabs.push(c[d].id);a(0<c.length)}):shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox?browserAdapter.GetAllTabs(function(c){c=c.filter(function(a){return b.test(a.url)&&/lp\/addon\//i.test(a.url)});for(var d=0;d<c.length;d++)shoptoolbar.befrugalInstallTabs.push(c[d].id);browserAdapter._SetIcon(shoptoolbar.ActiveIcon);browserAdapter._SetBadgeText("1");a(0<c.length)}):a(!1):
shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?browserAdapter.GetAllTabs(function(c){var d=c.filter(function(a){return b.test(a.url)});c=[];for(var e=0;e<d.length;e++)c.push(new Promise(function(a,b){browserAdapter._ExecuteScriptCode(d[e].id,"localStorage['isClassicFlow']",function(b){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);b&&0<b.filter(function(a){return"true"===a}).length?a(!0):a(!1)})}));Promise.all(c).then(function(b){a(0<b.filter(function(a){return!0===
a}).length)})}):shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox?browserAdapter.GetAllTabs(function(c){var d=c.filter(function(a){return b.test(a.url)});c=[];for(var e=0;e<d.length;e++)c.push(new Promise(function(a,b){browserAdapter._ExecuteScriptCode(d[e].id,"localStorage['isClassicFlow']",function(b){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);0<b.filter(function(a){return"true"===a}).length?a(!0):a(!1)})}));Promise.all(c).then(function(b){a(0<b.filter(function(a){return!0===
a}).length)})}):a(!1)})).then(function(a){a?shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?browserAdapter.GetAllTabs(function(a){var d=a.filter(function(a){return c.test(a.url)}),e=a.filter(function(a){return b.test(a.url)});for(a=0;a<e.length;a++)browserAdapter._ExecuteScript(e[a].id,"js/installExtendedSearch.js",function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);if(0<d.length){var a="https://www.befrugal.com/toolbar/install/?chinstall=1&type="+(shoptoolbar._IsButton?
"1":shoptoolbar._IsBF?"2":"3"),c=function(){browserAdapter.UpdateWindow(d[0].windowId,{focused:!0});browserAdapter.UpdateTab(d[0].id,a);shoptoolbar._ChromeStoreTab.windowId=d[0].windowId;shoptoolbar._ChromeStoreTab.tabId=d[0].id};0<e.length?browserAdapter._ExecuteScriptCode(e[0].id,"localStorage['currentFlow']",function(f){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);0<f.filter(function(a){return"2"===a}).length?browserAdapter.GetActiveTab(!0,function(c){var f=c.id;b.test(c.url)||
(c=e.filter(function(a){return a.active}),0<c.length?f=c[0].id:(c=e.filter(function(a){return/lp\/addon\//i.test(a.url)}),0<c.length&&(f=c[0].id)));0<d.length&&browserAdapter.CloseTab(d[0].id);shoptoolbar.befrugalInstallTabs.push(f);browserAdapter.UpdateTab(f,a)}):c()}):c()}})}):shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox&&browserAdapter.GetActiveTab(!0,function(a){shoptoolbar._IsButton?(shoptoolbar.befrugalInstallTabs.push(a.id),browserAdapter.UpdateTab(a.id,"https://www.befrugal.com/toolbar/install/?ffinstall=1")):
browserAdapter._ExecuteScript(a.id,"js/installCleanup.js",function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);browserAdapter.UpdateTab(a.id,"https://www.befrugal.com/toolbar/install/?ffinstall=1&type="+(shoptoolbar._IsButton?"1":shoptoolbar._IsBF?"2":"3"))})}):shoptoolbar._IsButton?browserAdapter.GetAllTabs(function(a){var d=a.filter(function(a){return c.test(a.url)});0<d.length&&browserAdapter.CloseTab(d[0].id);a=a.filter(function(a){return b.test(a.url)&&a.active});
0<a.length?browserAdapter.UpdateTab(a[0].id,shoptoolbar.Format("https://{0}/addon/installationcomplete/",shoptoolbar.Site)):browserAdapter.CreateTab(shoptoolbar.Format("https://{0}/addon/installationcomplete/",shoptoolbar.Site))}):shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox?browserAdapter.GetActiveTab(!0,function(a){browserAdapter._ExecuteScript(a.id,"js/installCleanup.js",function(a){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);0<a.filter(function(a){return/true/i.test(a)}).length?
browserAdapter.UpdateTab(null,shoptoolbar.Format("https://{0}/toolbar/welcome/",shoptoolbar.Site)):browserAdapter._ShowWelcomePage()})}):shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome&&browserAdapter.GetAllTabs(function(a){for(var d=[],e=a.filter(function(a){return b.test(a.url)}),g=0;g<e.length;g++)d.push(new Promise(function(a,b){browserAdapter._ExecuteScript(e[g].id,"js/installCleanup.js",function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);a()})}));Promise.all(d).then(function(){browserAdapter.GetAllTabs(function(a){a=
a.filter(function(a){return c.test(a.url)});0<a.length?browserAdapter.CloseTab(a[0].id):browserAdapter._ShowWelcomePage()})})})})}),shoptoolbar._SetDefaultPreferences(!1),BfrlTool.BrowserStorage.TourShown="initial"):"update"!=c.reason||shoptoolbar.GetBrowser()!==shoptoolbar.Browsers.Chrome||shoptoolbar.GetIsButton()||shoptoolbar.GetIsBF()||(BfrlTool.BrowserStorage.NoCashBackExtension=!0,BfrlTool.BrowserStorage.PrivacyPrompt=!0)});
chrome.webRequest.onBeforeSendHeaders.addListener(function(c){var a=new RegExp(/^([^(r\.)](.*\.))?befrugal.com$/i),b=parseUriWrapper.CleanUrl(c.url);if(a.test(b))if(/.*befrugal.com\/toolbar\/install\/.createTab=true$/i.test(c.url))BfrlTool.BrowserStorage.TourShown.then(function(a){"initial"===a&&(shoptoolbar._WelcomeScreenId=0,browserAdapter._ShowWelcomePage())});else{if(/installationcomplete/i.test(c.url)&&(browserAdapter.GetAllTabs(function(a){var b=/chrome.google.com\/webstore.*\/(logldmlncddmdfcjaaljjjkajcnacigc||pcoojlbcellolmkdcoilhdolbaemmpmc)/i;
a=a.filter(function(a){return b.test(a.url)});for(var c=0;c<a.length;c++)chrome.tabs.remove(a[c].id)}),BfrlTool.BrowserStorage.TourShown="shown",shoptoolbar.Config.IsButtonInstalled=!0,shoptoolbar._IsButton||!shoptoolbar.Config.UpdateRequired&&!shoptoolbar.Config.DailyUpdateReminder||shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome&&BfrlTool.BrowserStorage.UserToken.then(function(a){shoptoolbar.FetchJson(shoptoolbar.APISite+"/wssimple.asmx/SendCriticalUpdateSuccess",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},
body:shoptoolbar.Format("&UserToken={0}&toolbarversion={1}",a,shoptoolbar.GetToolbarVersion())}).then(function(){shoptoolbar.Config.UpdateRequired&&(shoptoolbar._IsButton||shoptoolbar._IsBF)?chrome.runtime.setUninstallURL("",function(){chrome.management.uninstallSelf()}):(shoptoolbar.Config.UpdateRequired=!1,shoptoolbar.Config.DailyUpdateReminder=!1)})})),0===c.requestHeaders.filter(function(a){return a.name&&"X-BeFrugal-Toolbar"===a.name}).length)return c.requestHeaders.push({name:"X-BeFrugal-Toolbar-"+
(shoptoolbar._IsButton?"Btn":shoptoolbar._IsBF?"BF-Cl":"CV-Cl"),value:shoptoolbar._ToolbarVersion}),{requestHeaders:c.requestHeaders}}else shoptoolbar._IsButton||shoptoolbar.Config.UpdateRequired||!/surveymonkey\.com\/r\/78NXQF9$/i.test(c.url)||shoptoolbar.FetchJson(shoptoolbar.APISite+"/wssimple.asmx/RemoveToolbarCookies",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"UserToken=&toolbarversion=&addonType=BeFrugalButton"}).then(function(a){a&&shoptoolbar._GetApplicationSettings(!0)})},
{urls:["*://*/*"]},["requestHeaders","blocking"]);chrome.runtime.onMessageExternal.addListener(function(c,a,b){if(a.url&&-1!==a.url.search("https?://www.befrugal.com\\b")&&c)"HELLO"===c.Message&&SendSimpleMessage("INSTALL_NOTIFY"),"WELCOME"===c.Message&&browserAdapter._ShowWelcomePage();else if("aikblfcomingajgclpiglcacmlhhcjnl"===a.id||"pgkfdpgoglbncpkldhbjfgnfjaplfnee"===a.id)c.SetHomepage&&shoptoolbar._SetUsageMetrics("befrugalhomepage",1),c.IncrementSearch&&shoptoolbar.IncrementUsageMetrics("searchyahoo")});
var versions="1.11 1.12 1.13 1.14 1.15 1.16 1.17 1.18 1.19".split(" "),AutoApplyApp=AutoApplyApp||function(){var c={PageLoad:"PAGE_LOAD",PreTestingCoupon:"PRETESTING",TestingCoupon:"TESTING_COUPON",FinishedTestingCoupon:"FINISHED_TESTING_COUPONS",MaxSavingsApplied:"MAX_SAVINGS_COUPON_APPLIED",RemovedBackgroundCoupon:"REMOVED_BACKGROUND_COUPON",ShowResults:"SHOW_RESULTS",Terminated:"TERMINATED"},a=[],b=new Map([]),e=[],g=function(a,b,c){AutoApplyApp._GetCurrentURLAndCheckContentScript(a).then(function(d){!d||
""===d||"{}"===d||d&&!d.isContentScriptExist||(AutoApplyApp._CheckoutPageURL=d.url,browserAdapter._SendTabMessage(a,{targetScript:"autoApplyContent.js",action:"readyToApply",regexOverride:b._RegexOverride,couponCount:AutoApplyApp._AllCouponCodes.length,isSuppressed:AutoApplyApp._SuppressApplyCoupons},function(a){if(a){AutoApplyApp.CheckoutPageReady=a.isValid;var d=b&&b._RegexOverride&&("show"==b._RegexOverride.showOrApply||b._RegexOverride.showCoupons&&b._RegexOverride.showCoupons.showUrl&&b._RegexOverride.showCoupons.showUrl.value),
f=b&&b._RegexOverride&&b._RegexOverride.checkoutUrl&&b._RegexOverride.checkoutUrl.value&&AutoApplyApp._AllCouponCodes&&50<AutoApplyApp._AllCouponCodes.length;ShowCouponsApp.IsShowingCoupons=a.isValid&&d||a.isValid&&f||a.isValid&&0<=e.indexOf(parseInt(b._CurrentId))?!0:!1;c(a.isValid&&!a.hasFrame)}}))})},d=function(a,b){if(shoptoolbar._IsButton||!shoptoolbar.Config.IsButtonInstalled){var c=function(){if(AutoApplyApp._CurrentCouponState===AutoApplyApp._CouponState.PageLoad&&b._RetailerInfo&&b._RetailerInfo.CashbackRate&&
!b._CashbackActivated)if(shoptoolbar._IsButton){var c=ButtonApp._GetButtonStorage(b._CurrentId);c&&!c.dialog.neverShow&&ButtonApp.ShowNotification({id:a},b)}else shoptoolbar._ShowNotification(a,b._CurrentId,b._RedirectReason||shoptoolbar._NotifyState._AskClick)};c();var d=!0;b._RetailerInfo.RecentCartPop&&setTimeout(function(){d&&!b._RetailerInfo.AutoApplyCartPop&&(b._RetailerInfo.AutoApplyCartPop=!0,c())},15E3);g(a,b,function(c){d=!1;b._RetailerInfo.AutoApplyCartPop=!1;var e=AutoApplyApp._CurrentCouponState!==
AutoApplyApp._CouponState.PageLoad;!c||e||AutoApplyApp._SuppressApplyCoupons||shoptoolbar._IsRetailerOnHideNotificationsList(AutoApplyApp._retailerId)||(ShowCouponsApp.IsShowingCoupons?(b._AutoApplyActivity&&(b._AutoApplyActivity.applied=!0),ShowCouponsApp._OpenShowCouponsDialog(a)):AutoApplyApp._OpenApplyCouponDialog(a),0>shoptoolbar._RecentPops.indexOf(parseInt(b._CurrentId))&&BfrlTool.BrowserStorage.UserToken.then(function(a){a=shoptoolbar.Format("retailerId={0}&UserToken={1}&toolbarversion={2}",
b._CurrentId,a,shoptoolbar.GetToolbarVersion());shoptoolbar._LoadURI_JSON_POST("https://tbwsjs.befrugal.com/wssimple.asmx/TrackPop",a,function(a){});shoptoolbar._RecentPops.push(parseInt(b._CurrentId))}),b._RetailerInfo.AutoApplyCartPop=!1)})}},f=function(a,b,c){try{var e=!!c.hasCashback<<3|!!c.hasRedirection<<2|!!c.hasCouponCodes<<1|!!c.isCheckoutPage<<0;AutoApplyApp._CurrentCouponHost=c.couponHost;switch(e){case 2:d(a,b);break;case 3:d(a,b);break;case 6:d(a,b);break;case 7:d(a,b);break;case 10:d(a,
b);break;case 11:d(a,b);break;case 14:d(a,b);break;case 15:d(a,b)}}catch(q){}},h=function(a,b){var c=AutoApplyApp._CheckParentURL(a,b);if(c)b._RegexOverride=b._RegexOverride._ParentURL[c];else{var d=AutoApplyApp._CheckCheckoutURL(a,b);a=ShowCouponsApp._CheckShowURL(a,b);d&&0<d.length&&d[0].uri&&(c=d[0].uri);a&&0<a.length&&a[0].uri&&(c=a[0].uri)}return{found:!!c,url:c}},m=function(a,b,c){var d=!1;AutoApplyApp.CheckoutPageReady=!1;ShowCouponsApp.IsShowingCoupons=!1;var k=h(b,c);AutoApplyApp._AutoApplyCheckoutPage=
k.found;var p=(0<=e.indexOf(parseInt(c._CurrentId))||c._RegexOverride&&c._RegexOverride.showCoupons&&c._RegexOverride.showCoupons.showUrl&&c._RegexOverride.showCoupons.showUrl.value)&&ShowCouponsApp._AllPublicCodes.length===AutoApplyApp._AllCouponCodes.length&&c._RetailerInfo&&c._RetailerInfo.CashbackRate&&6<ShowCouponsApp._AllPublicCodes.length;if(0>=AutoApplyApp._AllCouponCodes.length||!c._RegexOverride||p)return AutoApplyApp._AutoApplyCheckoutPage&&c._RegexOverride&&(AutoApplyApp._CurrentCouponState===
AutoApplyApp._CouponState.PageLoad&&!c._CashbackActivated&&c._RetailerInfo&&c._RetailerInfo.CashbackRate&&(shoptoolbar._IsButton?((d=ButtonApp._GetButtonStorage(c._CurrentId))||(d=ButtonApp._InitializeButtonDialogStorage(c._CurrentId)),d&&!d.dialog.neverShow&&(c._RetailerInfo.AutoApplyCartPop=!0,ButtonApp.ShowNotification({id:a},c))):shoptoolbar._ShowNotification(a,c._CurrentId,c._RedirectReason||shoptoolbar._NotifyState._AskClick)),g(a,c,function(a){a&&0>shoptoolbar._RecentPops.indexOf(parseInt(c._CurrentId))&&
BfrlTool.BrowserStorage.UserToken.then(function(a){a=shoptoolbar.Format("retailerId={0}&UserToken={1}&toolbarversion={2}",c._CurrentId,a,shoptoolbar.GetToolbarVersion());shoptoolbar._LoadURI_JSON_POST("https://tbwsjs.befrugal.com/wssimple.asmx/TrackPop",a,function(a){});shoptoolbar._RecentPops.push(parseInt(c._CurrentId))})})),!1;if(!AutoApplyApp._AutoApplyCheckoutPage)AutoApplyApp._OriginalSubtotal=0;else if(AutoApplyApp._AutoApplyCheckoutPage){var m={uri:b,rule:k.url,index:0};if(0===tabDataCollection._TabData.filter(function(a){return a&&
a._CashbackActivated&&a._AutoApplyActivity&&a._AutoApplyActivity.retailerId===c._CurrentId&&a._AutoApplyActivity.info.rule!==m.rule&&a._AutoApplyActivity.applied}).length){if(!c._AutoApplyActivity||c._AutoApplyActivity.retailerId!==c._CurrentId||m.rule!==c._AutoApplyActivity.rule&&!c._AutoApplyActivity.applied)c._AutoApplyActivity={info:m,applied:!1,retailerId:c._CurrentId};b={retailerId:c._CurrentId,cashbackrate:c._RetailerInfo.CashbackRate,codeBoxFinder:null,codeBlacklist:null,regexOverride:c._RegexOverride,
coupons:AutoApplyApp._AllCouponCodes,isCheckoutPage:AutoApplyApp._AutoApplyCheckoutPage,hasRedirection:shoptoolbar._TempRedirectURL||c._Redirect,hasCouponCodes:0<AutoApplyApp._AllCouponCodes.length,hasCashback:""!==c._RetailerInfo.CashbackRate?!0:!1};AutoApplyApp._CurrentCouponState===AutoApplyApp._CouponState.PageLoad?(f(a,c,b),d=!0):g(a,c,function(b){shoptoolbar._IsButton&&(b=ButtonApp._GetButtonStorage(c._CurrentId),!b||b.dialog.neverShow||AutoApplyApp._SuppressApplyCoupons||ButtonApp.ShowNotification({id:a},
c))})}}return d},n=function(a,b,c){a=0>a.indexOf("https")?a.replace("http","https"):a;return new Promise(function(d){var e=new XMLHttpRequest;try{e.addEventListener("load",function(){d(b(e))}),e.addEventListener("error",function(){d(c(e))}),e.open("GET",a),e.overrideMimeType("application/xml"),e.send()}catch(z){d(c(e))}})},r=function(a){return a.responseXML},v=function(a){console.error("(autoApplyApp.js) XMLHttp Error: "+(a.statusText?a.statusText:"File doesn't exist."));return null},t=function(a,
b){var c=a._CurrentId,d=a._CouponBlob;d||console.warn("could not find coupon blob in data");c||console.warn("could not find retailer id in data");var e=function(a){var c=[],e=[],f=[],g=[],k=0;if(d.Coupons&&0<d.Coupons.length){k+=d.Coupons.length;50<k&&(a=!0);for(var h=0;h<d.Coupons.length;h++){var p=d.Coupons[h].Code;c.includes(p)||c.push(p);e.includes(p)||(e.push(p),f.push((d.Coupons[h].Title||"")+"\n"+(d.Coupons[h].Description||"")))}}if(d.AdditionalCodes&&0<d.AdditionalCodes.length)for(k+=d.AdditionalCodes.length,
50<k&&(a=!0),k=0;k<d.AdditionalCodes.length;k++)h=d.AdditionalCodes[k],c.includes(h)||c.push(h),g.includes(h)||g.push(h);b(a,c,e,f,g)},f=function(a,b,c){a?a.getFile(b,{create:!1},function(){c(!0)},function(){c(!1)}):c(!1)},g=function(){for(var b=null,c=d.CodeBoxLogic,f=Object.keys(c).filter(function(a){return 0<=a.indexOf("Retailer")}),g=null,k=5,h=null,p=0;p<versions.length;p++)for(var m=0;m<f.length;m++){var w=c[f[m]];g=w["@checkoutURL"]||g;k=w["@stepsPostCheckout"]||k;h=w["@confirmationURL"]||
h;var q=Object.keys(w).filter(function(a){return 0<=a.indexOf("Overrides")});0<=Object.keys(w[q]).indexOf("0")&&(w=w[q],q=Object.keys(w));for(var A=0;A<q.length;A++)for(var z=w[q[A]],n=Object.keys(z).filter(function(a){return 0<=a.indexOf("version")}),r=0;r<n.length;r++)z[n[r]]===versions[p]&&(b=z)}if(b){var l=function(a,b){if(!a)return null;var c=Object.keys(a).filter(function(a){return 0<=a.indexOf(b)});return 0<c.length?a[c[0]]:null},B=function(a){var b=/true/i;return null===a?!1:"string"===typeof a?
b.test(a):a};c=function(a){return{expropriate:!B(l(a,"DisableExpropriation")),showCoupons:{copyToClipboard:B(l(l(a,"ShowCoupons"),"CopyToClipboard")),showUrl:{key:l(l(l(a,"ShowCoupons"),"ShowURL"),"Key"),value:l(l(l(a,"ShowCoupons"),"ShowURL"),"Value")},readyToCopyIndicator:{value:l(l(l(a,"ShowCoupons"),"ReadyToCopyIndicator"),"Value"),action:l(l(l(a,"ShowCoupons"),"ReadyToCopyIndicator"),"Action")}},multipleCouponSupport:B(l(a,"MultipleCouponSupport")),sameTab:B(l(a,"SameTab")),postData:{submit:{verb:l(l(l(a,
"Post"),"Submit"),"Verb"),url:l(l(l(a,"Post"),"Submit"),"Url"),params:l(l(l(a,"Post"),"Submit"),"Params"),format:l(l(l(a,"Post"),"Submit"),"Format"),headers:l(l(l(a,"Post"),"Submit"),"Headers"),action:l(l(l(a,"Post"),"Submit"),"Action"),reloadAfter:l(l(l(a,"Post"),"Submit"),"ReloadAfter")},cancel:{verb:l(l(l(a,"Post"),"Cancel"),"Verb"),url:l(l(l(a,"Post"),"Cancel"),"Url"),params:l(l(l(a,"Post"),"Cancel"),"Params"),format:l(l(l(a,"Post"),"Cancel"),"Format"),headers:l(l(l(a,"Post"),"Cancel"),"Headers"),
action:l(l(l(a,"Post"),"Cancel"),"Action"),lookup:l(l(l(a,"Post"),"Cancel"),"Lookup"),lookupattribute:l(l(l(a,"Post"),"Cancel"),"LookupAttribute")},read:{verb:l(l(l(a,"Post"),"Read"),"Verb"),url:l(l(l(a,"Post"),"Read"),"Url"),params:l(l(l(a,"Post"),"Read"),"Params"),format:l(l(l(a,"Post"),"Read"),"Format"),headers:l(l(l(a,"Post"),"Read"),"Headers"),action:l(l(l(a,"Post"),"Read"),"Action"),regexLookup:l(l(l(a,"Post"),"Read"),"RegexLookup"),propertyLookup:l(l(l(a,"Post"),"Read"),"PropertyLookup")}},
checkoutUrl:{key:l(l(a,"CheckoutURL"),"Key"),value:l(l(a,"CheckoutURL"),"Value")},readyToApplyIndicator:{value:l(l(a,"ReadyToApplyIndicator"),"Value"),action:l(l(a,"ReadyToApplyIndicator"),"Action")},inputbox:{value:l(l(a,"InputBox"),"Value")},submit:{value:l(l(a,"SubmitButton"),"Value"),action:l(l(a,"SubmitButton"),"Action")},cancel:{value:l(l(a,"Cancel"),"Value"),action:l(l(a,"Cancel"),"Action")},reset:{value:l(l(a,"Reset"),"Value"),action:l(l(a,"Reset"),"Action")},subtotal:{value:l(l(a,"Subtotal"),
"Value"),action:l(l(a,"Subtotal"),"Action")},couponAppliedIndicator:{value:l(l(a,"CouponAppliedIndicator"),"Value"),action:l(l(a,"CouponAppliedIndicator"),"Action")},couponFailedIndicator:{value:l(l(a,"CouponFailedIndicator"),"Value"),action:l(l(a,"CouponFailedIndicator"),"Action")},couponRemovedIndicator:{value:l(l(a,"CouponRemovedIndicator"),"Value"),action:l(l(a,"CouponRemovedIndicator"),"Action")}}};a._RegexOverride=c(b);a._RegexOverride._ParentURL=[];if(null==l(b,"ParentURL")){var t;(t=l(l(b,
"CheckoutURL"),"Value"))||(t=l(l(l(b,"ShowCoupons"),"ShowURL"),"Value"));t&&(a._RegexOverride._ParentURL[t]=c(b))}else for(t in f=Object.keys(b).filter(function(a){return 0<=a.indexOf("ParentURL")})[0],p=Object.keys(b[f]),0<=p.indexOf("@id")&&(b[f]=[b[f]],p=[0]),p)m=b[f][p[t]],a._RegexOverride._ParentURL[m["@id"]]=c(m),a._RegexOverride._ParentURL[m["@id"]].showOrApply=m["@show_or_apply"];a._CheckoutTrackingRegex=g;a._CheckoutTrackingMaxPageCount=k;a._ConfirmationURLRegex=h}e(a._RegexOverride.showCoupons&&
a._RegexOverride.showCoupons.showUrl&&a._RegexOverride.showCoupons.showUrl.value?!0:!1)},k=function(b){n(b,r,v).then(function(b){if(b){var d=shoptoolbar.GetNodeTextContentFactory(b),f=/true/i,k=versions[0];b=shoptoolbar.GetNodeFactory(b);for(var h=0;h<versions.length;h++)b("/x:Stores/x:Retailer[@id="+c+']/x:Overrides[@version="'+versions[h]+'"]')&&(k=versions[h]);k="/x:Stores/x:Retailer[@id="+c+']/x:Overrides[@version="'+k+'"]';h=function(a){return{expropriate:!f.test(d(a+"/x:DisableExpropriation")),
showCoupons:{copyToClipboard:f.test(d(a+"/x:ShowCoupons/x:CopyToClipboard")),showUrl:{key:d(a+"/x:ShowCoupons/x:ShowURL/x:Key"),value:d(a+"/x:ShowCoupons/x:ShowURL/x:Value")},readyToCopyIndicator:{value:d(a+"/x:ShowCoupons/x:ReadyToCopyIndicator/x:Value"),action:d(a+"/x:ShowCoupons/x:ReadyToCopyIndicator/x:Action")}},multipleCouponSupport:f.test(d(a+"/x:MultipleCouponSupport")),sameTab:f.test(d(a+"/x:SameTab")),postData:{submit:{verb:d(a+"/x:Post/x:Submit/x:Verb"),url:d(a+"/x:Post/x:Submit/x:Url"),
params:d(a+"/x:Post/x:Submit/x:Params"),format:d(a+"/x:Post/x:Submit/x:Format"),headers:d(a+"/x:Post/x:Submit/x:Headers"),action:d(a+"/x:Post/x:Submit/x:Action"),reloadAfter:d(a+"/x:Post/x:Submit/x:ReloadAfter")},cancel:{verb:d(a+"/x:Post/x:Cancel/x:Verb"),url:d(a+"/x:Post/x:Cancel/x:Url"),params:d(a+"/x:Post/x:Cancel/x:Params"),format:d(a+"/x:Post/x:Cancel/x:Format"),headers:d(a+"/x:Post/x:Cancel/x:Headers"),action:d(a+"/x:Post/x:Cancel/x:Action"),lookup:d(a+"/x:Post/x:Cancel/x:Lookup"),lookupattribute:d(a+
"/x:Post/x:Cancel/x:LookupAttribute")},read:{verb:d(a+"/x:Post/x:Read/x:Verb"),url:d(a+"/x:Post/x:Read/x:Url"),params:d(a+"/x:Post/x:Read/x:Params"),format:d(a+"/x:Post/x:Read/x:Format"),headers:d(a+"/x:Post/x:Read/x:Headers"),action:d(a+"/x:Post/x:Read/x:Action"),regexLookup:d(a+"/x:Post/x:Read/x:RegexLookup"),propertyLookup:d(a+"/x:Post/x:Read/x:PropertyLookup")}},checkoutUrl:{key:d(a+"/x:CheckoutURL/x:Key"),value:d(a+"/x:CheckoutURL/x:Value")},readyToApplyIndicator:{value:d(a+"/x:ReadyToApplyIndicator/x:Value"),
action:d(a+"/x:ReadyToApplyIndicator/x:Action")},inputbox:{value:d(a+"/x:InputBox/x:Value")},submit:{value:d(a+"/x:SubmitButton/x:Value"),action:d(a+"/x:SubmitButton/x:Action")},cancel:{value:d(a+"/x:Cancel/x:Value"),action:d(a+"/x:Cancel/x:Action")},reset:{value:d(a+"/x:Reset/x:Value"),action:d(a+"/x:Reset/x:Action")},subtotal:{value:d(a+"/x:Subtotal/x:Value"),action:d(a+"/x:Subtotal/x:Action")},couponAppliedIndicator:{value:d(a+"/x:CouponAppliedIndicator/x:Value"),action:d(a+"/x:CouponAppliedIndicator/x:Action")},
couponFailedIndicator:{value:d(a+"/x:CouponFailedIndicator/x:Value"),action:d(a+"/x:CouponFailedIndicator/x:Action")},couponRemovedIndicator:{value:d(a+"/x:CouponRemovedIndicator/x:Value"),action:d(a+"/x:CouponRemovedIndicator/x:Action")}}};a._RegexOverride=h(k);a._RegexOverride._ParentURL=[];if(null==b(k+"/x:ParentURL")){var p;(p=d(k+"/x:CheckoutURL/x:Value"))||(p=d(k+"/x:ShowCoupons/x:ShowURL/x:Value"));p&&(a._RegexOverride._ParentURL[p]=h(k))}else{p="";for(var m,w;m=b(k+"/x:ParentURL"+p);)w=m.id,
a._RegexOverride._ParentURL[w]=h(k+'/x:ParentURL[@id="'+w+'"]'),a._RegexOverride._ParentURL[w].showOrApply=m.attributes.show_or_apply.value,p+='[not(@id="'+w+'")]'}k=b("/x:Stores/x:Retailer[@id="+c+"]").getAttribute("checkoutURL");a._CheckoutTrackingRegex=k?new RegExp(k):null;k=b("/x:Stores/x:Retailer[@id="+c+"]").getAttribute("stepsPostCheckout");a._CheckoutTrackingMaxPageCount=k?k:5;b=b("/x:Stores/x:Retailer[@id="+c+"]").getAttribute("confirmationURL");a._ConfirmationURLRegex=b?new RegExp(b):null;
e(a._RegexOverride.showCoupons&&a._RegexOverride.showCoupons.showUrl&&a._RegexOverride.showCoupons.showUrl.value?!0:!1)}else g()}).catch(function(a){})},h=function(a){a?shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?k(chrome.runtime.getURL("AutoApplyResources/LocalRetailerList/retailers.xml")):k(browser.runtime.getURL("AutoApplyResources/LocalRetailerList/retailers.xml")):g()};shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?chrome.runtime.getPackageDirectoryEntry(function(a){f(a,"AutoApplyResources/LocalRetailerList/retailers.xml",
function(a){h(a)})}):fetch(browser.runtime.getURL("AutoApplyResources/LocalRetailerList/retailers.xml")).then(function(a){if(a.ok)h(!0);else throw Error("Ignore This");}).catch(function(a){h(!1)})},u=function(a,b){return a.value<b.value?1:a.value>b.value?-1:0},x=function(a,b){var c=AutoApplyApp._SavingsCouponsAndValues&&AutoApplyApp._SavingsCouponsAndValues.length>=AutoApplyApp._MaxCouponIndex?AutoApplyApp._SavingsCouponsAndValues.sort(u).slice(0,AutoApplyApp._MaxCouponIndex+1):[],d=0<c.length?c.reduce(function(a,
b){return a+b.value},0):null,e=d?parseFloat(d):null,f=0<c.length&&0<e?c.map(function(a){return a.code}).join(","):null;0===AutoApplyApp._SavingsCouponsAndValues.length&&0<AutoApplyApp._LastAppliedValues.Codes.length&&AutoApplyApp._LastAppliedValues.RetailerId===AutoApplyApp._retailerId?(c=AutoApplyApp._OriginalSubtotal-(e?e:0)-AutoApplyApp._LastAppliedValues.EndTotal,.01>c&&-.01<c&&(f=AutoApplyApp._LastAppliedValues.Codes,e=AutoApplyApp._LastAppliedValues.Discount,AutoApplyApp._OriginalSubtotal=AutoApplyApp._LastAppliedValues.OriginalSubtotal)):
0<AutoApplyApp._SavingsCouponsAndValues.length&&0<e&&(AutoApplyApp._LastAppliedValues.EndTotal=AutoApplyApp._OriginalSubtotal-e,AutoApplyApp._LastAppliedValues.Codes=f,AutoApplyApp._LastAppliedValues.Discount=e,AutoApplyApp._LastAppliedValues.OriginalSubtotal=AutoApplyApp._OriginalSubtotal,AutoApplyApp._LastAppliedValues.RetailerId=AutoApplyApp._retailerId);AutoApplyApp._CouponApplyResult.Discount=e?e.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,"):"";AutoApplyApp._CouponApplyResult.HasApplied=!0;
AutoApplyApp._CouponApplyResult.CashbackRate=b;AutoApplyApp._CouponApplyResult.MaxSavings=f;0<=AutoApplyApp._activeTabs.indexOf(a)&&(AutoApplyApp._activeTabs.splice(AutoApplyApp._activeTabs.indexOf(a),1),(b=AutoApplyApp._activeDuplicateTabs.get(a))&&AutoApplyApp._activeDuplicateTabs.delete(a)&&AutoApplyApp._activeDuplicateTabs.has(b)&&browserAdapter.CloseTab(b));var g=tabDataCollection._Get(a);browserAdapter._SendTabMessage(a,{targetScript:"autoApplyContent.js",action:"getCurrentURL"},function(b){shoptoolbar.GetReferralLinks(function(c){var e;
shoptoolbar.LoadURI("https://"+shoptoolbar.Site+"/BefrugalSiteWS.asmx/ShowTermsForRetailerNoLinks?"+("retailerid="+AutoApplyApp._retailerId),function(c){e=shoptoolbar.GetNodeTextContentFactory(c);cbTerms=e("/x:string");var k="bonusCashback="+encodeURIComponent(shoptoolbar._RefLinks.BonusAmount)+"&bonusFriendGets="+encodeURIComponent(shoptoolbar._RefLinks.SignupBonus)+"&appliedCode="+encodeURIComponent(f)+"&cashbackRate="+encodeURIComponent(AutoApplyApp._CouponApplyResult.CashbackRate)+"&discount="+
encodeURIComponent(AutoApplyApp._CouponApplyResult.Discount)+"&redirectUrl="+encodeURIComponent(g._Redirect)+"&currentURL="+encodeURIComponent(b)+"&RAFToken="+encodeURIComponent(BfrlTool.Prefs.RAFToken)+"&originalSubtotal="+encodeURIComponent(AutoApplyApp._OriginalSubtotal)+"&cbTerms="+encodeURIComponent(cbTerms)+"&ToolbarType="+(shoptoolbar.GetIsBF()?"1":"2");BfrlTool.BrowserStorage.WebExtensionsRateUs.then(function(b){BfrlTool.BrowserStorage.RateUsFlagCounter.then(function(c){hasNotRatedUs=!b;var e=
1===c%3;browserAdapter.GetTab(a,function(a){a&&a.id&&(g._CashbackActivated=!0,g._CashbackActivationChangedTime=(new Date).getTime(),g.forceHideNotify=!0,shoptoolbar._RedirectIFrame(g._Redirect,a.id),shoptoolbar._PostShowNotifications(a.id),ButtonApp.HideButton(a),ButtonApp.HideDialog(a))});AutoApplyApp._CouponApplyResult.CashbackRate&&0<AutoApplyApp._CouponApplyResult.CashbackRate.length?d||AutoApplyApp._CouponApplyResult.Discount&&0<AutoApplyApp._CouponApplyResult.Discount.length?(hasNotRatedUs&&
e&&(shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome||shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox&&shoptoolbar._IsButton)?browserAdapter._SendTabMessage(a,{targetScript:"autoApplyContent.js",action:"iframeSetURL",newURL:"AutoApplyResources/inject/couponsResultRate.html?"+k,applyBlackout:!0,centered:!0,newWidth:476,newHeight:535,resize:!0,clearWrapper:!0}):browserAdapter._SendTabMessage(a,{targetScript:"autoApplyContent.js",action:"iframeSetURL",newURL:"AutoApplyResources/inject/couponsResultShare.html?"+
k,applyBlackout:!0,centered:!0,newWidth:476,newHeight:490,resize:!0,clearWrapper:!0}),BfrlTool.BrowserStorage.RateUsFlagCounter=c+1):browserAdapter._SendTabMessage(a,{targetScript:"autoApplyContent.js",action:"iframeSetURL",newURL:"AutoApplyResources/inject/couponsNotFound.html?"+k,applyBlackout:!0,centered:!0,newWidth:476,newHeight:476,resize:!0,clearWrapper:!0}):d||AutoApplyApp._CouponApplyResult.Discount&&0<AutoApplyApp._CouponApplyResult.Discount.length?(hasNotRatedUs&&e&&(shoptoolbar.GetBrowser()===
shoptoolbar.Browsers.Chrome||shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox&&shoptoolbar._IsButton)?browserAdapter._SendTabMessage(a,{targetScript:"autoApplyContent.js",action:"iframeSetURL",newURL:"AutoApplyResources/inject/couponsResultNoCashbackRate.html?"+k,applyBlackout:!0,centered:!0,newWidth:476,newHeight:485,resize:!0,clearWrapper:!0}):browserAdapter._SendTabMessage(a,{targetScript:"autoApplyContent.js",action:"iframeSetURL",newURL:"AutoApplyResources/inject/couponsResultNoCashbackShare.html?"+
k,applyBlackout:!0,centered:!0,newWidth:476,newHeight:450,resize:!0,clearWrapper:!0}),BfrlTool.BrowserStorage.RateUsFlagCounter=c+1):browserAdapter._SendTabMessage(a,{targetScript:"autoApplyContent.js",action:"iframeSetURL",newURL:"AutoApplyResources/inject/couponsNotFoundNoRate.html?"+k,applyBlackout:!0,centered:!0,newWidth:476,newHeight:375,resize:!0,clearWrapper:!0});AutoApplyApp._ResetState(!1)})})})})})},y=function(a,b){AutoApplyApp._CurrentCouponState=AutoApplyApp._CouponState.PageLoad;var c=
BfrlTool.Prefs.Guest?"":encodeURIComponent(BfrlTool.Prefs.UserName);browserAdapter._SendTabMessage(b,{targetScript:"autoApplyContent.js",action:"iframeReportSetURL",applyBlackout:!1,centered:!0,resize:!0,newURL:a.data+("?username="+c),newWidth:600,newHeight:528,clearWrapper:!0},function(){})};return{_activeTabs:a,_activeDuplicateTabs:b,_CouponState:c,_CouponApplyResult:{State:0,ErrorMessage:"",CashbackRate:"",HasApplied:!1,Discount:"",MaxSavings:""},_CurrentCouponState:c.PageLoad,_CurrentCouponHost:"",
_CurrentCouponIndex:0,_AutoApplyCheckoutPage:!1,_LatestCouponAppliedIndex:-1,_MaxCouponIndex:0,_SavingsCouponsAndValues:[],_LastAppliedValues:{Codes:"",EndTotal:0,Discount:0,OriginalSubtotal:0,RetailerId:0},_AllCouponCodes:[],_OriginalSubtotal:0,_CheckoutPageURL:"",CheckoutPageReady:!1,_SuppressApplyCoupons:!1,_IncrementingCouponIndexGuard:!1,_rateUsFlagCounter:0,_retailerId:0,ReadyCheck:function(a){browserAdapter.GetActiveTab(!0,function(b){var c=tabDataCollection._Get(b.id);g(b.id,c,a)})},_InjectedDialogPosition:{},
_InitializeInjectedDialogPosition:function(a){AutoApplyApp._InjectedDialogPosition[a]={};AutoApplyApp._InjectedDialogPosition[a].top=20;AutoApplyApp._InjectedDialogPosition[a].left="";AutoApplyApp._InjectedDialogPosition[a].initialized=!0;return AutoApplyApp._InjectedDialogPosition[a]},_GetInjectedDialogPosition:function(a){return AutoApplyApp._InjectedDialogPosition[a]?(AutoApplyApp._InjectedDialogPosition[a].initialized&&delete AutoApplyApp._InjectedDialogPosition[a].initialized,AutoApplyApp._InjectedDialogPosition[a]):
AutoApplyApp._InitializeInjectedDialogPosition(a)},_GetCurrentURLAndCheckContentScript:function(a){return(new Promise(function(b,c){browserAdapter._ExecuteScriptCode(a,'JSON.stringify({ url: window.location.href, isContentScriptExist: (typeof DocumentAccess !== "undefined") });',function(a){shoptoolbar._Browser===shoptoolbar.Browsers.Chrome?chrome.runtime.lastError?c(chrome.runtime.lastError.message):Array.isArray(a)?b(JSON.parse(a[0])):b(null):browser.runtime.lastError?c(browser.runtime.lastError.message):
Array.isArray(a)?b(JSON.parse(a[0])):b(null)})})).catch(function(a){console.log("(debug test) ",a)})},_CheckCheckoutURL:function(a,b){var c;if(c=AutoApplyApp._CheckParentURL(a,b))return c;b=b._RegexOverride;var d=[];if(b&&b.checkoutUrl&&b.checkoutUrl.value){var e=b.checkoutUrl.value?b.checkoutUrl.value:"befrugal_none",f=function(b,c){var e=new RegExp(b,"i"),f=new RegExp(b.replace(/[^a-zA-Z0-9]/gi,"\\$&"),"i"),g=!1,k=!1;try{g=b.match(a)}catch(C){g=!1}try{k=a.match(b)}catch(C){k=!1}b.length>=a.length&&
(e.test(a)||f.test(a)||b.startsWith(a)||-1<b.indexOf(a)||g&&0<g.length)?d.push({uri:a,rule:b,index:c}):(e.test(a)||f.test(a)||a.startsWith(b)||-1<a.indexOf(b)||k&&0<k.length)&&d.push({uri:a,rule:b,index:c})};c=function(){var a=e.split(/(,\s)/gi);a=a.filter(function(a){return", "!==a});for(var b=0;b<a.length;b++)f(a[b],b)};switch(b.checkoutUrl.key?b.checkoutUrl.key:"befrugal_none"){case "[Disabled]":break;case "[MultipleURLs]":c();break;default:f(e,0)}}return[].concat($jscomp.arrayFromIterable(new Set(d)))},
_CheckParentURL:function(a,b){if(!b._RegexOverride)return null;for(var c in b._RegexOverride._ParentURL)if(b=c.replace(/\//g,"\\/"),b=b.replace(/,\s/g,"|"),parsedURLRegex=new RegExp(b,"i"),a.match(parsedURLRegex))return c;return null},_CheckApplyOrShow:function(a){if(!a._RegexOverride)return null;a=a._RegexOverride;return a.showOrApply?a.showOrApply:a.showCoupons&&a.showCoupons.showUrl&&a.showCoupons.showUrl.value||a.isShowCoupons?"show":a.checkoutUrl&&a.checkoutUrl.value||a.isAutoApply?"apply":null},
_StartApplication:function(a,b,d,e){e||(e=function(a){});if(!shoptoolbar._DISABLE_AUTO_APPLY_COUPONS){window.sessionStorage.AutoApplyInitialized||(AutoApplyApp._Init(),window.sessionStorage.AutoApplyInitialized=!0);AutoApplyApp._SuppressApplyCoupons=d;var f=tabDataCollection._Get(a);d=f._CurrentId;var g=!f._RegexOverride,k=d&&AutoApplyApp._retailerId!==d,h=!!/http/i.test(b)&&d&&(f._CouponBlob&&f._CouponBlob.CodeBoxLogic||!1);h&&(g||k)?AutoApplyApp._CurrentCouponState!=c.Terminated&&AutoApplyApp._CurrentCouponState!=
c.PageLoad?(AutoApplyApp.CheckoutPageReady=!1,ShowCouponsApp.IsShowingCoupons=!1,e(!1)):(AutoApplyApp._retailerId=d,t(f,function(c,d,g,k,h){AutoApplyApp._AllCouponCodes=d;ShowCouponsApp.IsShowingCoupons=c;ShowCouponsApp._AllCouponCodes=g;ShowCouponsApp._AllCouponDescriptions=k;ShowCouponsApp._AllPublicCodes=h;c=m(a,b,f);e(c)})):h?(d=m(a,b,f),e(d)):(AutoApplyApp.CheckoutPageReady=!1,ShowCouponsApp.IsShowingCoupons=!1,e(!1))}},_StartTesting:function(a,b){AutoApplyApp._CurrentCouponState=AutoApplyApp._CouponState.TestingCoupon;
var c="?index="+(AutoApplyApp._CurrentCouponIndex+1)+"&total="+AutoApplyApp._AllCouponCodes.length+"&code="+encodeURIComponent(AutoApplyApp._AllCouponCodes[AutoApplyApp._CurrentCouponIndex])+"&retailerId="+b._CurrentId+"&action=updateProgress";browserAdapter.GetTab(a,function(b){var d={url:b.url};shoptoolbar.NewTabSettings.CashbackPostionDefault||(d.top=20456,d.left=20456,d.width=1,d.height=1);browserAdapter.CreateNewWindow(d,function(d){browserAdapter.UpdateWindow(b.windowId,{focused:!0},function(b){tabDataCollection._Get(d.tabs[0].id)._IsAutoApplyingBackgroundTab=
!0;AutoApplyApp._activeDuplicateTabs.set(a,d.tabs[0].id);browserAdapter._SendTabMessage(a,{targetScript:"autoApplyContent.js",action:"iframeSetURL",newURL:"AutoApplyResources/inject/couponsTesting.html"+c,applyBlackout:!0,centered:!0,newWidth:420,newHeight:320,resize:!0,clearWrapper:!0},function(){})})})})},_TestPrepareCoupons:function(b){try{var c=tabDataCollection._Get(b);browserAdapter.GetTab(b,function(a){a&&a.id&&(c._CashbackActivated=!0,c._CashbackActivationChangedTime=(new Date).getTime(),
c.forceHideNotify=!0,shoptoolbar._WakeUpCouponBadge(c),shoptoolbar._RedirectIFrame(c._Redirect,a.id),shoptoolbar._PostShowNotifications(a.id),ButtonApp.HideButton(a),ButtonApp.HideDialog(a))});0>a.indexOf(b)&&a.push(b);AutoApplyApp._CurrentCouponState=AutoApplyApp._CouponState.PreTestingCoupon;AutoApplyApp._CurrentCouponIndex=0;AutoApplyApp._LatestCouponAppliedIndex=-1;AutoApplyApp._MaxCouponIndex=0;AutoApplyApp._SavingsCouponsAndValues=[];AutoApplyApp._OriginalSubtotal=0;browserAdapter._SendTabMessage(b,
{targetScript:"autoApplyContent.js",action:"getTotal",regexOverride:c._RegexOverride},function(a){if(0<a){var d=function(a){var d="?index="+(AutoApplyApp._CurrentCouponIndex+1)+"&total="+a.length+"&code="+encodeURIComponent(a[AutoApplyApp._CurrentCouponIndex])+"&retailerId="+c._CurrentId+"&action=updateProgress",e=c._RegexOverride.postData;e&&e.submit&&e.submit.verb&&0<e.submit.verb.length&&(!e.submit.action||0===e.submit.action.length)&&(!e.submit.reloadAfter||0===e.submit.reloadAfter.length)||shoptoolbar.NewTabSettings.UseNewTabCashback||
c._RegexOverride.sameTab?(AutoApplyApp._CurrentCouponState=AutoApplyApp._CouponState.TestingCoupon,browserAdapter.GetTab(b,function(c){browserAdapter._SendTabMessage(b,{targetScript:"autoApplyContent.js",action:"iframeSetURL",newURL:"AutoApplyResources/inject/couponsTesting.html"+d,applyBlackout:!0,centered:!0,newWidth:420,newHeight:320,couponCodes:a,resize:!0,clearWrapper:!0},function(){})})):browserAdapter._SendTabMessage(b,{targetScript:"autoApplyContent.js",action:"standaloneCouponRemoval",retailerid:c._CurrentId,
regexOverride:c._RegexOverride,redirected:AutoApplyApp._SuppressApplyCoupons,applied:AutoApplyApp._CurrentCouponIndex===AutoApplyApp._LatestCouponAppliedIndex},function(){})};if(c._CurrentId!==AutoApplyApp._retailerId)AutoApplyApp._retailerId=c._CurrentId,AutoApplyApp._AllCouponCodes=[],t(c,function(a,b,c,e,f){AutoApplyApp._AllCouponCodes=b;ShowCouponsApp.isShowingCoupons=a;ShowCouponsApp._AllCouponCodes=c;ShowCouponsApp._AllCouponDescriptions=e;ShowCouponsApp._AllPublicCodes=f;d(b)});else{a=!1;var e=
c._RegexOverride;e&&e.cancel&&(e=e.cancel.action?e.cancel.action:"")&&0<e.length&&0<=e.indexOf(":ApplyEmpty")&&(a=!0);a?browserAdapter._SendTabMessage(b,{targetScript:"autoApplyContent.js",action:"applyEmpty",retailerId:c._CurrentId,regexOverride:c._RegexOverride},function(){d(AutoApplyApp._AllCouponCodes)}):d(AutoApplyApp._AllCouponCodes)}}else browserAdapter._SendTabMessage(b,{targetScript:"autoApplyContent.js",action:"iframeSetURL",newURL:"AutoApplyResources/inject/couponsNoItems.html",clearWrapper:!0,
newWidth:420,newHeight:320},function(){})})}catch(w){}},_TestValidMessages:function(a){try{var b=tabDataCollection._Get(a),c=!AutoApplyApp._activeDuplicateTabs.get(a),d={index:AutoApplyApp._CurrentCouponIndex+1,total:AutoApplyApp._AllCouponCodes.length,code:encodeURIComponent(AutoApplyApp._AllCouponCodes[AutoApplyApp._CurrentCouponIndex]),retailerId:b._CurrentId,action:"updateProgress",noincrement:!0};if(c&&AutoApplyApp._CurrentCouponIndex<AutoApplyApp._AllCouponCodes.length){var e="?index="+(AutoApplyApp._CurrentCouponIndex+
1)+"&total="+AutoApplyApp._AllCouponCodes.length+"&code="+encodeURIComponent(AutoApplyApp._AllCouponCodes[AutoApplyApp._CurrentCouponIndex])+"&retailerId="+b._CurrentId+"&action=updateProgress&noincrement=true";browserAdapter._SendTabMessage(a,{targetScript:"autoApplyContent.js",action:"iframeSetURL",newURL:"AutoApplyResources/inject/couponsTesting.html"+e,applyBlackout:!0,message:d,centered:!0,newWidth:420,newHeight:320,resize:!0,clearWrapper:!1},function(){})}else AutoApplyApp._CurrentCouponIndex<
AutoApplyApp._AllCouponCodes.length?browserAdapter._SendTabMessage(a,{targetScript:"couponsTesting.js",action:"iframeAdjustProgress",message:d,applyBlackout:!0,centered:!0,newWidth:420,newHeight:320,resize:!0,clearWrapper:!1},function(){}):(AutoApplyApp._CurrentCouponState=AutoApplyApp._CouponState.FinishedTestingCoupon,0<AutoApplyApp._AllCouponCodes.length&&browserAdapter._SendTabMessage(a,{targetScript:"autoApplyContent.js",action:"iframeSetURL",newURL:"AutoApplyResources/inject/couponsTesting.html"+
("?totalCodes="+AutoApplyApp._AllCouponCodes.length+"&retailerId="+b._CurrentId+"&action=prepareDataSuccess"),applyBlackout:!0,centered:!0,newWidth:420,newHeight:320,resize:!0,clearWrapper:!0},function(){}))}catch(z){}},_OpenApplyCouponDialog:function(a){var b=tabDataCollection._Get(a);if(!b._RetailerInfo||!b._RetailerInfo.SuppressNotification){var c=AutoApplyApp._GetInjectedDialogPosition(b._CurrentId),d=function(a,b,c){b=a.indexOf(b)+b.length;return a.substring(b,a.indexOf(c))},e=function(a,b,c){for(var d=
[];0<a.length;){var e=a.indexOf(b);if(0>e)break;e+=b.length;var f=a.indexOf(c,e);if(0>f){d.push(a.substring(e,a.length));break}d.push(a.substring(e,f));a=a.substring(f+c.length,a.length)}return d};(function(a){0>a.indexOf("https")&&(a=a.replace("http","https"));return new Promise(function(b,c){var d=new XMLHttpRequest;d.addEventListener("load",function(a){b(d.responseText)});d.addEventListener("error",function(a){c("(autoApplyApp.js) XMLHttpRequest Error: "+d.statusText)});d.open("GET",a);d.send()})})(browserAdapter._GetURL("AutoApplyResources/inject/couponsFound.html")).then(function(f){var g=
d(f,"<head>","</head>"),k=d(f,"<body>","</body>");f=e(k,'src="','"');for(var h=browserAdapter._GetURL("AutoApplyResources/inject/"),m=0;m<f.length;m++)k=k.replace(f[m],function(a){return h+a});shoptoolbar._GetNoCashBackExtension(function(d){d=d?null:b._RetailerInfo.CashbackRate;browserAdapter._SendTabMessage(a,{targetScript:"autoApplyContent.js",action:"draggableDivInsert",innerHTML:g+k,id:"bfrl_divCouponsFound",cashback:d,count:AutoApplyApp._AllCouponCodes.length,isAutoApplyCoupons:!0,newWidth:420,
newHeight:300+(d?40:0),newTop:c.top,newLeft:c.left,resize:!0,clearWrapper:!1,move:!0,isCouponViewer:!shoptoolbar._IsBF,styleCss:chrome.runtime.getURL("/fonts/Roboto.css")},function(){shoptoolbar._IsButton&&ButtonApp.HideDialog({id:a})})})}).catch(function(a){console.error(a)})}},_TestIncrementCouponIndex:function(a){AutoApplyApp._IncrementingCouponIndexGuard||(++AutoApplyApp._CurrentCouponIndex,AutoApplyApp._IncrementingCouponIndexGuard=!0);AutoApplyApp._CurrentCouponIndex>=AutoApplyApp._AllCouponCodes.length&&
(AutoApplyApp._CurrentCouponState=AutoApplyApp._CouponState.FinishedTestingCoupon);a&&(AutoApplyApp._LatestCouponAppliedIndex=-1)},_TestIncrementMaxSavingsIndex:function(a){AutoApplyApp._IncrementingCouponIndexGuard||(a?AutoApplyApp._MaxCouponIndex=0:++AutoApplyApp._MaxCouponIndex,AutoApplyApp._IncrementingCouponIndexGuard=!0);AutoApplyApp._MaxCouponIndex>=AutoApplyApp._SavingsCouponsAndValues.length&&(AutoApplyApp._CurrentCouponState=AutoApplyApp._CouponState.MaxSavingsApplied)},_PageLoad:function(a){try{var b=
tabDataCollection._Get(a.id),c=AutoApplyApp._activeDuplicateTabs.has(a.id),d=!!AutoApplyApp.getPrimaryTabIdFromDuplicate(a.id),e=0<=AutoApplyApp._activeTabs.indexOf(a.id);switch(AutoApplyApp._CurrentCouponState){case AutoApplyApp._CouponState.PageLoad:case AutoApplyApp._CouponState.Terminated:AutoApplyApp._Pageload_ExpropriateCheck(a,b);break;case AutoApplyApp._CouponState.PreTestingCoupon:AutoApplyApp._StartTesting(a.id,b);break;case AutoApplyApp._CouponState.TestingCoupon:c||d||e?AutoApplyApp._Pageload_TestingCoupon(a,
b):AutoApplyApp._Pageload_ExpropriateCheck(a,b);break;case AutoApplyApp._CouponState.RemovedBackgroundCoupon:case AutoApplyApp._CouponState.FinishedTestingCoupon:c||d||e?AutoApplyApp._Pageload_FinishedTestingCoupon(a,b):AutoApplyApp._Pageload_ExpropriateCheck(a,b);break;case AutoApplyApp._CouponState.MaxSavingsApplied:c||d||e?AutoApplyApp._Pageload_MaxSavingsApplied(a,b):AutoApplyApp._Pageload_ExpropriateCheck(a,b)}}catch(z){}},_Pageload_ExpropriateCheck:function(a,b){AutoApplyApp._AutoApplyCheckoutPage=
h(a.url,b).found;AutoApplyApp._AutoApplyCheckoutPage&&BfrlTool.BrowserStorage.UserToken.then(function(c){BfrlTool.BrowserStorage.AllowSubmissions.then(function(d){browserAdapter._SendTabMessage(a.id,{targetScript:"autoApplyContent.js",action:"expropriate",enabled:d,regexOverride:b._RegexOverride,originalSubtotal:AutoApplyApp._OriginalSubtotal,retailerId:b._CurrentId,codes:ShowCouponsApp._AllCouponCodes,userToken:c,toolbarVersion:shoptoolbar._ToolbarVersion},function(){})})})},_Pageload_TestingCoupon:function(a,
b){a=AutoApplyApp.getPrimaryTabIdFromDuplicate(a.id)||a.id;AutoApplyApp._TestValidMessages(a)},_Pageload_FinishedTestingCoupon:function(a,b){var c=AutoApplyApp.getPrimaryTabIdFromDuplicate(a.id)||a.id,d=AutoApplyApp._SavingsCouponsAndValues&&0<AutoApplyApp._SavingsCouponsAndValues.length?AutoApplyApp._SavingsCouponsAndValues.sort(u):[],e=d.length>=AutoApplyApp._MaxCouponIndex+1?d[AutoApplyApp._MaxCouponIndex].code:null;AutoApplyApp._IncrementingCouponIndexGuard&&(AutoApplyApp._IncrementingCouponIndexGuard=
!1);d=function(d,f){browserAdapter._SendTabMessage(c,{targetScript:"autoApplyContent.js",action:"iframeVisibile"},function(a){a?browserAdapter._SendTabMessage(c,{targetScript:"couponsTesting.js",action:"iframeAdjustProgress",message:"applyingMax",applyBlackout:!0,centered:!0,newWidth:420,newHeight:320,resize:!0,clearWrapper:!0},function(){}):browserAdapter._SendTabMessage(c,{targetScript:"autoApplyContent.js",action:"iframeSetURL",newURL:"AutoApplyResources/inject/couponsTesting.html?action=applyingMax",
applyBlackout:!0,centered:!0,newWidth:420,newHeight:320,resize:!0,clearWrapper:!0},function(){})});browserAdapter._SendTabMessage(c,{targetScript:"autoApplyContent.js",action:"applyMaxSavings",code:e,previousCode:AutoApplyApp._AllCouponCodes[AutoApplyApp._CurrentCouponIndex-1],retailerid:b._CurrentId,regexOverride:b._RegexOverride,maxApplied:d,redirected:AutoApplyApp._SuppressApplyCoupons,originalSubtotal:AutoApplyApp._OriginalSubtotal,currentIndex:AutoApplyApp._MaxCouponIndex,sameTab:c===a.id},function(){f&&
c!==a.id&&(AutoApplyApp._activeDuplicateTabs.has(a.id)&&AutoApplyApp._activeDuplicateTabs.delete(a.id),browserAdapter.CloseTab(a.id,function(){}))})};if(c===a.id){var f=AutoApplyApp._MaxCouponIndex===AutoApplyApp._LatestCouponAppliedIndex;b._RegexOverride.multipleCouponSupport||f||(f=AutoApplyApp._AllCouponCodes[AutoApplyApp._CurrentCouponIndex]===e);d(f,!1)}else AutoApplyApp._CurrentCouponState===AutoApplyApp._CouponState.RemovedBackgroundCoupon?(AutoApplyApp._CurrentCouponState=AutoApplyApp._CouponState.FinishedTestingCoupon,
d(!1,!0)):browserAdapter._SendTabMessage(a.id,{targetScript:"autoApplyContent.js",action:"removeDuplicateTabCoupon",retailerid:b._CurrentId,regexOverride:b._RegexOverride,redirected:AutoApplyApp._SuppressApplyCoupons,applied:AutoApplyApp._CurrentCouponIndex===AutoApplyApp._LatestCouponAppliedIndex})},_Pageload_MaxSavingsApplied:function(a,b){shoptoolbar._GetNoCashBackExtension(function(c){x(a.id,c?null:b._RetailerInfo.CashbackRate)})},_Message_RememberMaxSavingsCoupon:function(a,b){AutoApplyApp._SavingsCouponsAndValues&&
AutoApplyApp._SavingsCouponsAndValues.push({code:a,value:b})},_Message_ApplyCouponBackgroundTestApply:function(a){var b=AutoApplyApp._activeDuplicateTabs.get(a),c=!b;c&&(b=a);var d=tabDataCollection._Get(b);d._RegexOverride||(d._RegexOverride=tabDataCollection._Get(a)._RegexOverride);AutoApplyApp._CurrentCouponIndex<AutoApplyApp._AllCouponCodes.length?(AutoApplyApp._IncrementingCouponIndexGuard&&(AutoApplyApp._IncrementingCouponIndexGuard=!1),browserAdapter._SendTabMessage(b,{targetScript:"autoApplyContent.js",
action:"testApplyCoupon",currentIndex:AutoApplyApp._CurrentCouponIndex,currentCode:AutoApplyApp._AllCouponCodes[AutoApplyApp._CurrentCouponIndex],retailerId:d._CurrentId,currentState:AutoApplyApp._CurrentCouponState,regexOverride:d._RegexOverride,originalSubtotal:AutoApplyApp._OriginalSubtotal,applied:AutoApplyApp._CurrentCouponIndex===AutoApplyApp._LatestCouponAppliedIndex,sameTab:c},function(){})):AutoApplyApp._CurrentCouponState=AutoApplyApp._CouponState.FinishedTestingCoupon},_Message_SetCouponState:function(a){switch(a.data){case "PAGE_LOAD":a=
AutoApplyApp._CouponState.PageLoad;break;case "TESTING_COUPON":a=AutoApplyApp._CouponState.TestingCoupon;break;case "FINISHED_TESTING_COUPONS":a=AutoApplyApp._CouponState.FinishedTestingCoupon;break;case "MAX_SAVINGS_COUPON_APPLIED":a=AutoApplyApp._CouponState.MaxSavingsApplied;break;case "SHOW_RESULTS":a=AutoApplyApp._CouponState.ShowResults;break;case "TERMINATED":AutoApplyApp._ResetState(!0);return;case "REMOVED_BACKGROUND_COUPON":a=AutoApplyApp._CouponState.RemovedBackgroundCoupon;break;default:a=
AutoApplyApp._CouponState.PageLoad}AutoApplyApp._CurrentCouponState=a},_Message_iframeResize:function(a,b,c){browserAdapter._SendTabMessage(b,{targetScript:"autoApplyContent.js",action:"iframeResize",newWidth:a.data.newWidth,newHeight:a.data.newHeight,centered:a.data.centered},function(){});c()},_Message_iframeClose:function(a,b,c){try{0<=AutoApplyApp._activeTabs.indexOf(b)&&AutoApplyApp._activeTabs.splice(AutoApplyApp._activeTabs.indexOf(b),1);var d=AutoApplyApp._activeDuplicateTabs.get(b);d&&AutoApplyApp._activeDuplicateTabs.delete(b)&&
"shoptoolbar.js"!=a.sourceScript&&browserAdapter.CloseTab(d);var e=tabDataCollection._Get(b);d=!1;switch(a.data.type){case "2":d=!0;AutoApplyApp._ResetState(!0);c();break;case "6":d=!0;break;case "7":d=!0;AutoApplyApp._ResetState(!0);browserAdapter._SendTabMessage(b,{targetScript:"autoApplyContent.js",action:"RemoveBlackoutDiv"},c);break;case "report":browserAdapter._SendTabMessage(b,{targetScript:"autoApplyContent.js",action:"iframeClose",type:a.data.type},c);AutoApplyApp._ResetState(!0);return}a.data.fromCouponsFound&&
(d=!1);d&&BfrlTool.BrowserStorage.UserToken.then(function(d){browserAdapter._SendTabMessage(b,{sourceScript:a.sourceScript,targetScript:"autoApplyContent.js",action:"iframeClose",type:a.data.type,regexOverride:e._RegexOverride,originalSubtotal:AutoApplyApp._OriginalSubtotal,retailerId:e._CurrentId,codes:ShowCouponsApp._AllCouponCodes,userToken:d,toolbarVersion:shoptoolbar._ToolbarVersion},c)});ShowCouponsApp.IsShowingCoupons&&e._CashbackActivated&&browserAdapter.GetTab(b,function(a){a&&a.id&&(e._CashbackActivated=
!0,e._CashbackActivationChangedTime=(new Date).getTime(),e.forceHideNotify=!0,shoptoolbar._WakeUpCouponBadge(e),shoptoolbar._RedirectIFrame(e._Redirect,a.id),shoptoolbar._PostShowNotifications(a.id),ButtonApp.HideButton(a),ButtonApp.HideDialog(a))})}catch(z){}},_Message_refresh:function(a){chrome.tabs.reload(a.id)},_ResetState:function(a){AutoApplyApp.CheckoutPageReady=!0;if(a||AutoApplyApp._CurrentCouponState!==AutoApplyApp._CouponState.TestingCoupon)AutoApplyApp._CurrentCouponState=AutoApplyApp._CouponState.Terminated,
setTimeout(function(){AutoApplyApp._CurrentCouponState===AutoApplyApp._CouponState.Terminated&&(AutoApplyApp._CurrentCouponState=AutoApplyApp._CouponState.PageLoad)},25E3)},ManualTestPrepareCoupons:function(a){var b=AutoApplyApp._CurrentCouponState===AutoApplyApp._CouponState.Terminated;AutoApplyApp._CurrentCouponState===AutoApplyApp._CouponState.PageLoad||b?browserAdapter.GetActiveTab(!0,function(a){var b=tabDataCollection._Get(a.id);b._AutoApplyActivity&&(b._AutoApplyActivity.applied=!0);AutoApplyApp._TestPrepareCoupons(a.id)}):
browserAdapter.ActivateTab(AutoApplyApp._activeTabs[0]);a()},_SendSuppressionMessage:function(a,b){var c=shoptoolbar._ApplicationSettings.CashbackLostSetting.EnabledForAll,d=shoptoolbar._ApplicationSettings.CashbackLostSetting.EnabledForRequireClick;if((c||d)&&a&&a._RetailerInfo){var e=a._RetailerInfo.RetailerID,f=a._GaveClick&&a._GaveClick===a._CurrentId;if(!c&&d&&!f&&(a._RetailerInfo._Rule&&"Standard"===a._RetailerInfo._Rule||!a._RetailerInfo._Rule&&(c=BfrlTool._RetailerList._GetRetailerById(e))&&
"Standard"===c.Rule))return;a._RetailerInfo.CashbackRate&&0!==a._RetailerInfo.CashbackRate.length&&(c="AutoApplyResources/report/cashbackIsDisabled.html?browserType="+(shoptoolbar.Browsers.Chrome==shoptoolbar.GetBrowser()?"Chrome":"NotChrome"),c+="&cashbackRate="+encodeURIComponent(a._RetailerInfo.CashbackRate),c+="&hasCoupons="+(0!=a._RetailerInfo.couponCount),c=c+("&retailerId="+e)+("&cashbackURL="+encodeURIComponent(shoptoolbar._GetRetailerRedirectURL(e,!1,!0))),c+="&toolbarType="+(shoptoolbar.GetIsBF()?
"1":"2"),a=shoptoolbar.Browsers.Chrome==shoptoolbar.GetBrowser()?400:370,browserAdapter._SendTabMessage(b,{targetScript:"autoApplyContent.js",action:"iframeSetURL",newURL:c,newWidth:420,newHeight:a,resize:!0,clearWrapper:!0,centered:!0},function(){}))}},_AutoApplyMessage:function(a,b,c){var d=!1,e=!1;if(a.targetScript&&"autoApplyApp.js"===a.targetScript)switch(e=!0,a.action){case "pageload":d=!0;AutoApplyApp._PageLoad(b.tab);c();break;case "setOriginalSubtotal":d=!0;AutoApplyApp._OriginalSubtotal=
a.data.newValue;c();break;case "isCancelled":d=!0;c(AutoApplyApp._CurrentCouponState===AutoApplyApp._CouponState.PageLoad||AutoApplyApp._CurrentCouponState===AutoApplyApp._CouponState.Terminated);break;case "OpenApplyCouponDialog":d=!0;AutoApplyApp._OpenApplyCouponDialog(b.tab.id);c();break;case "rememberMaxSavingsCoupon":d=!0;AutoApplyApp._Message_RememberMaxSavingsCoupon(a.data.code,a.data.discount);c();break;case "setCouponState":d=!0;AutoApplyApp._Message_SetCouponState(a);c();break;case "applyCouponBackground_testApplyCoupon":d=
!0;AutoApplyApp._Message_ApplyCouponBackgroundTestApply(b.tab.id);c();break;case "updateProgress":browserAdapter._SendTabMessage(b.tab.id,{targetScript:"couponsTesting.js",action:"iframeAdjustProgress",message:a.data.myMessage,applyBlackout:!0,centered:!0,newWidth:420,newHeight:320,resize:!0,clearWrapper:!1},function(){});break;case "maxCouponApplied":d=!0;AutoApplyApp._LatestCouponAppliedIndex=AutoApplyApp._MaxCouponIndex;c();break;case "latestCouponApplied":d=!0;AutoApplyApp._LatestCouponAppliedIndex=
AutoApplyApp._CurrentCouponIndex;c();break;case "iframeClose":d=!0;AutoApplyApp._Message_iframeClose(a,b.tab.id,c);break;case "iframeResize":d=!0;AutoApplyApp._Message_iframeResize(a,b.tab.id,c);break;case "refresh":AutoApplyApp._CurrentCouponState!==AutoApplyApp._CouponState.TestingCoupon&&AutoApplyApp._CurrentCouponState!==AutoApplyApp._CouponState.FinishedTestingCoupon||AutoApplyApp._Message_refresh(b.tab);break;case "testPrepareCoupons":d=!0;var f=AutoApplyApp._CurrentCouponState===AutoApplyApp._CouponState.Terminated;
if(AutoApplyApp._CurrentCouponState===AutoApplyApp._CouponState.PageLoad||f)f=tabDataCollection._Get(b.tab.id),f._AutoApplyActivity&&(f._AutoApplyActivity.applied=!0),AutoApplyApp._TestPrepareCoupons(b.tab.id);c();break;case "testIncrementCouponIndex":d=!0;AutoApplyApp._TestIncrementCouponIndex(a&&a.data&&a.data.isPost);c();break;case "testFinishedApplyingMaxSavings":d=!0;a.data.isValid?(f=tabDataCollection._Get(b.tab.id))&&f._RegexOverride&&f._RegexOverride.multipleCouponSupport?(f=!0,1<=a.data.appliedIndex&&
(f=a.data.discount>AutoApplyApp._SavingsCouponsAndValues[a.data.appliedIndex-1].value),f&&0<AutoApplyApp._SavingsCouponsAndValues.length?(AutoApplyApp._SavingsCouponsAndValues[a.data.appliedIndex].value=a.data.discount,AutoApplyApp._TestIncrementMaxSavingsIndex(!1)):(AutoApplyApp._SavingsCouponsAndValues.splice(a.data.appliedIndex,1),AutoApplyApp._TestIncrementMaxSavingsIndex(!0))):AutoApplyApp._CurrentCouponState=AutoApplyApp._CouponState.MaxSavingsApplied:(AutoApplyApp._SavingsCouponsAndValues.splice(a.data.appliedIndex,
1),AutoApplyApp._TestIncrementMaxSavingsIndex(!0));AutoApplyApp._PageLoad(b.tab);c();break;case "initialCouponFound":break;case "logCouponFailure":d=!0;f=AutoApplyApp._CurrentCouponState===AutoApplyApp._CouponState.PageLoad;var g=AutoApplyApp._CurrentCouponState===AutoApplyApp._CouponState.Terminated,h=AutoApplyApp.getPrimaryTabIdFromDuplicate(b.tab.id)||b.tab.id;if(!f&&!g&&a.data.reset){var m;shoptoolbar.LoadURI("https://"+shoptoolbar.Site+"/BefrugalSiteWS.asmx/ShowTermsForRetailerNoLinks?"+("retailerid="+
AutoApplyApp._retailerId),function(a){m=shoptoolbar.GetNodeTextContentFactory(a);cbTerms=m("/x:string");a="cashbackRate="+encodeURIComponent(tabDataCollection._Get(h)._RetailerInfo.CashbackRate)+"&RAFToken="+encodeURIComponent(BfrlTool.Prefs.RAFToken)+"&ToolbarType="+(shoptoolbar.GetIsBF()?"1":"2")+"&cbTerms="+encodeURIComponent(cbTerms);browserAdapter._SendTabMessage(h,{targetScript:"autoApplyContent.js",action:"iframeSetURL",newURL:"AutoApplyResources/inject/couponsNotFound.html?"+a,applyBlackout:!0,
centered:!0,newWidth:476,newHeight:476,resize:!0,clearWrapper:!0},function(){AutoApplyApp._ResetState(!0)})})}AutoApplyApp._Api_LogCouponFailure(a.data.retailerId,a.data.couponCode);c();break;case "sendFeedback":AutoApplyApp._Api_SendFeedbackEmail(a.data.email,a.data.body);break;case "openNewRateUsTab":shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Firefox&&shoptoolbar._IsButton?chrome.tabs.create({url:"https://addons.mozilla.org/en-US/firefox/addon/befrugal-automatic-coupons/"},function(){}):shoptoolbar.GetBrowser()===
shoptoolbar.Browsers.Chrome&&chrome.tabs.create({url:"https://chrome.google.com/webstore/detail/befrugal/"+chrome.runtime.id+"/reviews"},function(){});break;case "setRateUsFlag":BfrlTool.BrowserStorage.WebExtensionsRateUs=!0;BfrlTool.BrowserStorage.NoMoreInvites=!0;break;case "iframeReportSetURL":y(a,b.tab.id);break;case "RunResumeCheck":d=!0;f=tabDataCollection._Get(b.tab.id);if(!shoptoolbar._DISABLE_AUTO_APPLY_COUPONS){g=!shoptoolbar.getIsCashbackNewTab(b.tab.id);var k=AutoApplyApp.getPrimaryTabIdFromDuplicate(b.tab.id),
n=AutoApplyApp._CurrentCouponState===AutoApplyApp._CouponState.RemovedBackgroundCoupon;!g||!n&&k?k&&AutoApplyApp._TestValidMessages(k):(AutoApplyApp._PageLoad(b.tab),f._RegexOverride&&AutoApplyApp._OrderConfirmationTracking(f))}c();f._WasActivated&&!f._CashbackActivated&&f._CurrentId&&f._WasActivated===f._CurrentId.toString()&&(AutoApplyApp._SendSuppressionMessage(f,b.tab.id),delete f._WasActivated);f._RedirectCashbackNewTab||shoptoolbar._SetBadge(!0);break;case "dialogLoadPrefs":d=!0;shoptoolbar.GetCurrentABrowser(function(a){null!=
a&&null!=a._CurrentId?(a=AutoApplyApp._GetInjectedDialogPosition(a._CurrentId),c(a)):c(null)});break;case "dialogSavePrefs":d=!0;shoptoolbar.GetCurrentABrowser(function(b){if(null!=b&&null!=b._CurrentId){b=AutoApplyApp._GetInjectedDialogPosition(b._CurrentId);var d=a.data;d&&(b.top=d.top,b.left=d.left)}c()});break;case "contentTabClosed":d=!0;AutoApplyApp._CheckIfLostTab(b.tab.id);c();break;default:e=!1}return{usedResponse:d,handledMessage:e}},_Api_LogCouponFailure:function(a,b){BfrlTool.BrowserStorage.UserToken.then(function(c){var d=
"<coupons>{0}</coupons>",f="<SubmitCouponBlob>{0}{1}{2}{3}</SubmitCouponBlob>",g="<CouponCode>{0}</CouponCode>",h="<UserToken>{0}</UserToken>",m="<toolbarversion>{0}</toolbarversion>";var k=shoptoolbar.Format("<RetailerId>{0}</RetailerId>",a);g=shoptoolbar.Format(g,b);f=shoptoolbar.Format(f,k,g,"<InitialFailCount>0</InitialFailCount>","<CouponFailCount>0</CouponFailCount>");d=shoptoolbar.Format(d,f);h=shoptoolbar.Format(h,c);m=shoptoolbar.Format(m,shoptoolbar._ToolbarVersion);e.push(parseInt(a));
f=shoptoolbar.Format("https://{0}/toolbar/toolbarws/ws.asmx",shoptoolbar.Site);shoptoolbar._PostSoapURI(f,function(a){},"SendCoupons",d+c+m)})},_Api_SendFeedbackEmail:function(a,b){shoptoolbar._GetRetailerInfo(AutoApplyApp._retailerId,function(c){a&&0!==a.length||!BfrlTool.Prefs.UserName||(a=BfrlTool.Prefs.UserName);var d=shoptoolbar.GetBrowser();b="["+(c.RetailerInfo.RetailerName+" | "+(d===shoptoolbar.Browsers.Chrome?"Chrome":d===shoptoolbar.Browsers.Firefox?"FireFox":d===shoptoolbar.Browsers.Edge?
"Edge":"Unkown")+" | "+(shoptoolbar._IsBF?"BeFrugal-":"CouponViewer-")+chrome.runtime.getManifest().version)+"] "+b;c="<toolbarversion>{0}</toolbarversion>";d="<email>{0}</email>";var e="<clientversion>{0}</clientversion>";var f=shoptoolbar.Format("<body>{0}</body>",b);d=shoptoolbar.Format(d,a);c=shoptoolbar.Format(c,shoptoolbar._ToolbarVersion);e=shoptoolbar.Format(e,"AutoApplyApp_"+shoptoolbar._ToolbarVersion);var g=shoptoolbar.Format("https://{0}/toolbar/toolbarws/ws.asmx",shoptoolbar.Site);shoptoolbar._PostSoapURI(g,
function(a){},"SendFeedbackEmailWithClient",c+d+f+e)})},_Init:function(){},GetCouponCodesCount:function(){return AutoApplyApp._AllCouponCodes.length},getPrimaryTabIdFromDuplicate:function(a){var b=null;AutoApplyApp._activeDuplicateTabs.forEach(function(c,d){c==a&&(b=d)});return b},prematureDuplicateClosing:function(a){AutoApplyApp._CurrentCouponState!=c.FinishedTestingCoupon&&AutoApplyApp._Message_iframeClose({targetScript:"autoApplyApp.js",sourceScript:"shoptoolbar.js",data:{type:"7"}},a)},_OrderConfirmationTracking:function(a){var b=
a._CheckoutTrackingRegex?a._CheckoutTrackingRegex:null,c=a._ConfirmationURLRegex?a._ConfirmationURLRegex:null,d=a._CheckoutTrackingMaxPageCount+1;(b||c)&&browserAdapter.GetTab(a.TabId,function(e){if(b){var f=e.url.match(b)?d:(a._PagesSinceCheckout||1)-1;f&&(console.log("Step "+(d-f)+": "+e.url),a._PagesSinceCheckout=f)}else e.url.match(c)&&browserAdapter._SendTabMessage(e.id,{targetScript:"autoApplyContent.js",url:"google?",action:"sendPageInfo"},function(){chrome.runtime.lastError&&console.log(chrome.runtime.lastError)})})}}}(),
ShowCouponsApp=ShowCouponsApp||function(){return{IsShowingCoupons:!1,_AllCouponCodes:[],_AllCouponDescriptions:[],_AllPublicCodes:[],_OpenShowCouponsDialog:function(c){var a=tabDataCollection._Get(c);if(!a._RetailerInfo||!a._RetailerInfo.SuppressNotification){var b=AutoApplyApp._GetInjectedDialogPosition(a._CurrentId),e=function(a,b,c){b=a.indexOf(b)+b.length;return a.substring(b,a.indexOf(c))},g=function(a,b,c){for(var d=[];0<a.length;){var e=a.indexOf(b);if(0>e)break;e+=b.length;var f=a.indexOf(c,
e);if(0>f){d.push(a.substring(e,a.length));break}d.push(a.substring(e,f));a=a.substring(f+c.length,a.length)}return d};(function(a){0>a.indexOf("https")&&(a=a.replace("http","https"));return new Promise(function(b,c){var d=new XMLHttpRequest;d.addEventListener("load",function(a){b(d.responseText)});d.addEventListener("error",function(a){c("(autoApplyApp.js) XMLHttpRequest Error: "+d.statusText)});d.open("GET",a);d.send()})})(browserAdapter._GetURL("AutoApplyResources/inject/showCoupons.html")).then(function(d){var f=
e(d,"<head>","</head>"),h=e(d,"<body>","</body>");d=g(h,'src="','"');for(var m=browserAdapter._GetURL("AutoApplyResources/inject/"),n=0;n<d.length;n++)h=h.replace(d[n],function(a){return m+a});var r=browserAdapter._GetURL("scrollbar.css"),v=browserAdapter._GetURL("scrollbar.js");shoptoolbar._GetNoCashBackExtension(function(d){browserAdapter._SendTabMessage(c,{targetScript:"showCouponsContent.js",action:"draggableDivInsert",innerHTML:f+h,id:"bfrl_divShowCoupons",total:ShowCouponsApp._AllCouponCodes.length+
ShowCouponsApp._AllPublicCodes.length,couponCodes:ShowCouponsApp._AllCouponCodes,couponDescriptions:ShowCouponsApp._AllCouponDescriptions,publicCodes:ShowCouponsApp._AllPublicCodes,isAutoApplyCoupons:!1,retailerId:a._CurrentId,cashback:d?null:a._RetailerInfo.CashbackRate,newWidth:420,newHeight:340,newTop:b.top,newLeft:b.left,resize:!0,clearWrapper:!1,move:!0,isCouponViewer:!shoptoolbar._IsBF,scrollbarCSSURL:r,scrollbarJSURL:v,styleCss:chrome.runtime.getURL("/fonts/Roboto.css")},function(){shoptoolbar._IsButton&&
ButtonApp.HideDialog({id:c})})})}).catch(function(a){console.error(a)})}},_Message_iframeResize:function(c,a){var b=tabDataCollection._Get(a);b=AutoApplyApp._GetInjectedDialogPosition(b._CurrentId);browserAdapter._SendTabMessage(a,{targetScript:"showCouponsContent.js",action:"iframeResize",newWidth:c.newWidth,newHeight:c.newHeight,centered:c.bfrl_centered,newLeft:b.left,newTop:b.top,move:!0},function(){})},_Message_iframeClose:function(c,a){try{AutoApplyApp._ResetState(!1),browserAdapter._SendTabMessage(a,
{sourceScript:c.sourceScript,targetScript:"showCouponsContent.js",action:"iframeClose"},function(){})}catch(b){}},_Message_activateCashback:function(c,a){browserAdapter.GetActiveTab(!0,function(b){var e=tabDataCollection._Get(b.id);shoptoolbar._RedirectIFrame(shoptoolbar._GetRetailerRedirectURL(c.retailerId),b.id);shoptoolbar._IsButton&&(ButtonApp.HideButton(b),ButtonApp.HideDialog(b),shoptoolbar.RecordNotificationActivation(c.retailerId,e._CurrentRequest));e._CashbackActivated=!0;e._CashbackActivationChangedTime=
(new Date).getTime();shoptoolbar._WakeUpCouponBadge(e);a&&a()})},ManualShowCoupons:function(c){browserAdapter.GetActiveTab(!0,function(a){ShowCouponsApp._OpenShowCouponsDialog(a.id);c()})},_CheckShowURL:function(c,a){var b;if(b=AutoApplyApp._CheckParentURL(c,a))return b;a=a._RegexOverride;var e=[];if(a&&a.showCoupons&&a.showCoupons.showUrl&&a.showCoupons.showUrl.value){var g=a.showCoupons.showUrl.value?a.showCoupons.showUrl.value:"befrugal_none",d=function(a,b){var d=new RegExp(a,"i"),f=new RegExp(a.replace(/[^a-zA-Z0-9]/gi,
"\\$&"),"i"),g=!1,h=!1;try{g=a.match(c)}catch(t){g=!1}try{h=c.match(a)}catch(t){h=!1}a.length>=c.length&&(d.test(c)||f.test(c)||a.startsWith(c)||-1<a.indexOf(c)||g&&0<g.length)?e.push({uri:c,rule:a,index:b}):(d.test(c)||f.test(c)||c.startsWith(a)||-1<c.indexOf(a)||h&&0<h.length)&&e.push({uri:c,rule:a,index:b})};b=function(){var a=g.split(/(,\s)/gi);a=a.filter(function(a){return", "!==a});for(var b=0;b<a.length;b++)d(a[b],b)};switch(a.showCoupons.showUrl.key?a.showCoupons.showUrl.key:"befrugal_none"){case "[Disabled]":break;
case "[MultipleURLs]":b();break;default:d(g,0)}}return[].concat($jscomp.arrayFromIterable(new Set(e)))},_ShowCouponsMessage:function(c,a,b){var e=!1,g=!1;if(c.targetScript&&"showCouponsApp.js"===c.targetScript){g=!0;var d=c.data?c.data:c;switch(c.action){case "activateCashback":e=!0;ShowCouponsApp._Message_activateCashback(d);b();break;case "iframeClose":ShowCouponsApp._Message_iframeClose(d,a.tab.id);break;case "iframeResize":e=!0;ShowCouponsApp._Message_iframeResize(d,a.tab.id);b();break;case "fetchCoupons":e=
!0;b({couponCodes:ShowCouponsApp._AllCouponCodes,couponDescriptions:ShowCouponsApp._AllCouponDescriptions,publicCodes:ShowCouponsApp._AllPublicCodes});break;default:g=!1}}return{usedResponse:e,handledMessage:g}}}}(),isChrome=shoptoolbar.GetBrowser()==shoptoolbar.Browsers.Chrome,isEdge=shoptoolbar.GetBrowser()==shoptoolbar.Browsers.Edge;
function _sendDisablingMessage(c,a,b,e){var g=a?a:"",d=function(a){browserAdapter._SendTabMessage(a.id,{targetScript:"disableExtensionsContent.js",action:c,data:g},function(a){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message);b(a)})};a=function(a){if(a&&0<a.length)for(var b=0;b<a.length;b++)isChrome?0<=a[b].url.indexOf(chrome.runtime.id)&&0<=a[b].url.indexOf("disableExtensionsPage")&&d(a[b]):0<=a[b].url.indexOf("disableExtensionsPage")&&d(a[b])};b||(b=function(a){});e?d(e):
isChrome?chrome.tabs.query({},a):isEdge?browser.tabs.query({},a):browser.tabs.query({url:browser.extension.getURL("*")}).then(a)}function _requestPermission(c){isChrome?chrome.permissions.request({permissions:["management"]},c):c(!1)}function _getInstalledExtensions(c){isChrome?chrome.management.getAll(c):browser.management.getAll().then(c)}
function _removePermission(c){isChrome?chrome.permissions.remove({permissions:["management"]},c):browser.permissions.remove({permissions:["management"]}).then(c)}
function _getDisableExtensionsList(c,a){var b=function(a){return a.responseXML},e=function(a){return"(disableBackgroundApp.js) XMLHttp Error: "+request.statusText},g=function(a,b,c){a=0>a.indexOf("https")?a.replace("http","https"):a;return new Promise(function(d){var e=new XMLHttpRequest;try{e.addEventListener("load",function(){d(b(e))}),e.addEventListener("error",function(){d(c(e))}),e.open("GET",a),e.overrideMimeType("application/xml"),e.send()}catch(r){d(c(e))}})};(function(a,b){a.getFile("disable/disableList.xml",
{create:!1},function(){b(!0)},function(){b(!1)})})(c,function(c){c?g(chrome.runtime.getURL("disable/disableList.xml"),b,e).then(function(b){var c=[];b=shoptoolbar._GetNodeSnapShotFactory(b);var d=b('/x:Extensions/x:Browser/x:Ids[@type="adblock"]');if(d=d.snapshotItem(0)){d=d.getElementsByTagName("Id");for(var e=0;e<d.length;e++){var f=d[e].textContent;c.includes(f)||c.push(f)}}d=b('/x:Extensions/x:Browser/x:Ids[@type="cashback"]');if(d=d.snapshotItem(0))for(b=d.getElementsByTagName("Id"),d=0;d<b.length;d++)e=
b[d].textContent,c.includes(e)||c.push(e);BfrlTool.BrowserStorage.UserToken.then(function(b){var d=shoptoolbar.Format("https://{0}/wssimple.asmx/GetDisableAbleExtensions",shoptoolbar.Site.replace("www","tbwsjs"));shoptoolbar.FetchJson(d,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:shoptoolbar.Format("UserToken={0}&toolbarversion={1}",b,shoptoolbar.GetToolbarVersion())}).then(function(b){if(b)for(var d=0;d<b.length;d++)c.includes(b[d].ExtensionId)||c.push(b[d].ExtensionId);
a(c)})})}):console.error("(disableBackgroundApp.js) Missing extensions list.")})}
var DisableSystem=DisableSystem||function(){function c(a,b){for(var c=!1,g=0;g<a.length;g++)if(a[g].url===b){chrome.tabs.update(a[g].id,{active:!0});c=!0;break}c||(shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?chrome.tabs.create({url:b}):browser.tabs.create({url:b}));shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Chrome?chrome.extension.getViews({type:"popup"}).forEach(function(a){a.close()}):browser.extension.getViews({type:"popup"}).forEach(function(a){a.close()})}return{OpenSettingsPage:function(){if(shoptoolbar.GetBrowser()===
shoptoolbar.Browsers.Chrome){var a=chrome.extension.getURL("settingsPage.html");chrome.tabs.query({},function(b){c(b,a)})}else{var b=browser.extension.getURL("settingsPage.html");browser.tabs.query({},function(a){c(a,b)})}},OpenDialog:function(a,b){b?isChrome?chrome.tabs.query({windowType:"normal"},function(a){for(var b=!1,c=0;a&&c<a.length;c++)if(-1<a[c].url.indexOf(chrome.runtime.id)&&/disableExtensionsPage/gi.test(a[c].url)){chrome.tabs.update(a[c].id,{active:!0});b=!0;break}b||chrome.tabs.create({url:chrome.runtime.getURL("disableExtensionsPage.html")})}):
browser.tabs.query({windowType:"normal"}).then(function(a){for(var b=!1,c=0;a&&c<a.length;c++)if(-1<a[c].url.indexOf("extension://")&&/disableExtensionsPage/gi.test(a[c].url)){b=!0;browser.tabs.update(a[c].id,{active:!0});break}b||browser.tabs.create({url:browser.runtime.getURL("disableExtensionsPage.html")})}):_sendDisablingMessage("createDisablePopup",a)},CloseDialog:function(){_sendDisablingMessage("closeDisableDialog")},_UninstallExtension:function(a,b){b||(b=function(a){});_requestPermission(function(c){c?
chrome.management.uninstall(a.id,{showConfirmDialog:!0},function(){chrome.runtime.lastError?0<chrome.runtime.lastError.message.indexOf("cancel")?b(null):b(a):chrome.management.get(a.id,function(c){chrome.runtime.lastError?b(a):b(null)})}):b(null)})},_GetAllExtensions:function(a){_requestPermission(function(b){if(b){var c=function(b){_getInstalledExtensions(function(c){BfrlTool.BrowserStorage.UserToken.then(function(a){a=shoptoolbar.Format("extensions={0}&UserToken={1}&toolbarversion={2}",JSON.stringify(c.map(function(a){return{id:a.id,
name:encodeURIComponent(a.name),description:encodeURIComponent(a.description),version:encodeURIComponent(a.version)}})),a,shoptoolbar._ToolbarVersion);shoptoolbar._LoadURI_JSON_POST("https://tbwsjs.befrugal.com/wssimple.asmx/UserExtensionsUpsert",a,function(){})});var d=[],e;for(e in c){var g=c[e],n;if(n=b.includes(g.id))n=g.enabled?!1:!0,n=!n;n&&d.push(g)}if(0<d.length){var r=function(a,b){chrome.management.setEnabled(a.id,!1,function(){b()})};d.reduce(function(a,b){return a.then(function(){return new Promise(function(a){r(b,
a)})})},Promise.resolve()).then(function(){a(d)})}else a([])})};shoptoolbar.GetBrowser()==shoptoolbar.Browsers.Chrome?chrome.runtime.getPackageDirectoryEntry(function(a){_getDisableExtensionsList(a,c)}):browser.runtime.getPackageDirectoryEntry(function(a){_getDisableExtensionsList(a,c)})}})},OpenExtensionsPage:function(){chrome.tabs.create({url:"chrome://extensions"})},OpenCashbackStoresTab:function(a){chrome.tabs.create({url:"https://"+shoptoolbar.Site+"/coupons/stores/a/cashback"})},_RemoveManagementPermission:function(){_removePermission(function(a){sendResponse(returnValue)})},
_PopupWorkaround:function(a){DisableSystem._GetAllExtensions(function(a){if(Array.isArray(a)&&0<a.length){var b=JSON.stringify(a);b=encodeURIComponent(b);iframeDeets={newURL:"disable/disable_page2.html?q="+b+"&localparent=0",newWidth:400,newHeight:600,results:a}}else iframeDeets={newWidth:400,newHeight:235,newURL:"disable/disable_page3.html?localparent=0"};var c=function(a){browserAdapter._SendTabMessage(a,{targetScript:"disableExtensionsContent.js",action:"createDisablePopup",data:iframeDeets},function(a){chrome.runtime.lastError&&
console.warn(chrome.runtime.lastError.message)})};chrome.tabs.query({windowType:"normal"},function(a){for(var b=!1,d={$jscomp$loop$prop$i$45:0};a&&d.$jscomp$loop$prop$i$45<a.length;d={$jscomp$loop$prop$i$45:d.$jscomp$loop$prop$i$45},d.$jscomp$loop$prop$i$45++)if(-1<a[d.$jscomp$loop$prop$i$45].url.indexOf(chrome.runtime.id)&&/disableExtensionsPage/gi.test(a[d.$jscomp$loop$prop$i$45].url)){chrome.tabs.update(a[d.$jscomp$loop$prop$i$45].id,{active:!0},function(b){return function(){c(a[b.$jscomp$loop$prop$i$45].id)}}(d));
b=!0;break}b||(shoptoolbar.disablePageDataPoint=iframeDeets);chrome.tabs.create({url:chrome.runtime.getURL("disableExtensionsPage.html")})});BfrlTool.BrowserStorage.ConflictAlert=!1})},_DisableExtensionsMessage:function(a,b,c){var e=b=!1;if(a.targetScript&&"disableBackgroundApp.js"===a.targetScript)switch(e=!0,a.action){case "uninstall":b=!0;DisableSystem._UninstallExtension(a.data.extension,function(a){c(a)});break;case "getAllExtensions":b=!0;DisableSystem._GetAllExtensions(function(a){c(a)});break;
case "popupWorkaround":b=!0;DisableSystem._PopupWorkaround(function(a){});break;case "openSettingsPage":DisableSystem.OpenSettingsPage();break;case "showPrivacyPrompt":b=!0;var d=BfrlTool.Prefs.PrivacyDeclinedDate;BfrlTool.BrowserStorage.PrivacyPrompt.then(function(a){BfrlTool.BrowserStorage.NoCashBackExtension.then(function(b){if(shoptoolbar.Config.PrivacyPrompt.CounterEnabled&&a&&d&&0<d.length){var e=Date.now(),f=864E5*shoptoolbar.Config.PrivacyPrompt.Days;c({Show:!b&&1<=(e-d)/f,NoCashBack:b,Enabled:!0})}else c({Show:!b&&
a,NoCashBack:b,Enabled:shoptoolbar.Config.PrivacyPrompt.CounterEnabled,UpdateRequired:shoptoolbar.Config.UpdateRequired,UpdateUrl:shoptoolbar.Config.UpdateUrl})})});break;case "privacyAccepted":b=!0;BfrlTool.BrowserStorage.PrivacyPrompt=!1;shoptoolbar._GetAccount().then(function(){shoptoolbar._NotifyInstall();c(!0)});break;case "privacyDeclined":BfrlTool.Prefs.PrivacyDeclinedDate=Date.now();break;default:b=!0,e=!1,c(!1)}return{usedResponse:b,handledMessage:e}}}}(),SettingsApp=function(){function c(a,
b){a||(a=function(){});b||(b=function(){});shoptoolbar._Browser==shoptoolbar.Browsers.Chrome?chrome.tabs.query({},function(c){chrome.runtime.lastError?(b(chrome.runtime.lastError),a(null)):a(c)}):shoptoolbar._Browser==shoptoolbar.Browsers.Edge?browser.tabs.query({},function(c){browser.runtime.lastError?(b(chrome.runtime.lastError),a(null)):a(c)}):browser.tabs.query({}).then(function(b){a(b)}).catch(function(a){b(a)})}return{_Message_iframeClose:function(a,b){try{c(function(a){(a=a.filter(function(a){return a&&
a.url&&-1<a.url.indexOf(chrome.runtime.id)&&-1<a.url.indexOf("settingsPage")}))&&0<a.length&&chrome.tabs.remove(a[0].id,function(){})})}catch(e){}},SettingsMessage:function(a,b){if(a.targetScript&&"settingsApp.js"===a.targetScript){switch(a.action){case "iframeClose":SettingsApp._Message_iframeClose(a,b.tab.id);break;default:return!1}return!0}return null}}}(),ButtonApp=ButtonApp||function(){return{_ButtonDialogStorage:{},_InitializeButtonDialogStorage:function(c){ButtonApp._ButtonDialogStorage[c]=
{};ButtonApp._ButtonDialogStorage[c].button={};ButtonApp._ButtonDialogStorage[c].button.position={};ButtonApp._ButtonDialogStorage[c].button.position.XhasPX=!1;ButtonApp._ButtonDialogStorage[c].button.position.YhasPX=!1;ButtonApp._ButtonDialogStorage[c].button.position.x=0;ButtonApp._ButtonDialogStorage[c].button.position.y=62;ButtonApp._ButtonDialogStorage[c].dialog={};ButtonApp._ButtonDialogStorage[c].dialog.position={};ButtonApp._ButtonDialogStorage[c].dialog.position.firstTime=!0;ButtonApp._ButtonDialogStorage[c].dialog.position.XhasPX=
!1;ButtonApp._ButtonDialogStorage[c].dialog.position.YhasPX=!1;ButtonApp._ButtonDialogStorage[c].dialog.position.right=30;ButtonApp._ButtonDialogStorage[c].dialog.position.x="auto";ButtonApp._ButtonDialogStorage[c].dialog.position.y=62;ButtonApp._ButtonDialogStorage[c].dialog.show=!0;return ButtonApp._ButtonDialogStorage[c]},_GetButtonStorage:function(c){return ButtonApp._ButtonDialogStorage[c]?ButtonApp._ButtonDialogStorage[c]:null},_ButtonMessages:function(c,a,b){var e=a=!1;if(!c||c&&!c.targetScript||
c&&c.targetScript&&"buttonApp.js"!==c.targetScript)return null;if(c&&c.action)switch(e=!0,c.action){case "buttonLoadPrefs":a=!1;shoptoolbar.GetIsButton()&&(a=!0,browserAdapter.GetActiveTab(!0,function(a){var c=tabDataCollection._Get(a.id);a=0<tabDataCollection._TabData.filter(function(a){return a&&a._CashbackActivated&&a._CurrentId===c._CurrentId}).length;if(c._RetailerInfo&&c._RetailerInfo.CashbackRate&&!c._CashbackActivated&&!a){(a=ButtonApp._GetButtonStorage(c._CurrentId))||(a=ButtonApp._InitializeButtonDialogStorage(c._CurrentId));
a=a.button.position;if(!a||"{}"===a||a.length&&0>=a.length)a="";b(a)}else b(null)}));break;case "buttonStorePrefs":shoptoolbar.GetIsButton()&&shoptoolbar.GetCurrentABrowser(function(a){if(null!=a){var b=ButtonApp._GetButtonStorage(a._CurrentId);b||(b=ButtonApp._InitializeButtonDialogStorage(a._CurrentId));b.button.position=c.position;b.dialog.position.y=b.button.position.y}});break;case "dialogLoadPrefs":a=!1;shoptoolbar.GetIsButton()&&(a=!0,shoptoolbar.GetCurrentABrowser(function(a){if(null!=a){var c=
ButtonApp._GetButtonStorage(a._CurrentId);c||(c=ButtonApp._InitializeButtonDialogStorage(a._CurrentId));a=c.dialog.position;if(!a||"{}"===a||a.length&&0>=a.length)a="";b(a)}}));break;case "dialogStorePrefs":a=!1;shoptoolbar.GetIsButton()&&shoptoolbar.GetCurrentABrowser(function(a){if(null!=a){var b=ButtonApp._GetButtonStorage(a._CurrentId);b||(b=ButtonApp._InitializeButtonDialogStorage(a._CurrentId));b.dialog.position=c.position;b.button.position.y=b.dialog.position.y}});break;case "buttonShowDialog":browserAdapter.GetActiveTab(!0,
function(a){if(null!=a){var b=tabDataCollection._Get(a.id);shoptoolbar.GetIsButton()&&!b._CashbackActivated&&null!=b._CurrentId&&shoptoolbar.ShowNotification(a.id,b._CurrentId,shoptoolbar._NotifyState._AskClick,null,null,!0)}});break;case "getReferralLinks":a=!0;shoptoolbar.GetReferralLinks(function(a){b(a)});break;default:e=!1}return{usedResponse:a,handledMessage:e}},HideDialog:function(c){var a="";a=shoptoolbar._IsButton?'{\n\tlet div = document.querySelector("#BFRLsliderIframe #notification-body");\n\tlet isEdge = '+
(shoptoolbar.GetBrowser()===shoptoolbar.Browsers.Edge).toString()+';\n\tif (div) {\n\t\tif (div.classList.contains("flyIn")) {\n\t\t\tdiv.classList.remove("flyIn");\n\t\t}\n\t\tdiv.classList.add("flyOut");\n\t}\n\tif (div && isEdge) {\n\t\tdiv.style.display = "none";\n\t}\n}\nundefined;':'var $iframe = $("#BFRLsliderIframe");var $div = $("#BFRLsliderDiv");$iframe.slideUp(200, function () { $(this).remove();\t});$div.slideUp(200, function () { $(this).remove(); });';browserAdapter._ExecuteScriptCode(c.id,
a,function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message)})},HideButton:function(c){shoptoolbar._IsButton&&browserAdapter._ExecuteScriptCode(c.id,'{\n\tif (typeof Button !== "undefined") {\n\t\tif (Button.buttonElement) {\n\t\t\tButton.buttonElement.classList.add("button_collapse");\n\t\t\tButton.buttonDisableMove = true;\n\t\t\tButton.buttonMouseMove = false;\n\t\t}\n\t}\n}\nundefined;',function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message)})},
ShowButton:function(c,a){shoptoolbar._IsButton&&ButtonApp.IsDialogVisible().then(function(b){b||browserAdapter._SendTabMessage(c.id,{action:"buttonShow",targetScript:"button.js",newPosition:a})})},ShowNotification:function(c,a){ButtonApp.IsDialogVisible().then(function(b){b||shoptoolbar.ShowNotification(c.id,a._CurrentId,shoptoolbar._NotifyState._AskClick,null,null,!0)})},IsDialogVisible:function(){return(new Promise(function(c,a){browserAdapter.GetActiveTab(!0,function(b){browserAdapter._ExecuteScriptCode(b.id,
'{\n\tlet bfnotify = document.querySelector("#notification-body");\n\tlet couponsFoundDialog = document.getElementById("befrugal_frame");\n\tlet insertedCouponsFoundDiv = document.querySelector("#bfrl_divCouponsFound");\n\tlet insertedShowCouponsDiv = document.querySelector("#bfrl_divShowCoupons");\n\t((bfnotify && bfnotify.classList.contains("flyIn")) || couponsFoundDialog || insertedCouponsFoundDiv || insertedShowCouponsDiv);\n}',function(b){b=b&&b[0]?b[0]:null;shoptoolbar._Browser===shoptoolbar.Browsers.Chrome?
chrome.runtime.lastError?a(chrome.runtime.lastError.message):c(b):browser.runtime.lastError?a(browser.runtime.lastError.message):c(b)})})})).catch(function(c){console.debug("(debug buttonApp) isDialogVisible() - ",c)})},InitButton:function(c,a){if(shoptoolbar._IsButton)if(shoptoolbar._IsRetailerOnHideNotificationsList(a._CurrentId)||a._CashbackActivated||a._RetailerInfo&&!a._RetailerInfo.CashbackRate||shoptoolbar._IsOnNotifyBlacklist(c.url))ButtonApp.HideDialog(c),ButtonApp.HideButton(c);else{var b=
ButtonApp._GetButtonStorage(a._CurrentId);b||(b=ButtonApp._InitializeButtonDialogStorage(a._CurrentId));b.dialog.show?ButtonApp.ShowNotification(c,a):shoptoolbar._Animation._PlayAnimation(3)}},AnonymousClickout:function(c,a){return c+(a?"&nocook=true":"")},ActivateCashback:function(c,a){browserAdapter.GetActiveTab(!0,function(b){var e=tabDataCollection._Get(b.id);shoptoolbar._RedirectIFrame(shoptoolbar._GetRetailerRedirectURL(c),b.id,!0);shoptoolbar._IsButton?(ButtonApp.HideButton(b),ButtonApp.HideDialog(b),
shoptoolbar.RecordNotificationActivation(c,e._CurrentRequest)):ButtonApp.HideDialog(b);e._CashbackActivated=!0;e._CashbackActivationChangedTime=(new Date).getTime();shoptoolbar._WakeUpCouponBadge(e);b=tabDataCollection._TabData.filter(function(a){return a._CurrentId&&a._CurrentId.toString()===c.toString()});for(e=0;e<b.length;e++)b[e]._CashbackActivated=!0,b[e]._CashbackActivationChangedTime=(new Date).getTime();a&&a()})},HideNotifyBar:function(c){shoptoolbar._IsButton&&browserAdapter._ExecuteScriptCode(c.id,
"if (typeof $ !== 'undefined'){ if ($('#BFRLsliderIframe') && $('#BFRLsliderIframe').length > 0) $('#BFRLsliderIframe').notifybar('hideTimeout'); }",function(){chrome.runtime.lastError&&console.debug(chrome.runtime.lastError.message)})},FadeAwayNotifyBar:function(c){shoptoolbar._IsButton&&browserAdapter._ExecuteScriptCode(c.id,"if (typeof $ !== 'undefined'){ if ($('#BFRLsliderIframe') && $('#BFRLsliderIframe').length > 0) $('#BFRLsliderIframe').notifybar('hidePopup'); }",function(){chrome.runtime.lastError&&
console.debug(chrome.runtime.lastError.message)})},Logout:function(c){shoptoolbar._LoadURI_JSON_GET(shoptoolbar.Format("https://{0}/toolbar/toolbarws/ws.asmx/LogoutUser",shoptoolbar.Site),function(a){c()})}}}();BfrlTool=BfrlTool||{};
BfrlTool._RetailerList=function(){var c=[],a=[],b=new Map,e=new Map,g=[],d=[];return{Failures:d,RetailerMap:b,DigestReport:function(){for(var a=0,b=[],e=function(){var a=b.join(",");BfrlTool.BrowserStorage.UserToken.then(function(b){shoptoolbar.FetchJson("https://tbwsjs.befrugal.com/wssimple.asmx/GetBatchedRetailerInfo",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:shoptoolbar.Format("retailerids={0}&UserToken={1}&toolbarversion={2}",a,b,shoptoolbar.GetToolbarVersion())}).then(function(b){for(var c=
0;c<b.length;c++)if(b[c]&&b[c].RetailerID){var e=b[c].RetailerID,f=BfrlTool._RetailerList._GetRetailerById(e);f?console.log(e+","+f.Domain+","+f.Rule+","+!!b[c].CashbackRate):d.push(e)}else console.error("ERROR in string - ",a)})});b=[]};a<c.length;)b.push(c[a]),0===a%100&&0<a&&e(),a++;0<b.length&&e()},_AddRetailer:function(a,d,e){c.push(e);b.has(a)?d&&d.URL&&(e=b.get(a),Array.isArray(e)||(e.URL||(e.URL=e.Domain),e=[e]),e.push(Object.assign({},d)),d.URL=d.URL.replace(/https?:\/\//i,""),e.push(d),
e.sort(function(a,b){return a.URL.length-b.URL.length||a.URL.localeCompare(b.URL)}),b.set(a,e)):("URL"in d&&(e=[Object.assign({},d)],d.URL=d.URL.replace(/https?:\/\//i,""),e.push(d),d=e),b.set(a,d))},_GetRetailer:function(a){var c=b.get(a);return null!=c?c:BfrlTool._RetailerList._GetRestaurant(a)},_GetRetailerById:function(a){var c=[].concat($jscomp.arrayFromIterable(b.entries())).filter(function(b){if(Array.isArray(b[1])){for(var c=0;c<b[1].length;c++)if(b[1][c].RetailerID===a)return!0;return!1}return b[1].RetailerID==
a});if(c)if(c[0]&&c[0][1])if(Array.isArray(c[0][1]))for(var d=0;d<c[0][1].length;d++){if(c[0][1][d].RetailerID===a)return c[0][1][d]}else return c[0][1];else return null;else return null},_AddRestaurant:function(b,c,d){a.push(d);e.set(b,c)},_GetRestaurant:function(a){a=e.get(a);return null!=a?a:null},_IsEmpty:function(){return 0===b.size},_MapRetailerList:function(a){c=[];b.clear();for(var d=0;d<a.length;d++)BfrlTool._RetailerList._AddRetailer(a[d].Domain,a[d],a[d].RetailerID)},_MapRestaurantList:function(b){a=
[];e.clear();for(var c=0;c<b.length;c++)BfrlTool._RetailerList._AddRestaurant(b[c].Domain,b[c],b[c].RetailerID)},_MapSearchInjectionBlackList:function(a){g=a},_IsSearchInjectBlacklisted:function(a){return 0<=g.indexOf(a)},_Retailers:b,_Restaurants:e,_ContainsRetailer:function(a){return 0<=c.indexOf(a)},_ContainsRestaurant:function(b){return 0<=a.indexOf(b)}}}();
